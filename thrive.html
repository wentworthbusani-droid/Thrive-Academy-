<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thrive Academy | Learn Smarter</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    
   /* ========== THEME TOGGLE BUTTON ========== */
.theme-toggle-btn {
  background: transparent;
  border: 2px solid #4f46e5;
  color: #4f46e5;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.3s ease;
  margin-left: 10px;
  z-index: 1001;
}

.theme-toggle-btn:hover {
  background: #4f46e5;
  color: white;
  transform: rotate(30deg);
}

.theme-toggle-btn i {
  transition: transform 0.3s ease;
}

/* Dark mode icon adjustments */
body.dark-mode .theme-toggle-btn {
  border-color: #fbbf24;
  color: #fbbf24;
}

body.dark-mode .theme-toggle-btn:hover {
  background: #fbbf24;
  color: #1f2937;
}

/* ========== DARK MODE STYLES ========== */
body.dark-mode {
  background: #111827;
  color: #f3f4f6;
}

/* Dark mode header and nav */
body.dark-mode nav {
  background: #1f2937;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

body.dark-mode .nav-links a {
  color: #e5e7eb;
}

body.dark-mode .nav-links a:hover {
  color: #fbbf24;
}

/* Dark mode cards */
body.dark-mode .card,
body.dark-mode .course-card,
body.dark-mode .feature-card,
body.dark-mode .stat-card,
body.dark-mode .user-info,
body.dark-mode .admin-panel,
body.dark-mode .payment-section,
body.dark-mode .form-container,
body.dark-mode .enrollment-form,
body.dark-mode .add-material-form {
  background: #1f2937;
  color: #f3f4f6;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

body.dark-mode .card h3,
body.dark-mode .course-header h3,
body.dark-mode .feature-card h3 {
  color: #fbbf24;
}

body.dark-mode .section-title {
  color: #f3f4f6;
}

body.dark-mode .course-header {
  background: linear-gradient(135deg, #7c3aed, #8b5cf6);
}

body.dark-mode .course-teacher {
  color: #93c5fd;
}

body.dark-mode .year-btn {
  background: #374151;
  color: #e5e7eb;
}

body.dark-mode .year-btn:hover {
  background: #4b5563;
}

body.dark-mode .year-btn.active {
  background: #7c3aed;
  color: white;
}

/* Dark mode forms */
body.dark-mode .form-group input,
body.dark-mode .form-group select,
body.dark-mode .form-group textarea {
  background: #374151;
  border-color: #4b5563;
  color: #f3f4f6;
}

body.dark-mode .form-group input:focus,
body.dark-mode .form-group select:focus,
body.dark-mode .form-group textarea:focus {
  border-color: #fbbf24;
  box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
}

body.dark-mode .form-group label {
  color: #e5e7eb;
}

/* Dark mode buttons */
body.dark-mode .btn {
  background: #7c3aed;
  color: white;
}

body.dark-mode .btn:hover {
  background: #6d28d9;
}

body.dark-mode .btn-secondary {
  background: #6b7280;
}

body.dark-mode .btn-secondary:hover {
  background: #4b5563;
}

body.dark-mode .btn-success {
  background: #059669;
}

body.dark-mode .btn-success:hover {
  background: #047857;
}

body.dark-mode .btn-danger {
  background: #dc2626;
}

body.dark-mode .btn-danger:hover {
  background: #b91c1c;
}

body.dark-mode .btn-warning {
  background: #d97706;
}

body.dark-mode .btn-warning:hover {
  background: #b45309;
}

/* Dark mode lists and materials */
body.dark-mode .materials-list li {
  border-bottom-color: #374151;
}

body.dark-mode .enrollment-option {
  background: #374151;
  border-color: #4b5563;
  color: #e5e7eb;
}

body.dark-mode .enrollment-option:hover {
  border-color: #fbbf24;
  background: #4b5563;
}

body.dark-mode .enrollment-option.selected {
  border-color: #fbbf24;
  background: #4338ca;
}

/* Dark mode hero section */
body.dark-mode .hero-section {
  background: linear-gradient(135deg, #3730a3, #4f46e5);
}

/* Dark mode features section */
body.dark-mode .features-section {
  background: #1f2937;
}

/* Dark mode CTA section */
body.dark-mode .cta {
  background: #030712;
  color: #e5e7eb;
}

/* Dark mode footer */
body.dark-mode footer {
  background: #030712;
  color: #9ca3af;
}

/* Dark mode material items */
body.dark-mode .material-item {
  background: #1f2937;
  border-color: #374151;
}

body.dark-mode .material-item:hover {
  border-color: #fbbf24;
}

/* Dark mode modules */
body.dark-mode .module-checkbox {
  background: #374151;
  border-color: #4b5563;
  color: #e5e7eb;
}

body.dark-mode .module-checkbox:hover {
  border-color: #fbbf24;
  background: #4b5563;
}

/* Dark mode teacher modules */
body.dark-mode .teacher-module-option {
  background: #374151;
  border-color: #4b5563;
  color: #e5e7eb;
}

body.dark-mode .teacher-module-option:hover {
  border-color: #fbbf24;
  background: #4b5563;
}

body.dark-mode .teacher-module-option.selected {
  border-color: #fbbf24;
  background: #4338ca;
}

/* Dark mode payment instructions */
body.dark-mode .payment-instructions {
  background: #78350f;
  color: #fef3c7;
}

/* Dark mode mode switcher */
body.dark-mode .mode-switcher {
  background: #1f2937;
  border-color: #374151;
}

/* Dark mode dev indicator */
body.dark-mode .dev-mode-indicator {
  background: linear-gradient(90deg, #991b1b, #92400e);
}

/* Dark mode modal overlay */
body.dark-mode .modal-overlay {
  background: rgba(0,0,0,0.7);
}

/* Responsive adjustments for theme toggle */
@media (max-width: 768px) {
  .theme-toggle-btn {
    position: relative;
    top: 0;
    right: 0;
    width: 35px;
    height: 35px;
    font-size: 1rem;
    margin: 10px 0;
  }
  
  body.dark-mode .nav-links {
    background: #1f2937;
  }
  
  .nav-links .theme-toggle-btn {
    display: flex !important;
    margin: 10px 0;
    width: 100%;
    height: 45px;
    border-radius: 6px;
    justify-content: center;
    position: static;
  }
}
    /* Dev Mode Indicator */
    .dev-mode-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #ff6b6b, #ff8e53);
      color: white;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      z-index: 9999;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    /* Force grid layout for courses */
#courses-container {
  display: grid !important;
  visibility: visible !important;
  opacity: 1 !important;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
  gap: 25px !important;
}

/* Ensure course cards are visible */
.course-card {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}
    /* Back to admin button */
.back-to-admin-btn {
  background: #ff6b6b;
  color: white;
  padding: 8px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  margin-top: 10px;
  display: inline-block;
}

.back-to-admin-btn:hover {
  background: #ff5252;
  transform: translateY(-2px);
}
    .dev-mode-indicator span {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    /* Mode Switcher */
    .mode-switcher {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .mode-btn {
      padding: 8px 15px;
      border: 2px solid #4f46e5;
      background: white;
      color: #4f46e5;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .mode-btn:hover {
      background: #4f46e5;
      color: white;
    }
    
    .mode-btn.active {
      background: #4f46e5;
      color: white;
    }
    
    .dev-tag {
      display: inline-block;
      background: #ff6b6b;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 5px;
      vertical-align: middle;
    }
    
    /* Rest of the CSS remains the same as in your original code */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: #f4f6fb; color: #222; }

    /* Home Page Hero Section */
    .hero-section {
      text-align: center;
      padding: 100px 5% 60px;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
    }
    
    .hero-section h1 { 
      font-size: 2.8rem; 
      margin-bottom: 15px;
      line-height: 1.2;
    }
    
    .hero-section p { 
      font-size: 1.2rem; 
      margin-bottom: 30px;
      opacity: 0.9;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .hero-cta {
      margin-top: 30px;
    }
    
    .hero-cta .btn {
      padding: 15px 35px;
      font-size: 1.1rem;
      margin: 0 10px;
    }
    
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 40px 5%;
      padding: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 25px 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 2.2rem;
      color: #4f46e5;
      margin-bottom: 10px;
    }
    
    .stat-card p {
      color: #6b7280;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    .features-section {
      padding: 60px 5%;
      background: #f8fafc;
    }
    
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 40px;
    }
    
    .feature-card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .feature-icon {
      font-size: 2.5rem;
      color: #4f46e5;
      margin-bottom: 20px;
    }
    
    .feature-card h3 {
      margin-bottom: 15px;
      color: #1f2937;
    }
    
    .feature-card p {
      color: #6b7280;
      line-height: 1.6;
    }

    header {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      padding: 120px 5% 60px;
      text-align: center;
    }

    header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    header p { font-size: 1.1rem; opacity: 0.9; }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 5%;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .nav-links {
      display: flex;
      align-items: center;
    }

    nav a {
      text-decoration: none;
      margin-left: 20px;
      color: #333;
      font-weight: 500;
      transition: color 0.3s;
      cursor: pointer;
    }

    nav a:hover {
      color: #4f46e5;
    }

    .btn {
      background: #4f46e5;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.3s;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      display: inline-block;
    }

    .btn:hover {
      background: #4338ca;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-success {
      background: #10b981;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-warning {
      background: #f59e0b;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .hamburger {
      display: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: #4f46e5;
    }

    section {
      padding: 60px 5%;
    }

    .section-title {
      text-align: center;
      margin-bottom: 40px;
      color: #1f2937;
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h3 { margin-bottom: 10px; color: #4f46e5; }

    /* Courses Section */
    .year-navigation {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .year-btn {
      padding: 12px 25px;
      background: #e5e7eb;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .year-btn:hover {
      background: #d1d5db;
    }

    .year-btn.active {
      background: #4f46e5;
      color: white;
    }

    .courses-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .course-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: all 0.3s;
      position: relative;
    }

    .course-card:hover {
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }

    .course-header {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      padding: 20px;
    }

    .course-header h3 {
      margin: 0;
      font-size: 1.4rem;
    }

    .course-header p {
      opacity: 0.9;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .course-price {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.9);
      color: #10b981;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .course-body {
      padding: 20px;
    }

    .course-body p {
      color: #6b7280;
      margin-bottom: 15px;
    }

    .course-teacher {
      font-size: 0.9rem;
      color: #4f46e5;
      font-weight: 500;
      margin-bottom: 15px;
    }

    .materials-list {
      list-style: none;
      margin: 15px 0;
    }

    .materials-list li {
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .material-actions {
      display: flex;
      gap: 10px;
    }

    .material-btn {
      padding: 5px 10px;
      background: #f3f4f6;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.3s;
    }

    .material-btn:hover {
      background: #e5e7eb;
    }

    .add-material-form {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #e5e7eb;
    }

    .hidden {
      display: none !important;
    }

    /* Dashboard */
    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    .user-info {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .role-badge {
      display: inline-block;
      padding: 5px 12px;
      background: #4f46e5;
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-left: 10px;
    }

    .teacher-courses {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }

    .year-badge {
      display: inline-block;
      padding: 3px 8px;
      background: #10b981;
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 5px;
    }

    /* Payment Section */
    .payment-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-top: 30px;
    }

    .selected-courses {
      margin: 20px 0;
    }

    .selected-course-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f9fafb;
      margin-bottom: 10px;
      border-radius: 6px;
    }

    .total-amount {
      font-size: 1.2rem;
      font-weight: 600;
      color: #10b981;
      text-align: right;
      margin: 20px 0;
      padding: 15px;
      background: #f0f9ff;
      border-radius: 6px;
    }

    .payment-instructions {
      background: #fef3c7;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
    }

    .cta {
      background: #111827;
      color: white;
      text-align: center;
      padding: 60px 5%;
    }

    /* Admin Panel */
    .admin-panel {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      margin-top: 30px;
    }

    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .student-list {
      margin-top: 20px;
    }

    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #f3f4f6;
    }

    .enrollment-form {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .enrollment-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .enrollment-option {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }

    .enrollment-option:hover {
      border-color: #4f46e5;
      background: #f8fafc;
    }

    .enrollment-option.selected {
      border-color: #4f46e5;
      background: #f0f9ff;
    }

    footer {
      background: #0f172a;
      color: #9ca3af;
      text-align: center;
      padding: 20px;
    }

    /* Form Styling */
    .form-container {
      display: none;
      max-width: 500px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    .form-container.active {
      display: block;
    }

    .form-box h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #4f46e5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 1rem;
      transition: border 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .error-input {
      border-color: #ef4444 !important;
    }

    .success-message {
      background: #10b981;
      color: white;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .form-switch {
      text-align: center;
      margin-top: 20px;
    }

    .form-switch a {
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
    }

    .form-switch a:hover {
      text-decoration: underline;
    }

    .password-toggle {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 15px;
      top: 42px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* Module Selection in Registration */
    .modules-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 15px;
      background: #f9fafb;
      margin-top: 10px;
    }
    
    .module-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    
    .module-checkbox:hover {
      border-color: #4f46e5;
      background: #f8fafc;
    }
    
    .module-checkbox input[type="checkbox"] {
      margin-right: 10px;
    }
    
    .module-info {
      flex: 1;
    }
    
    .module-code {
      font-weight: 600;
      color: #1f2937;
    }
    
    .module-name {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .module-price {
      color: #10b981;
      font-weight: 600;
      margin-left: 10px;
    }
    
    /* Teacher Specialization */
    .teacher-modules-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px;
      background: #f9fafb;
      margin-top: 10px;
    }
    
    .teacher-module-option {
      padding: 8px;
      margin-bottom: 5px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .teacher-module-option:hover {
      border-color: #4f46e5;
      background: #f8fafc;
    }
    
    .teacher-module-option.selected {
      border-color: #4f46e5;
      background: #f0f9ff;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .hero-section h1 { font-size: 2rem; }
      .hero-section p { font-size: 1rem; }
      
      .hamburger {
        display: block;
      }
      
      .nav-links {
        position: fixed;
        top: 80px;
        left: 0;
        width: 100%;
        background: white;
        flex-direction: column;
        align-items: flex-start;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        transform: translateY(-150%);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.3s ease;
        z-index: 999;
        display: none;
      }
      
      .nav-links.active {
        transform: translateY(0);
        opacity: 1;
        display: flex;
      }
      
      nav a {
        margin: 10px 0;
        display: block;
        width: 100%;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        margin-left: 0;
      }
      
      nav a:last-child {
        border-bottom: none;
      }
      
      .btn {
        display: inline-block;
        text-align: center;
        margin-top: 10px;
      }
      
      .features, .courses-grid, .teacher-courses {
        grid-template-columns: 1fr;
      }
      
      section, header, .cta {
        padding-left: 5%;
        padding-right: 5%;
      }

      .form-container {
        padding: 20px;
        margin: 20px auto;
      }

      .year-navigation {
        flex-direction: column;
        align-items: center;
      }

      .year-btn {
        width: 200px;
      }
      
      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .hero-cta .btn {
        display: block;
        margin: 10px auto;
        width: 80%;
        max-width: 250px;
      }
      
      .mode-switcher {
        flex-direction: column;
      }
    }
    
    @media (max-width: 480px) {
      .hero-section {
        padding: 80px 5% 40px;
      }
      
      .hero-section h1 {
        font-size: 1.8rem;
      }
      
      .stats-section {
        grid-template-columns: 1fr;
      }
      
      .card, .course-card {
        padding: 20px;
      }
      
      .form-container {
        padding: 15px;
      }
      /* Update mobile responsiveness for dev mode */
@media (max-width: 768px) {
  /* ... existing mobile styles ... */
  
  /* Dev Mode Indicator for mobile */
  .dev-mode-indicator {
    font-size: 10px;
    padding: 6px;
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .dev-mode-indicator span {
    padding: 1px 5px;
    font-size: 9px;
  }
  
  /* Adjust nav position when dev mode is active */
  #nav {
    transition: top 0.3s ease;
  }
  
  /* Mode switcher for mobile */
  .mode-switcher {
    padding: 12px;
    flex-direction: column;
  }
  
  .mode-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 5px;
  }
  
  .mode-btn:last-child {
    margin-bottom: 0;
  }
  
  /* Dev tag adjustments */
  .dev-tag {
    font-size: 0.6rem;
    padding: 1px 4px;
  }
}

@media (max-width: 480px) {
  .dev-mode-indicator {
    font-size: 8px;
    padding: 4px;
  }
  
  .dev-mode-indicator span {
    padding: 1px 3px;
    font-size: 7px;
  }
  
  .dev-tag {
    font-size: 0.5rem;
    padding: 0 3px;
  }
}
    }
    /* Admin student removal buttons */
.btn-danger {
  background: #ef4444;
  color: white;
  padding: 8px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  display: inline-block;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

/* Student item layout */
.student-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  border-bottom: 1px solid #f3f4f6;
  transition: background 0.3s;
}

.student-item:hover {
  background: #f9fafb;
}

.student-item .btn {
  min-width: 120px;
  text-align: center;
}

/* Fix scrolling issue */
body {
  overflow: auto !important;
  position: static !important;
}

/* Fix form positioning - make it modal-like but not full screen */
.form-container {
  display: none !important;
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  z-index: 10000 !important;
  background: white !important;
  border-radius: 10px !important;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
  max-width: 400px !important;
  width: 90% !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
  padding: 30px !important;
  margin: 0 !important;
}

.form-container.active {
  display: block !important;
}

/* Create overlay when form is active */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
}

.modal-overlay.active {
  display: block;
}

/* Center form content */
.form-box {
  position: relative !important;
  z-index: 10001 !important;
}

/* Center the form titles */
.form-box h2 {
  text-align: center;
  margin-bottom: 25px;
  color: #4f46e5;
  font-size: 1.8rem;
}

/* Center form inputs */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #333;
  text-align: left;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border-radius: 6px;
  border: 1px solid #ddd;
  font-size: 1rem;
  transition: border 0.3s;
  box-sizing: border-box;
}

/* Center buttons */
.form-box .btn {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  margin-top: 10px;
}

/* Center switch links */
.form-switch {
  text-align: center;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

/* Fix password toggle position */
.password-toggle {
  position: relative;
}

.toggle-password {
  position: absolute;
  right: 15px;
  top: 42px;
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  font-size: 0.9rem;
  z-index: 1;
}

/* Center success messages */
.success-message {
  text-align: center;
  padding: 12px;
  margin-bottom: 15px;
  border-radius: 6px;
  background: #10b981;
  color: white;
  display: none;
}

.success-message.show {
  display: block;
}
/* ========== COURSE MATERIALS MODAL STYLES ========== */
.materials-container {
  max-height: 400px;
  overflow-y: auto;
  margin-top: 15px;
}

.material-item {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
}

.material-item:hover {
  border-color: #4f46e5;
  box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
}

.material-type {
  background: #e5e7eb;
  color: #6b7280;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  text-transform: capitalize;
}

.file-icon {
  font-size: 1.5rem;
  color: #4f46e5;
}

.download-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 15px;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  text-decoration: none;
}

.download-btn:hover {
  background: #4338ca;
  transform: translateY(-2px);
}

.download-btn:disabled {
  background: #d1d5db;
  cursor: not-allowed;
  transform: none;
}

/* For the course materials modal */
.course-card {
  cursor: pointer;
  position: relative;
}

@media (max-width: 768px) {
  .material-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .material-item > div:last-child {
    align-self: flex-end;
  }
}
  </style>
</head>
<body>

<nav id="nav">
  <h2>Thrive Academy </h2>
  <div class="hamburger" id="hamburger">
    <i class="fas fa-bars"></i>
  </div>
  <div class="nav-links" id="navLinks">
    <a href="#" id="homeLink">Home</a>
    <a href="#" id="coursesLink">Courses</a>
    <a href="#" id="dashboardLink" class="hidden">Dashboard</a>
    <a href="#" id="adminLink" class="hidden">Admin</a>
    <button id="themeToggle" class="theme-toggle-btn" title="Toggle Dark Mode"></button>
    <a href="#" id="loginLink">Login</a>
    <a class="btn" href="#" id="registerLink">Register</a>
    <a href="#" id="logoutLink" class="btn btn-secondary hidden">Logout</a>
  </div>
</nav>

<!-- Home Page -->
<section id="home">
  <div class="hero-section">
    <h1>Learn Better. Score Higher.</h1>
    <p>Premium tutoring for Grade 8–12 & University students</p>
    <div class="hero-cta">
      <a href="#" class="btn" id="homeRegisterBtn">Start Learning Now</a>
      <a href="#" class="btn btn-secondary" id="homeLearnMoreBtn">Learn More</a>
    </div>
  </div>
  
  <div class="stats-section">
    <div class="stat-card">
      <h3>50+</h3>
      <p>Students Enrolled</p>
    </div>
    <div class="stat-card">
      <h3>10+</h3>
      <p>Expert Tutors</p>
    </div>
    <div class="stat-card">
      <h3>100%</h3>
      <p>Pass Rate</p>
    </div>
    <div class="stat-card">
      <h3>24/7</h3>
      <p>Study Support</p>
    </div>
  </div>
  
  <div class="features-section">
    <h2 class="section-title">Why Choose Thrive Academy?</h2>
    <div class="features-grid">
      <div class="feature-card">
        <div class="feature-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <h3>Expert Tutors</h3>
        <p>Learn from experienced university students.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">
          <i class="fas fa-book"></i>
        </div>
        <h3>Comprehensive Materials</h3>
        <p>Access notes, videos, past papers, and assignments all in one place.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <h3>Track Progress</h3>
        <p>Monitor your learning journey with detailed progress tracking.</p>
      </div>
    </div>
  </div>
  
  <!-- Conditional Modules Display -->
  <div id="homeModulesSection">
    <!-- Content loaded based on user status -->
  </div>
</section>

<section id="courses">
  <h2 class="section-title">University Courses</h2>
  <p style="text-align: center; margin-bottom: 30px; color: #6b7280;" id="coursesInstruction">
    Select a year to view available modules
  </p>
  
  <div class="year-navigation" id="yearNavigation">
    <button class="year-btn active" data-year="1">1st Year</button>
    <button class="year-btn" data-year="2">2nd Year</button>
  </div>

  <div id="courses-container">
    <!-- Courses will be dynamically loaded here -->
  </div>

  <!-- Payment Section (for students) -->
  <div id="paymentSection" class="payment-section hidden">
    <h3>Complete Your Enrollment</h3>
    <div class="selected-courses" id="selectedCourses">
      <!-- Selected courses will appear here -->
    </div>
    <div class="total-amount">
      Total: R<span id="totalAmount">0.00</span>
    </div>
    <div class="payment-instructions">
      <h4>Payment Instructions:</h4>
      <p>1. Make payment of R<span id="paymentAmount">0.00</span> to:</p>
      <p><strong>Bank: Standard Bank</strong></p>
      <p><strong>Account: 1234567890</strong></p>
      <p><strong>Reference: Your Student ID/Email</strong></p>
      <p>2. Email proof of payment to: payments@tutorpro.com</p>
      <p>3. Your access will be activated within 24 hours</p>
    </div>
    <button class="btn btn-success" id="confirmPaymentBtn">I Have Made Payment</button>
    <button class="btn btn-secondary" id="cancelEnrollmentBtn">Cancel</button>
  </div>
</section>

<!-- Dashboard Section -->
<section id="dashboard" class="dashboard">
  <h2 class="section-title">My Dashboard</h2>
  
  <div class="user-info">
    <h3>Welcome, <span id="userName">User</span> <span class="role-badge" id="userRole">Student</span></h3>
    <p id="userEmail">user@example.com</p>
    <p id="userYearLevel" class="hidden">Year: <span id="yearLevelDisplay"></span></p>
    <p id="userCourses" class="hidden">Teaching: <span id="teachingCourses"></span></p>
    <p id="userBalance" class="hidden">Account Balance: R<span id="balanceAmount">0.00</span></p>
  </div>

  <div id="teacherDashboard" class="hidden">
    <h3 style="margin-bottom: 20px;">My Teaching Modules</h3>
    <div class="teacher-courses" id="teacherCoursesContainer">
      <!-- Teacher's courses will be loaded here -->
    </div>
  </div>

  <div id="studentDashboard">
    <h3 style="margin-bottom: 20px;">My Courses</h3>
    <div class="courses-grid" id="studentCoursesContainer">
      <!-- Student's enrolled courses will be loaded here -->
    </div>
  </div>
</section>

<!-- Admin Panel -->
<section id="adminPanel" class="dashboard">
  <h2 class="section-title">Admin Panel</h2>
  
  <div class="admin-panel">
    <h3>Manual Student Enrollment & Payment Management</h3>
    
    <!-- Dev Mode Controls (only visible in dev mode) -->
    <div id="devModeControls" class="hidden">
      <h4 style="color: #ff6b6b; border-bottom: 2px solid #ff6b6b; padding-bottom: 10px; margin-bottom: 15px;">
        <i class="fas fa-code"></i> Developer Mode
      </h4>
      <div class="mode-switcher">
        <p style="flex: 1; margin: 0; color: #6b7280;">Switch to view as:</p>
        <button class="mode-btn" data-mode="admin">Admin</button>
        <button class="mode-btn" data-mode="teacher">Teacher</button>
        <button class="mode-btn" data-mode="student">Student</button>
      </div>
      <div style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
        <p><strong>Current Mode:</strong> <span id="currentModeDisplay">Admin</span></p>
        <p><strong>STAT Modules:</strong> STAT 130, 140 (Year 1) | STAT 230, 240 (Year 2)</p>
      </div>
    </div>
    
    <div class="admin-actions">
      <button onclick="testSupabase()" class="btn" style="background: #3ecf8e; color: white;">
  <i class="fas fa-plug"></i> Test Supabase Connection
</button>
      <button class="btn" id="enrollStudentBtn">Enroll Student in Course</button>
      <button class="btn btn-secondary" id="viewStudentsBtn">View All Students</button>
      <button class="btn btn-warning" id="verifyPaymentBtn">Verify Payment</button>
      <button class="btn" id="createTeacherBtn" style="background: #10b981;">Create Teacher</button> 
      <button class="btn" id="toggleDevModeBtn" style="background: #ff6b6b;">Toggle Dev Mode</button>
      <button class="btn btn-success" id="testFirebaseBtn">
  <i class="fas fa-bolt"></i> Test Firebase
</button>
  <button class="btn btn-warning" id="fixTeacherLoginBtn">
    <i class="fas fa-key"></i> Fix Teacher Login
  </button>
  <button class="btn" id="createStudentCodeBtn" style="background: #8b5cf6;">
    <i class="fas fa-key"></i> Create Student Access Code
</button>
    </div>

    <!-- Enrollment Form -->
    <div id="enrollmentForm" class="enrollment-form hidden">
      <h4>Select Student</h4>
      <select id="studentSelect" class="form-group">
        <option value="">Select a student</option>
      </select>
      
      <h4 style="margin-top: 20px;">Select Course to Enroll</h4>
      <div class="enrollment-options" id="courseOptions">
        <!-- Course options will be loaded here -->
      </div>
      
      <div style="margin-top: 20px;">
        <button class="btn btn-success" id="confirmEnrollmentBtn">Enroll Student</button>
        <button class="btn btn-secondary" id="cancelEnrollmentBtn2">Cancel</button>
      </div>
    </div>

    <!-- Payment Verification -->
    <div id="paymentVerification" class="enrollment-form hidden">
      <h4>Verify Student Payment</h4>
      <select id="paymentStudentSelect" class="form-group">
        <option value="">Select a student</option>
      </select>
      
      <div id="studentPaymentInfo" class="hidden">
        <h5>Student Information</h5>
        <p>Name: <span id="paymentStudentName"></span></p>
        <p>Email: <span id="paymentStudentEmail"></span></p>
        <p>Pending Amount: R<span id="pendingAmount">0.00</span></p>
        
        <div class="form-group">
          <label for="paymentReference">Payment Reference Number</label>
          <input type="text" id="paymentReference" placeholder="Enter payment reference">
        </div>
        
        <div class="form-group">
          <label for="paymentAmount">Amount Paid (R)</label>
          <input type="number" id="paymentAmountInput" placeholder="250">
        </div>
        
        <div style="margin-top: 20px;">
          <button class="btn btn-success" id="verifyPaymentConfirmBtn">Verify Payment</button>
          <button class="btn btn-secondary" id="cancelVerificationBtn">Cancel</button>
        </div>
      </div>
    </div>
    <!-- Teacher Creation Form -->
<div id="teacherCreationForm" class="enrollment-form hidden">
  <h4>Create New Teacher Account</h4>
  
  <div class="form-group">
    <label for="teacherFullName">Full Name</label>
    <input type="text" id="teacherFullName" placeholder="Enter teacher's full name">
  </div>
  
  <div class="form-group">
    <label for="teacherEmail">Email Address</label>
    <input type="email" id="teacherEmail" placeholder="teacher@thrive.com">
  </div>
  
  <div class="form-group">
    <label for="teacherPassword">Password</label>
    <input type="password" id="teacherPassword" placeholder="Create a password">
  </div>
  
  <div class="form-group">
    <label>Assign Teaching Modules (Select 1-10)</label>
    <div class="teacher-modules-container" id="adminTeacherModules" style="max-height: 200px;">
      <!-- Modules will load here -->
    </div>
    <small style="color: #6b7280;">
      Selected: <span id="adminSelectedCount">0</span> modules
    </small>
  </div>
  
  <div style="margin-top: 20px;">
    <button class="btn btn-success" id="confirmCreateTeacherBtn">
      <i class="fas fa-user-plus"></i> Create Teacher Account
    </button>
    <button class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
  </div>
</div>
    <!-- Students List -->
    <div id="studentsList" class="student-list hidden">
      <h4>All Students</h4>
      <div id="studentsContainer">
        <!-- Students will be listed here -->
      </div>
    </div>
  </div>
</section>

<div id="addMaterialModal" class="form-container hidden">
  <div class="form-box">
    <h2>Add Teaching Material</h2>
    <div class="success-message" id="materialSuccess"></div>
    
    <!-- ❌ CHANGED FROM DIV TO FORM -->
    <form id="addMaterialForm">
      <input type="hidden" id="materialCourseCode">
      
      <div class="form-group">
        <label for="materialTitle">Material Title</label>
        <input type="text" id="materialTitle" placeholder="e.g., Chapter 1 Notes, Week 3 Lecture">
        <div class="error-message" id="materialTitleError">Please enter a title</div>
      </div>
      
      <div class="form-group">
        <label for="materialType">Material Type</label>
        <select id="materialType" onchange="handleMaterialTypeChange()">
          <option value="">Select type</option>
          <option value="notes">Notes</option>
          <option value="video">Video Lecture</option>
          <option value="assignment">Assignment</option>
          <option value="past_paper">Past Paper</option>
          <option value="exercise">Exercise</option>
          <option value="other">Other</option>
        </select>
        <div class="form-group">
          <label>Upload File (PDF / Video)</label>
          <input
            type="file"
            id="materialFile"
            accept=".pdf,.mp4,.mov,.avi"
          >
        </div>

        <div class="error-message" id="materialTypeError">Please select material type</div>
      </div>
      
      <div class="form-group">
        <label for="materialDescription">Description</label>
        <textarea id="materialDescription" placeholder="Brief description of the material"></textarea>
      </div>
      
      <div class="form-group">
        <label for="materialLink">Link/URL (Optional)</label>
        <input type="url" id="materialLink" placeholder="https://...">
      </div>
  
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn btn-success" onclick="uploadMaterial().catch(err => console.error(err))">
          Add Material
        </button>

        <button type="button" class="btn btn-secondary" id="cancelMaterialBtn" style="flex: 1;">Cancel</button>
      </div>
    </form> <!-- ❌ CHANGED FROM </div> TO </form> -->
  </div>
</div>

<!-- Login Form -->
<div class="form-container" id="loginForm">
  <div class="form-box">
    <h2>Login</h2>
    <div class="success-message" id="loginSuccess"></div>
    
    <form id="loginFormElement">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email">
        <div class="error-message" id="loginEmailError">Please enter a valid email address</div>
      </div>
      
      <div class="form-group password-toggle">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password">
        <button type="button" class="toggle-password" id="toggleLoginPassword">
          <i class="far fa-eye"></i>
        </button>
        <div class="error-message" id="loginPasswordError">Password must be at least 6 characters</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
  <button type="submit" class="btn" style="flex: 1;">Login</button>
  <button type="button" class="btn btn-secondary" id="cancelLoginBtn" style="flex: 1;">Cancel</button>
</div>
    </form>
    <!-- Google Login Button -->
<div style="text-align: center; margin: 20px 0;">
  <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
    <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
    <div style="color: #6b7280; font-size: 0.9rem;">Or login with Google</div>
    <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
  </div>
  
  <button type="button" class="btn" id="googleLoginBtn" style="background: white; color: #333; border: 1px solid #ddd; width: 100%; padding: 12px;">
    <img src="https://www.google.com/favicon.ico" alt="Google" style="width: 18px; height: 18px; margin-right: 10px; vertical-align: middle;">
    Continue with Google
  </button>
</div>


    <div class="form-switch">
      Don't have an account? <a href="#" id="switchToRegister">Register here</a>
    </div>
 
  </div>
</div>

<!-- Register Form -->
<div class="form-container" id="registerForm">
  <div class="form-box">
    <h2>Create Account</h2>
    <div class="success-message" id="registerSuccess"></div>
    
    <form id="registerFormElement">
      <div class="form-group">
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" placeholder="Enter your full name">
        <div class="error-message" id="fullNameError">Please enter your full name</div>
      </div>
      
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="Enter your email">
        <div class="error-message" id="emailError">Please enter a valid email address</div>
      </div>
      
      <div class="form-group">
        <label for="userType">I am a</label>
        <select id="userType">
          <option value="">Select user type</option>
          <option value="student">Student</option>
        </select>
        <div class="error-message" id="userTypeError">Please select user type</div>
      </div>
      
      <!-- Teacher Specialization - Custom Implementation -->
      <div class="form-group hidden" id="teacherFields">
        <label for="teacherSpecialization">Teaching Specialization <span style="color: #ef4444;">*</span> (Select modules you'll teach)</label>
        <div class="teacher-modules-container" id="teacherModulesContainer">
          <!-- Teacher modules will be loaded here -->
        </div>
        <small style="color: #6b7280; display: block; margin-top: 5px;">
          <span id="selectedCount">0</span> of 3 modules selected
        </small>
        <div class="error-message" id="teacherSpecializationError">Please select at least one module (max 3)</div>
      </div>
      
    
<div class="form-group hidden" id="studentFields">
  <label for="yearLevel">Year Level</label>
  <select id="yearLevel">
    <option value="">Select year level</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="mixed">Mixed (1st & 2nd Year)</option>
  </select>
  <div class="error-message" id="yearLevelError">Please select year level</div>
</div>




<!-- Payment Information Note -->
<div class="payment-note" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #4f46e5;">
  <!-- Google Registration Button -->
<div style="text-align: center; margin: 20px 0;">
  <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
    <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
    <div style="color: #6b7280; font-size: 0.9rem;">Or register with Google</div>
    <div style="flex: 1; height: 1px; background: #e5e7eb;"></div>
  </div>
  
  <button type="button" class="btn" id="googleRegisterBtn" style="background: white; color: #333; border: 1px solid #ddd; width: 100%; padding: 12px;">
    <img src="https://www.google.com/favicon.ico" alt="Google" style="width: 18px; height: 18px; margin-right: 10px; vertical-align: middle;">
    Continue with Google
  </button>
</div>
  <h4 style="color: #4f46e5; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Payment Information</h4>
  <p style="margin-bottom: 10px;">✅ <strong>Account creation is FREE!</strong></p>
  <p style="margin-bottom: 10px;">After registration, you can:</p>
  <ol style="margin-left: 20px; color: #6b7280;">
    <li>Browse all available courses</li>
    <li>Select modules you want to enroll in</li>
    <li>Get payment instructions</li>
    <li>Access materials after payment verification</li>
  </ol>
  <p style="margin-top: 10px; color: #10b981; font-weight: 600;">
    <i class="fas fa-check-circle"></i> Each module costs R250
  </p>
</div>
      
<!-- Module Selection - Important: Students MUST select modules at registration -->
<div class="form-group hidden" id="studentModulesField">
  <label for="studentModules">Select Modules to Enroll (R250 each)</label>
  <div class="modules-container" id="modulesCheckboxContainer">
    <!-- Modules will be dynamically loaded here -->
  </div>
  <div class="error-message" id="studentModulesError">Please select at least one module</div>
</div>
      
      
      
      <div class="form-group password-toggle">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Create a password">
        <button type="button" class="toggle-password" id="togglePassword">
          <i class="far fa-eye"></i>
        </button>
        <div class="error-message" id="passwordError">Password must be at least 8 characters with letters and numbers</div>
      </div>
      
      <div class="form-group password-toggle">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm your password">
        <button type="button" class="toggle-password" id="toggleConfirmPassword">
          <i class="far fa-eye"></i>
        </button>
        <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
  <button type="submit" class="btn" style="flex: 1;">Create Account</button>
  <button type="button" class="btn btn-secondary" id="cancelRegisterBtn" style="flex: 1;">Cancel</button>
</div>
    </form>
    
    <div class="form-switch">
      Already have an account? <a href="#" id="switchToLogin">Login here</a>
    </div>
  </div>
</div>

<div class="cta">
  <h2>Start Learning Today</h2>
  <p> and unlock premium study material.</p>
  <br />
  <a class="btn" href="#" id="ctaRegister">Get Started</a>
</div>

<footer>
  © 2025 Thrive academy. All rights reserved.
</footer>
<!-- ADD THESE LINES IN YOUR HEAD -->

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
  // ========== SIMPLE STUDENT MATERIALS VIEWER ==========
function openStudentMaterials(courseCode) {
    console.log("Opening materials for:", courseCode);
    
    // Get course details
    let courseDetails = null;
    for (const year in coursesData) {
        const course = coursesData[year].find(c => c.code === courseCode);
        if (course) {
            courseDetails = course;
            break;
        }
    }
    
    // Get materials for this course
    const courseMaterials = materials.filter(m => m.courseCode === courseCode);
    
    // Create simple modal
    const modalHTML = `
        <div id="studentMaterialsModal" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        ">
            <div style="
                background: #4f46e5;
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <h3 style="margin: 0;">${courseDetails?.code || courseCode} - Materials</h3>
                <button onclick="document.getElementById('studentMaterialsModal').remove(); document.getElementById('studentMaterialsOverlay').remove();" style="
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.2rem;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            ">
                ${courseDetails ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #4f46e5;">${courseDetails.name}</h4>
                        <p style="margin: 0; color: #6b7280;">Teacher: ${courseDetails.teacher}</p>
                    </div>
                ` : ''}
                
                ${courseMaterials.length > 0 ? `
                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">Available Materials (${courseMaterials.length})</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${courseMaterials.map(material => `
                            <div style="
                                border: 1px solid #e5e7eb;
                                border-radius: 8px;
                                padding: 15px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            ">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                        <i class="fas ${getMaterialIcon(material.type)}" style="color: #4f46e5;"></i>
                                        <strong>${material.title}</strong>
                                    </div>
                                    <div style="display: flex; gap: 10px; font-size: 0.9rem; color: #6b7280;">
                                        <span>${material.type.replace('_', ' ')}</span>
                                        <span>•</span>
                                        <span>${formatDate(material.addedAt)}</span>
                                    </div>
                                    ${material.description ? `<p style="margin: 8px 0 0 0; color: #6b7280; font-size: 0.9rem;">${material.description}</p>` : ''}
                                </div>
                                <div>
                                    ${material.link ? `
                                        <a href="${material.link}" target="_blank" class="btn" style="padding: 8px 15px;">
                                            <i class="fas fa-external-link-alt"></i> Open
                                        </a>
                                    ` : `
                                        <a
  href="${material.fileURL}"
  target="_blank"
  class="btn"
  style="padding: 8px 15px;"
>
  <i class="fas fa-download"></i> Download
</a>

                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                        <h4 style="color: #6b7280; margin-bottom: 10px;">No Materials Yet</h4>
                        <p style="color: #9ca3af;">Materials will appear here once uploaded by the teacher.</p>
                    </div>
                `}
            </div>
            
            <div style="
                padding: 15px 20px;
                border-top: 1px solid #e5e7eb;
                text-align: center;
            ">
                <button onclick="document.getElementById('studentMaterialsModal').remove(); document.getElementById('studentMaterialsOverlay').remove();" class="btn" style="width: 100%;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    // Add modal to page
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.id = 'studentMaterialsOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99999;
    `;
    overlay.onclick = function() {
        document.getElementById('studentMaterialsModal')?.remove();
        this.remove();
    };
    document.body.appendChild(overlay);
    
    // Prevent scrolling on body
    document.body.style.overflow = 'hidden';
}

// Make sure this function is available globally
window.openStudentMaterials = openStudentMaterials;
  // Make sure openCourseMaterials is available globally
if (typeof openCourseMaterials !== 'function') {
    // Define it if it doesn't exist
    window.openCourseMaterials = function(courseCode) {
        console.log("Opening course materials for:", courseCode);
        
        // Check if user is enrolled
        if (!currentUser || !currentUser.enrolledCourses || !currentUser.enrolledCourses.includes(courseCode)) {
            alert("You are not enrolled in this course. Please enroll first.");
            return;
        }
        
        // Create and show materials modal
        const modalHTML = `
            <div id="courseMaterialsModal" class="form-container active">
                <div class="form-box">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>${courseCode} - Course Materials</h2>
                        <button class="btn btn-secondary" onclick="document.getElementById('courseMaterialsModal').remove(); document.getElementById('materialsModalOverlay').remove();" style="padding: 5px 15px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #4f46e5; margin-bottom: 15px;"></i>
                        <p>Loading materials...</p>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to page
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay active';
        overlay.id = 'materialsModalOverlay';
        overlay.onclick = function() {
            document.getElementById('courseMaterialsModal')?.remove();
            this.remove();
        };
        document.body.appendChild(overlay);
        
        // Load materials after a short delay
        setTimeout(() => {
            const materialsForCourse = materials.filter(m => m.courseCode === courseCode);
            
            if (materialsForCourse.length === 0) {
                modalContainer.querySelector('.form-box').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>${courseCode} - Course Materials</h2>
                        <button class="btn btn-secondary" onclick="document.getElementById('courseMaterialsModal').remove(); document.getElementById('materialsModalOverlay').remove();" style="padding: 5px 15px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                        <h3>No Materials Yet</h3>
                        <p style="color: #6b7280;">Materials will appear here once uploaded by the teacher.</p>
                    </div>
                `;
            } else {
                // Show materials list
                modalContainer.querySelector('.form-box').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>${courseCode} - Course Materials</h2>
                        <button class="btn btn-secondary" onclick="document.getElementById('courseMaterialsModal').remove(); document.getElementById('materialsModalOverlay').remove();" style="padding: 5px 15px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="materials-container">
                        ${materialsForCourse.map(material => `
                            <div class="material-item">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas ${getMaterialIcon(material.type)}" style="color: #4f46e5; font-size: 1.2rem;"></i>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; font-size: 1rem;">${material.title}</h4>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span class="material-type">
                                                    ${material.type.replace('_', ' ')}
                                                </span>
                                                <span style="color: #6b7280; font-size: 0.8rem;">
                                                    <i class="far fa-clock"></i> ${formatDate(material.addedAt)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    ${material.description ? `<p style="margin: 10px 0 0 0; color: #6b7280; font-size: 0.9rem;">${material.description}</p>` : ''}
                                </div>
                                
                                <div>
                                    ${material.link ? `
                                        <a href="${material.link}" target="_blank" class="btn" style="padding: 8px 15px;">
                                            <i class="fas fa-external-link-alt"></i> Open
                                        </a>
                                    ` : `
                                        <button class="btn" onclick="downloadMaterial('${material.id}')" style="padding: 8px 15px;">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }, 500);
    };
}
// ========== THEME TOGGLE FUNCTIONALITY ==========
let darkMode = localStorage.getItem('ThriveAcademy_darkMode') === 'true' || false;

// Initialize theme on page load
function initTheme() {
  if (darkMode) {
    document.body.classList.add('dark-mode');
  }
  updateThemeToggleIcon();
}

// Toggle theme function
function toggleDarkMode() {
  darkMode = !darkMode;
  
  if (darkMode) {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }
  
  localStorage.setItem('ThriveAcademy_darkMode', darkMode);
  updateThemeToggleIcon();
  
  console.log(`Dark Mode: ${darkMode ? 'ON' : 'OFF'}`);
}

// Update the theme toggle icon
function updateThemeToggleIcon() {
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    // Clear existing icon
    themeToggle.innerHTML = '';
    
    const icon = document.createElement('i');
    if (darkMode) {
      icon.className = 'fas fa-sun';
      themeToggle.title = "Switch to Light Mode";
    } else {
      icon.className = 'fas fa-moon';
      themeToggle.title = "Switch to Dark Mode";
    }
    
    themeToggle.appendChild(icon);
  }
}

// Add event listener for theme toggle
document.addEventListener('DOMContentLoaded', function() {
  // Initialize theme
  initTheme();
  
  // Create and add theme toggle button if it doesn't exist
  let themeToggle = document.getElementById('themeToggle');
  if (!themeToggle) {
    themeToggle = document.createElement('button');
    themeToggle.id = 'themeToggle';
    themeToggle.className = 'theme-toggle-btn';
    themeToggle.title = "Toggle Dark Mode";
    
    const navLinks = document.getElementById('navLinks');
    if (navLinks) {
      // Insert before the login link
      const loginLink = document.getElementById('loginLink');
      if (loginLink) {
        navLinks.insertBefore(themeToggle, loginLink);
      } else {
        navLinks.appendChild(themeToggle);
      }
    }
  }
 // ================= ADMIN: CREATE STUDENT ACCESS CODE =================
const createStudentCodeBtn = document.getElementById('createStudentCodeBtn');

if (createStudentCodeBtn) {
  createStudentCodeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Show the new student access code form
    showStudentAccessCodeForm();
  });
}

  // Set initial icon
  updateThemeToggleIcon();
  
  // Add click event
  themeToggle.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    toggleDarkMode();
  });
  
  // Also add keyboard shortcut (Alt+T) for theme toggle
  document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key === 't') {
      toggleDarkMode();
      e.preventDefault();
    }
  });
});
// Google Login for existing users
document.getElementById('googleLoginBtn')?.addEventListener('click', async function() {
  console.log("Google login clicked");
  
  // Show loading
  const originalText = this.innerHTML;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
  this.disabled = true;
  
  try {
    if (!window.auth || !window.GoogleAuthProvider || !window.signInWithPopup) {
      throw new Error("Google authentication not available");
    }
    
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    
    console.log("Google login successful:", user.email);
    
    // Find user in our system
    let foundUser = null;
    
    // Check Firestore
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", user.email));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0];
        foundUser = { id: doc.id, ...doc.data() };
      }
    }
    
    // Check localStorage
    if (!foundUser) {
      foundUser = users.find(u => u.email === user.email);
    }
    
    if (foundUser) {
      // Login successful
      currentUser = foundUser;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      
      // Update UI
      updateUIForUser();
      updateHomePage();
      updateCoursesDisplay();
      
      // Close login form
      document.getElementById('loginForm').classList.remove('active');
      
      // Show dashboard
      showDashboard();
      
      
    } else {
      // User not found - redirect to registration
      alert("❌ No account found with this Google email.\n\nPlease register first.");
      document.getElementById('loginForm').classList.remove('active');
      document.getElementById('registerForm').classList.add('active');
    }
    
  } catch (error) {
    console.error("Google login error:", error);
    alert("❌ Google login failed: " + error.message);
  } finally {
    // Reset button
    this.innerHTML = originalText;
    this.disabled = false;
  }
});
// DEBUG: Check a specific user's login status
async function debugUserLogin(emailToCheck) {
  console.log("=== DEBUG USER LOGIN ===");
  console.log("Checking:", emailToCheck);
  
  if (!window.db) {
    console.log("❌ Firebase not loaded");
    return;
  }
  
  // Check Firestore
  const q = query(collection(db, "users"), where("email", "==", emailToCheck));
  const snapshot = await getDocs(q);
  
  if (snapshot.empty) {
    console.log("❌ NOT in Firestore");
  } else {
    const doc = snapshot.docs[0];
    const user = doc.data();
    console.log("✅ IN Firestore:");
    console.log("- ID:", doc.id);
    console.log("- Type:", user.userType);
    console.log("- Has password field:", !!user.password);
    console.log("- Password value:", user.password || "(empty)");
    console.log("- Has firebaseUID:", !!user.firebaseUID);
  }
  
  // Check Local Storage
  const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
  const localUser = localUsers.find(u => u.email === emailToCheck);
  
  if (localUser) {
    console.log("✅ IN Local Storage:");
    console.log("- Has password:", !!localUser.password);
    console.log("- Password:", localUser.password || "(empty)");
  } else {
    console.log("❌ NOT in Local Storage");
  }
}


// ========== UNIVERSAL CROSS-DEVICE LOGIN ==========
document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  // Basic validation
  if (!email || !validateEmail(email)) {
    showError('loginEmail', 'loginEmailError');
    return;
  }
  
  if (!password || password.length < 6) {
    showError('loginPassword', 'loginPasswordError');
    return;
  }
  
  // Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
  submitBtn.disabled = true;
  
  try {
    console.log(`Login attempt: ${email}`);
    
    let user = null;
    
    // ========== STRATEGY 1: CHECK FIRESTORE FIRST (CROSS-DEVICE) ==========
    if (window.db) {
      console.log("Checking Firestore for cross-device login...");
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        const firestoreUser = doc.data();
        console.log("Found user in Firestore:", firestoreUser.email);
        
        // Check if password matches (CRITICAL FOR CROSS-DEVICE)
        if (firestoreUser.password && firestoreUser.password === password) {
          user = { id: doc.id, ...firestoreUser };
          console.log("✅ Password matches in Firestore - CROSS-DEVICE LOGIN SUCCESS");
        } else {
          console.log("❌ Password doesn't match in Firestore");
        }
      }
    }
    
    // ========== STRATEGY 2: CHECK LOCAL STORAGE (CURRENT DEVICE) ==========
    if (!user) {
      console.log("Checking local storage...");
      const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
      const localUser = localUsers.find(u => u.email === email && u.password === password);
      
      if (localUser) {
        user = localUser;
        console.log("✅ Found in local storage");
      }
    }
    
    // ========== STRATEGY 3: CHECK FIREBASE AUTH (OPTIONAL) ==========
    if (!user && window.auth && window.signInWithEmailAndPassword) {
      console.log("Trying Firebase Auth...");
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const firebaseUser = userCredential.user;
        
        // Find this user in Firestore
        if (window.db) {
          const q = query(collection(db, "users"), where("email", "==", email));
          const snapshot = await getDocs(q);
          
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            user = { id: doc.id, ...doc.data() };
            console.log("✅ Firebase Auth success");
          }
        }
      } catch (authError) {
        console.log("Firebase Auth failed:", authError.code);
        // Not an error - just means not in Firebase Auth
      }
    }
    
    // ========== USER NOT FOUND ANYWHERE ==========
    if (!user) {
      // Check if email exists in Firestore (for better error message)
      let emailExists = false;
      
      if (window.db) {
        const q = query(collection(db, "users"), where("email", "==", email));
        const snapshot = await getDocs(q);
        emailExists = !snapshot.empty;
      }
      
      if (emailExists) {
        throw new Error('Wrong password. Try the password you used when registering.');
      } else {
        throw new Error('No account found. Please register first.');
      }
    }
    
    // ========== LOGIN SUCCESS ==========
    console.log(`✅ Login success: ${user.email}`);
    
    // Save user session
    currentUser = user;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(user));
    
    // Also save to local users list for this device (for faster future logins)
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const existingIndex = localUsers.findIndex(u => u.email === user.email);
    
    if (existingIndex !== -1) {
      // Update existing
      localUsers[existingIndex] = user;
    } else {
      // Add new user to this device's local storage
      localUsers.push(user);
    }
    
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
    
    // Update UI
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    
    // Close form
    document.getElementById('loginForm').classList.remove('active');
    this.reset();
    
    // Show success and redirect
    setTimeout(() => {
      showDashboard();
      
    }, 100);
    
  } catch (error) {
    console.error('Login error:', error);
    
    // Clear error messages first
    document.getElementById('loginEmailError').classList.remove('show');
    document.getElementById('loginPasswordError').classList.remove('show');
    
    // Show appropriate error
    if (error.message.includes('Wrong password')) {
      document.getElementById('loginPasswordError').textContent = error.message;
      document.getElementById('loginPasswordError').classList.add('show');
    } else if (error.message.includes('No account')) {
      document.getElementById('loginEmailError').textContent = error.message;
      document.getElementById('loginEmailError').classList.add('show');
    } else {
      alert('❌ ' + error.message);
    }
    
  } finally {
    // Reset button
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});
// ========== UPGRADE LOCAL USER TO FIRESTORE ==========
async function upgradeLocalUserToFirestore(user, password) {
  try {
    if (!window.db) return false;
    
    console.log("Upgrading local user to Firestore:", user.email);
    
    // Check if already exists in Firestore
    const q = query(collection(db, "users"), where("email", "==", user.email));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      console.log("User already in Firestore, updating...");
      const doc = querySnapshot.docs[0];
      
      // Update with local user data
      await updateDoc(doc.ref, {
        ...user,
        password: password,
        updatedAt: new Date().toISOString()
      });
      
      user.id = doc.id;
      return true;
    }
    
    // Create new Firestore user
    const firestoreUser = { ...user };
    firestoreUser.password = password; // Store password for cross-device login
    firestoreUser.createdAt = new Date().toISOString();
    firestoreUser.updatedAt = new Date().toISOString();
    
    const usersRef = collection(db, "users");
    const docRef = await addDoc(usersRef, firestoreUser);
    
    user.id = docRef.id;
    user.firestoreId = docRef.id;
    
    console.log("✅ Local user upgraded to Firestore");
    return true;
    
  } catch (error) {
    console.error("Upgrade error:", error);
    return false;
  }
}
const coursesData = {
  1: [ // First Year - All 1XX and 196 codes
    { code: "MATH130", name: "Calculus I", description: "", teacher: "Mr M Dlamini", year: 1, price: 250 },
    { code: "MATH140", name: "Calculus 2", description: "Vectors, matrices,complex numbers, integral calculus", teacher: "Mr  SB Ndwandwe", year: 1, price: 250 },
    { code: "MATH141", name: "Agriculture maths", description: "", teacher: "Mr S Mhlongo and MR SL Masinga", year: 1, price: 250 },
    { code: "MATH142", name: "Engineering maths", description: "", teacher: "MR SL Masinga", year: 1, price: 250 },
    { code: "MATH196", name: "agric maths", description: "Ordinary", teacher: "Mr SB Ndwandwe ", year: 1, price: 250 },
    { code: "COMP100", name: "introduction to python", description: "Ordinary", teacher: "Mr A Xaba and M Matimelo ", year: 1, price: 250 },
    { code: "COMP102", name: "introduction to java programming", description: "", teacher: "Mr M Matimelo and Mr A Xaba  ", year: 1, price: 250 },
    { code: "STAT130", name: "Introduction to Statistics", description: "", teacher: "Mr S Mhlongo", year: 1, price: 250 },
    { code: "STAT140", name: "Statistical Methods I", description: "", teacher: "Mr S Mhlongo", year: 1, price: 250,dev:false },{ code: "CHEM110", name: "Chemistry semester1", description: "", teacher: "MR S Mhlongo", year: 1, price: 250,dev:false },{ code: "CHEM120", name: "Chemistry semester2", description: "", teacher: "MR S Mhlongo", year: 1, price: 250,dev:false },{ code: "PHY110", name: "PHYSICS semester 1 ", description: "", teacher: "MR M Dlamini", year: 1, price: 250,dev:false }

  ],
  2: [ // Second Year - All 2XX codes
    { code: "MATH212", name:"Advanced Calculus and Linear Algebra", description:  "CALCULUS: Functions of several variables. Partial derivatives, differentiability, chain rules, implicit differentiation. Extrema and Lagrange multipliers. Multiple integrals, change of variables.====== Linear Algebra:Axioms for vector spaces. Linear independence, bases and dimension. Matrices and linear transformations. Change of basis. Eigenvectors and eigenvalues, diagonalization and its applications (including linear differential equations). Orthogonality, Gram-Schmidt process. ",teacher:"MR SL Masinga and SB Ndwandwe", year: 2, price: 250 },
    { code: "MATH235", name: "Classical mechanics", description: "Rigorous treatment of real numbers and limits", teacher: "MR SL Masinga and SB ndwandwe", year: 2, price: 250 },
    { code: "MATH236", name: "discrete Maths", description: "", teacher: "Mr SB Ndwandwe", year: 2, price: 250 },
    { code: "MATH243", name: "introductions to numerical analysis", description: "", teacher: "Mr SL makhathini ,SB Ndwandwe and SL Masinga ", year: 2, price: 250 },
    { code: "MATH251", name: "further calculus", description: "", teacher: "Mr SL masinga and SB ndwandwe", year: 2, price: 250 },
    { code: "COMP200", name: "introduction to OOP", description: "Ordinary", teacher: "Mr I kunene and M Matimelo e ", year: 2, price: 250 },
    { code: "COMP201", name: "Data Structures and Algorithm", description: "", teacher: "Mr M Matimelo e ", year: 2, price: 250 },
    { code: "STAT230", name: "Probability Theory", description: "", teacher: "Mr S Masinga and Mr S Mhlongo", year: 2, price: 250 },
    { code: "STAT240", name: "Statistical Methods II", description: "", teacher: "Tutor to be announced ", year: 2, price: 250 }
  ]
};

const MODULE_PRICE = 250; // Each module costs R250

// ========== DEV MODE SETTINGS ==========
let devMode = localStorage.getItem('ThriveAcademy_devMode') === 'true' || false;
let adminMode = localStorage.getItem('ThriveAcademy_adminMode') || 'admin'; // Can be 'admin', 'teacher', or 'student'

// User management
let currentUser = null;
let users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
let materials = JSON.parse(localStorage.getItem('ThriveAcademy_materials')) || [];
let pendingEnrollments = JSON.parse(localStorage.getItem('ThriveAcademy_pending')) || {};

// Teacher module selection
let teacherSelectedModules = [];

// ========== DEV MODE FUNCTIONS ==========
function toggleDevMode() {
  devMode = !devMode;
  localStorage.setItem('ThriveAcademy_devMode', devMode);
  
  console.log(`Dev Mode: ${devMode ? 'ON' : 'OFF'}`);
  
  if (devMode) {
    showDevModeIndicator();
    
    // Show dev controls in admin panel
    const devControls = document.getElementById('devModeControls');
    if (devControls) {
      devControls.classList.remove('hidden');
    }
  } else {
    hideDevModeIndicator();
    
    // Hide dev controls
    const devControls = document.getElementById('devModeControls');
    if (devControls) {
      devControls.classList.add('hidden');
    }
  }
  
  updateHomePage();
  updateCoursesDisplay();
  
  // If we're in admin panel, update it
  if (currentUser && currentUser.userType === 'admin') {
    updateAdminPanelForMode();
  }
}

function showDevModeIndicator() {
  // Remove existing indicator if any
  hideDevModeIndicator();
  
  // Create dev mode indicator
  const indicator = document.createElement('div');
  indicator.id = 'devModeIndicator';
  indicator.className = 'dev-mode-indicator';
  indicator.innerHTML = `
    <i class="fas fa-code"></i>
    <span>DEV MODE ACTIVE</span>
    <span>Admin Mode: ${adminMode.toUpperCase()}</span>
    <span>All Modules Available</span>
  `;
  
  // Add to page
  document.body.insertBefore(indicator, document.body.firstChild);
  
  // Adjust nav position for desktop
  if (window.innerWidth > 768) {
    document.getElementById('nav').style.top = '30px';
  }
}

function hideDevModeIndicator() {
  const indicator = document.getElementById('devModeIndicator');
  if (indicator) {
    indicator.remove();
  }
  document.getElementById('nav').style.top = '0';
}

function switchAdminMode(newMode) {
  adminMode = newMode;
  localStorage.setItem('ThriveAcademy_adminMode', adminMode);
  
  console.log(`Switched to ${adminMode} mode`);
  
  // Update dev mode indicator
  const indicator = document.getElementById('devModeIndicator');
  if (indicator) {
    indicator.innerHTML = `
      <i class="fas fa-code"></i>
      <span>DEV MODE ACTIVE</span>
      <span>Admin Mode: ${adminMode.toUpperCase()}</span>
      <span>STAT Modules: Enabled</span>
    `;
  }
  
  // Update current mode display
  const modeDisplay = document.getElementById('currentModeDisplay');
  if (modeDisplay) {
    modeDisplay.textContent = adminMode.charAt(0).toUpperCase() + adminMode.slice(1);
  }
  
  // Update mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.mode === adminMode) {
      btn.classList.add('active');
    }
  });
  
  // Show the appropriate view based on mode
  if (currentUser && currentUser.userType === 'admin') {
    if (adminMode === 'admin') {
      showAdminPanel();
    } else if (adminMode === 'teacher' || adminMode === 'student') {
      showDashboard();
    }
  }
}

function updateUIForAdminMode() {
  if (!devMode || !currentUser || currentUser.userType !== 'admin') return;
  
  // Update the user's displayed role based on mode
  const userRole = document.getElementById('userRole');
  if (userRole) {
    userRole.textContent = adminMode.charAt(0).toUpperCase() + adminMode.slice(1);
  }
  
  // Show/hide appropriate dashboard sections
  if (adminMode === 'teacher') {
    document.getElementById('teacherDashboard').classList.remove('hidden');
    document.getElementById('studentDashboard').classList.add('hidden');
    loadTeacherCourses();
    
    // Add "Back to Admin" button to teacher dashboard
    addBackToAdminButton();
  } else if (adminMode === 'student') {
    document.getElementById('teacherDashboard').classList.add('hidden');
    document.getElementById('studentDashboard').classList.remove('hidden');
    loadStudentCourses();
    
    // Add "Back to Admin" button to student dashboard
    addBackToAdminButton();
  } else {
    // Admin mode - show admin panel
    document.getElementById('teacherDashboard').classList.add('hidden');
    document.getElementById('studentDashboard').classList.add('hidden');
    
    // Remove "Back to Admin" button if it exists
    removeBackToAdminButton();
  }
}

// Add "Back to Admin" button function
function addBackToAdminButton() {
  // Remove existing button if it exists
  removeBackToAdminButton();
  
  // Create back to admin button
  const backButton = document.createElement('button');
  backButton.className = 'back-to-admin-btn';
  backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Admin Panel';
  backButton.onclick = () => {
    switchAdminMode('admin');
    showAdminPanel();
  };
  
  // Add button to user info section
  const userInfo = document.querySelector('.user-info');
  if (userInfo) {
    userInfo.appendChild(backButton);
  }
}

function removeBackToAdminButton() {
  const existingButton = document.querySelector('.back-to-admin-btn');
  if (existingButton) {
    existingButton.remove();
  }
}
function updateAdminPanelForMode() {
  const devControls = document.getElementById('devModeControls');
  if (devControls) {
    if (devMode && currentUser && currentUser.userType === 'admin') {
      devControls.classList.remove('hidden');
      
      // Update current mode display
      const modeDisplay = document.getElementById('currentModeDisplay');
      if (modeDisplay) {
        modeDisplay.textContent = adminMode.charAt(0).toUpperCase() + adminMode.slice(1);
      }
      
      // Set active mode button
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === adminMode) {
          btn.classList.add('active');
        }
      });
    } else {
      devControls.classList.add('hidden');
    }
  }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
  
  // Check if user is logged in
  const savedUser = localStorage.getItem('ThriveAcademy_currentUser');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    
    // If admin, update admin mode UI
    if (currentUser.userType === 'admin') {
      updateAdminPanelForMode();
      updateUIForAdminMode();
    }
  } else {
    // For non-logged in users, update home page
    updateHomePage();
    // Load materials from Firestore
    loadMaterialsFromFirestore();
  }
  
  // Initialize dev mode if enabled
  if (devMode) {
    showDevModeIndicator();
  }
  
  // Hide teacher/student fields initially
  document.getElementById('teacherFields').classList.add('hidden');
  document.getElementById('studentFields').classList.add('hidden');
  document.getElementById('studentModulesField').classList.add('hidden');
  
  // Setup year level change for student modules
  document.getElementById('yearLevel').addEventListener('change', loadModulesForYear);
  
  // Setup user type change
  document.getElementById('userType').addEventListener('change', handleUserTypeChange);
  
  // Home page buttons
  document.getElementById('homeRegisterBtn').addEventListener('click', (e) => {
    e.preventDefault();
    showForm(document.getElementById('registerForm'));
  });
  
  document.getElementById('homeLearnMoreBtn').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
  });
    // ========== ADMIN BUTTON SETUP ==========
  // Enroll Student button
  document.getElementById('enrollStudentBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('enrollmentForm').classList.remove('hidden');
    document.getElementById('studentsList').classList.add('hidden');
    document.getElementById('paymentVerification').classList.add('hidden');
    loadCourseOptionsForAdmin();
  });
  
  // View Students button
  document.getElementById('viewStudentsBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('enrollmentForm').classList.add('hidden');
    document.getElementById('studentsList').classList.remove('hidden');
    document.getElementById('paymentVerification').classList.add('hidden');
    loadStudentsForAdmin();
  });
  
  // Verify Payment button
  document.getElementById('verifyPaymentBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('enrollmentForm').classList.add('hidden');
    document.getElementById('studentsList').classList.add('hidden');
    document.getElementById('paymentVerification').classList.remove('hidden');
    loadStudentsForAdmin();
  });
  
  // Create Teacher button
  document.getElementById('createTeacherBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('teacherCreationForm').classList.remove('hidden');
    document.getElementById('studentsList').classList.add('hidden');
    document.getElementById('enrollmentForm').classList.add('hidden');
    document.getElementById('paymentVerification').classList.add('hidden');
    
    // Load teacher modules for selection
    const container = document.getElementById('adminTeacherModules');
    if (container) {
      container.innerHTML = '';
      let allCourses = [...coursesData[1], ...coursesData[2]];
      
      allCourses.forEach(course => {
        const option = document.createElement('div');
        option.className = 'teacher-module-option';
        option.dataset.code = course.code;
        option.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${course.code}</strong>
              <div style="color: #6b7280; font-size: 0.9rem;">${course.name}</div>
              <div style="font-size: 0.8rem; color: #4f46e5;">Year ${course.year}</div>
            </div>
            <div style="color: #6b7280; font-size: 0.8rem;">Click to select</div>
          </div>
        `;
        
        option.addEventListener('click', function() {
          const index = adminTeacherSelectedModules.indexOf(course.code);
          if (index === -1) {
            adminTeacherSelectedModules.push(course.code);
            this.classList.add('selected');
            this.querySelector('div > div:last-child').innerHTML = '✓ Selected';
            this.querySelector('div > div:last-child').style.color = '#10b981';
          } else {
            adminTeacherSelectedModules.splice(index, 1);
            this.classList.remove('selected');
            this.querySelector('div > div:last-child').innerHTML = 'Click to select';
            this.querySelector('div > div:last-child').style.color = '#6b7280';
          }
          document.getElementById('adminSelectedCount').textContent = adminTeacherSelectedModules.length;
        });
        
        container.appendChild(option);
      });
    }
  });
  
  // Cancel Enrollment button
  document.getElementById('cancelEnrollmentBtn2')?.addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('enrollmentForm').classList.add('hidden');
    selectedStudentForEnrollment = null;
    selectedCourseForEnrollment = null;
  });
  
  // Cancel Teacher Creation button
  document.getElementById('cancelTeacherBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('teacherCreationForm').classList.add('hidden');
    adminTeacherSelectedModules = [];
    document.getElementById('adminSelectedCount').textContent = '0';
  });
  
  // Confirm Enrollment button
  document.getElementById('confirmEnrollmentBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    
    const studentId = document.getElementById('studentSelect').value;
    const selectedOption = document.querySelector('.enrollment-option.selected');
    
    if (!studentId) {
      alert('Please select a student');
      return;
    }
    
    if (!selectedOption) {
      alert('Please select a course');
      return;
    }
    
    const courseCode = selectedOption.dataset.course;
    
    // Find student in users array
    const student = users.find(u => u.id === studentId || u.email === studentId);
    if (!student) {
      alert('Student not found');
      return;
    }
    
    // Add course to student
    if (!student.enrolledCourses) {
      student.enrolledCourses = [];
    }
    
    if (!student.enrolledCourses.includes(courseCode)) {
      student.enrolledCourses.push(courseCode);
      
      // Find course price
      let coursePrice = 250;
      for (const year in coursesData) {
        const course = coursesData[year].find(c => c.code === courseCode);
        if (course) {
          coursePrice = course.price;
          break;
        }
      }
      
      student.pendingPayment = (student.pendingPayment || 0) + coursePrice;
      
      // Update localStorage
      localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
      
      // Also update ThriveAcademy_students
      const storedStudents = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
      const studentIndex = storedStudents.findIndex(s => s.id === studentId || s.email === studentId);
      if (studentIndex !== -1) {
        storedStudents[studentIndex] = student;
        localStorage.setItem('ThriveAcademy_students', JSON.stringify(storedStudents));
      }
      
      alert(`✅ Enrolled ${student.fullName} in ${courseCode}!\nAdded R${coursePrice} to pending payment.`);
      document.getElementById('enrollmentForm').classList.add('hidden');
      document.getElementById('studentSelect').value = '';
      document.querySelectorAll('.enrollment-option').forEach(o => o.classList.remove('selected'));
    } else {
      alert(`${student.fullName} is already enrolled in ${courseCode}`);
    }
  });
  // Dev mode toggle button
  document.getElementById('toggleDevModeBtn').addEventListener('click', (e) => {
    e.preventDefault();
    toggleDevMode();
  });
  
  // Mode switcher buttons - FIXED
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('mode-btn')) {
      e.preventDefault();
      const newMode = e.target.dataset.mode;
      switchAdminMode(newMode);
    }
  });
  
  // Add window resize handler for responsive adjustment
  window.addEventListener('resize', function() {
    if (devMode) {
      const indicator = document.getElementById('devModeIndicator');
      if (indicator && window.innerWidth <= 768) {
        // On mobile, nav should be at top (dev indicator is separate)
        document.getElementById('nav').style.top = '0';
      } else if (indicator && window.innerWidth > 768) {
        // On desktop, nav should be below dev indicator
        document.getElementById('nav').style.top = '30px';
      }
    }
  });
   
  setupNavigation();
});

// ========== USER TYPE CHANGE HANDLER ==========
function handleUserTypeChange() {
  const userType = document.getElementById('userType').value;
  const teacherFields = document.getElementById('teacherFields');
  const studentFields = document.getElementById('studentFields');
  const studentModulesField = document.getElementById('studentModulesField');

  teacherFields.classList.add('hidden');
  studentFields.classList.add('hidden');
  studentModulesField.style.display = 'none';

  if (userType === 'teacher') {
    teacherFields.classList.remove('hidden');
    teacherSelectedModules = [];
    updateTeacherSelectionCount();
    loadTeacherModulesForSelection();
  }

  if (userType === 'student') {
    studentFields.classList.remove('hidden');
  }
}


// ========== TEACHER MODULE SELECTION ==========
function loadTeacherModulesForSelection() {
  const container = document.getElementById('teacherModulesContainer');
  if (!container) return;
  
  container.innerHTML = '<p style="padding: 10px; text-align: center; color: #6b7280;">Loading modules...</p>';
  
  // Combine all modules from both years
  let allCourses = [];
  allCourses = [...coursesData[1], ...coursesData[2]];
  
  // Clear container
  container.innerHTML = '';
  
  if (allCourses.length === 0) {
    container.innerHTML = '<p style="padding: 10px; text-align: center; color: #6b7280;">No modules available</p>';
    return;
  }
  
  allCourses.forEach(course => {
    const option = document.createElement('div');
    option.className = 'teacher-module-option';
    option.dataset.code = course.code;
    option.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>${course.code}</strong>
          <div style="color: #6b7280; font-size: 0.9rem;">${course.name}</div>
          <div style="font-size: 0.8rem; color: #4f46e5;">Year ${course.year}</div>
        </div>
        <div style="color: #6b7280; font-size: 0.8rem;">Click to select</div>
      </div>
    `;
    
    option.addEventListener('click', function() {
      toggleTeacherModuleSelection(course.code, this);
    });
    
    container.appendChild(option);
  });
}
function toggleTeacherModuleSelection(courseCode, element) {
  const index = teacherSelectedModules.indexOf(courseCode);
  
  if (index === -1) {
    // Add module with generous limit
    if (teacherSelectedModules.length < 10) {
      teacherSelectedModules.push(courseCode);
      element.classList.add('selected');
      
      // Update visual feedback
      const statusDiv = element.querySelector('div > div:last-child');
      if (statusDiv) {
        statusDiv.innerHTML = '✓ Selected';
        statusDiv.style.color = '#10b981';
      }
    } else {
      alert('Maximum of 10 modules allowed for teachers.');
      return;
    }
  } else {
    // Remove module
    teacherSelectedModules.splice(index, 1);
    element.classList.remove('selected');
    
    // Update visual feedback
    const statusDiv = element.querySelector('div > div:last-child');
    if (statusDiv) {
      statusDiv.innerHTML = 'Click to select';
      statusDiv.style.color = '#6b7280';
    }
  }
  
  updateTeacherSelectionCount();
}

function updateTeacherSelectionCount() {
  document.getElementById('selectedCount').textContent = teacherSelectedModules.length;
}

// ========== HOME PAGE LOGIC ==========
function updateHomePage() {
  const homeModulesSection = document.getElementById('homeModulesSection');
  
  if (!currentUser) {
    // Non-logged in users: Show welcome message, no modules
    homeModulesSection.innerHTML = `
      <div style="text-align: center; padding: 60px 5%;">
        <h2 class="section-title">Discover Our University Modules</h2>
        <p style="margin: 20px auto 30px; color: #6b7280; max-width: 600px;">
          Register or login to browse and enroll in our comprehensive university courses. 
          Choose from 1st or 2nd year modules based on your needs.
        </p>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
          <a href="#" class="btn" onclick="showForm(document.getElementById('loginForm'))">
            <i class="fas fa-sign-in-alt"></i> Login
          </a>
          <a href="#" class="btn btn-success" onclick="showForm(document.getElementById('registerForm'))">
            <i class="fas fa-user-plus"></i> Register Now
          </a>
        </div>
      </div>
    `;
  } else if (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) {
    // Students: Show only their enrolled modules
    const userToShow = currentUser.userType === 'admin' ? getMockStudentForAdmin() : currentUser;
    
    // Get enrolled courses with their details
    let enrolledCoursesWithDetails = [];
    
    if (userToShow.enrolledCourses && userToShow.enrolledCourses.length > 0) {
      // Get course details for all enrolled courses
      for (const year in coursesData) {
        const coursesForYear = coursesData[year];
        userToShow.enrolledCourses.forEach(courseCode => {
          const course = coursesForYear.find(c => c.code === courseCode);
          if (course) {
            enrolledCoursesWithDetails.push(course);
          }
        });
      }
    }
    
    if (enrolledCoursesWithDetails.length > 0) {
      homeModulesSection.innerHTML = `
        <div style="padding: 0 5% 40px;">
          <h2 class="section-title">Your Enrolled Modules</h2>
          <p style="text-align: center; margin-bottom: 30px; color: #6b7280;">
            You are enrolled in ${enrolledCoursesWithDetails.length} module(s)
            ${devMode ? ' <span class="dev-tag">DEV MODE</span>' : ''}
          </p>
          <div class="courses-grid">
            ${enrolledCoursesWithDetails.map(course => {
              const courseMaterials = materials.filter(m => m.courseCode === course.code);
              return `
              <div class="course-card">
                <div class="course-header">
                  <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
                  <p>${course.name}</p>
                </div>
                <div class="course-body">
                  <p>${course.description}</p>
                  <p class="course-teacher">Teacher: ${course.teacher}</p>
                  <p><strong>Available Materials:</strong> ${courseMaterials.length}</p>
                  <button class="btn" onclick="openCourseMaterials('${course.code}')">
                    <i class="fas fa-folder-open"></i> View Materials
                  </button>
                </div>
              </div>
            `}).join('')}
          </div>
        </div>
      `;
    } else {
      homeModulesSection.innerHTML = `
        <div style="text-align: center; padding: 60px 5%; background: white; border-radius: 10px; margin: 40px 5%; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
          <h2>No Modules Enrolled Yet</h2>
          <p style="margin: 20px 0 30px; color: #6b7280;">Browse our courses and enroll to start learning!</p>
          <a href="#" class="btn" onclick="document.getElementById('courses').scrollIntoView({behavior:'smooth'})">
            <i class="fas fa-book"></i> Browse Courses
          </a>
        </div>
      `;
    }
  } else if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
    // Teachers: Show all modules (for reference) - show both years
    homeModulesSection.innerHTML = `
      <div style="padding: 0 5% 40px;">
        <h2 class="section-title">All University Modules</h2>
        <p style="text-align: center; margin-bottom: 30px; color: #6b7280;">
          As a teacher, you can view all available modules
          ${devMode ? ' <span class="dev-tag">DEV MODE</span>' : ''}
        </p>
        
        <h3 style="margin: 30px 0 20px; color: #4f46e5;">1st Year Modules</h3>
        <div class="courses-grid">
          ${coursesData[1].map(course => `
            <div class="course-card">
              <div class="course-header">
                <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
                <p>${course.name}</p>
              </div>
              <div class="course-body">
                <p>${course.description}</p>
                <p class="course-teacher">Teacher: ${course.teacher}</p>
                ${(currentUser.specialization && currentUser.specialization.includes(course.code)) || (currentUser.userType === 'admin' && adminMode === 'teacher') ? `
                  <button class="btn btn-success" onclick="openAddMaterial('${course.code}')">
                    <i class="fas fa-plus"></i> Add Material
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
        
        <h3 style="margin: 30px 0 20px; color: #4f46e5;">2nd Year Modules</h3>
        <div class="courses-grid">
          ${coursesData[2].map(course => `
            <div class="course-card">
              <div class="course-header">
                <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
                <p>${course.name}</p>
              </div>
              <div class="course-body">
                <p>${course.description}</p>
                <p class="course-teacher">Teacher: ${course.teacher}</p>
                ${(currentUser.specialization && currentUser.specialization.includes(course.code)) || (currentUser.userType === 'admin' && adminMode === 'teacher') ? `
                  <button class="btn btn-success" onclick="openAddMaterial('${course.code}')">
                    <i class="fas fa-plus"></i> Add Material
                  </button>
                ` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  } else if (currentUser.userType === 'admin' && adminMode === 'admin') {
    // Admin: Show all modules
    homeModulesSection.innerHTML = `
      <div style="padding: 0 5% 40px;">
        <h2 class="section-title">All Modules (Admin View)</h2>
        
        <div class="year-navigation" style="margin-bottom: 30px;">
          <button class="year-btn active" onclick="loadHomeCourses(1)">1st Year</button>
          <button class="year-btn" onclick="loadHomeCourses(2)">2nd Year</button>
        </div>
        
        <div class="courses-grid" id="adminHomeCourses">
          ${coursesData[1].map(course => `
            <div class="course-card">
              <div class="course-header">
                <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
                <p>${course.name}</p>
              </div>
              <div class="course-body">
                <p>${course.description}</p>
                <p class="course-teacher">Teacher: ${course.teacher}</p>
                <p><strong>Price:</strong> R${course.price}</p>
                ${devMode && course.dev ? '<p style="color: #ff6b6b;"><i class="fas fa-code"></i> Dev Mode Module</p>' : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
}

function getMockStudentForAdmin() {
  // Return a mock student object for admin in student mode
  return {
    enrolledCourses: currentUser.enrolledCourses || [],
    yearLevel: 'mixed'
  };
}

function loadHomeCourses(year) {
  const container = document.getElementById('adminHomeCourses');
  if (container) {
    container.innerHTML = coursesData[year].map(course => `
      <div class="course-card">
        <div class="course-header">
          <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
          <p>${course.name}</p>
        </div>
        <div class="course-body">
          <p>${course.description}</p>
          <p class="course-teacher">Teacher: ${course.teacher}</p>
          <p><strong>Price:</strong> R${course.price}</p>
          ${devMode && course.dev ? '<p style="color: #ff6b6b;"><i class="fas fa-code"></i> Dev Mode Module</p>' : ''}
        </div>
      </div>
    `).join('');
    
    // Update active button
    document.querySelectorAll('#homeModulesSection .year-navigation .year-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
  }
}

// ========== COURSE DISPLAY LOGIC ==========
function updateCoursesDisplay() {
  const yearNav = document.getElementById('yearNavigation');
  const instruction = document.getElementById('coursesInstruction');
  
  if (currentUser) {
    if (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) {
      // Students can see both years' courses for enrollment
      yearNav.classList.remove('hidden');
      instruction.textContent = 'Select a year to view and enroll in modules';
    } else if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
      // Teachers see all courses but only can add materials to their modules
      yearNav.classList.remove('hidden');
      instruction.textContent = 'Select a year to view available modules';
    } else if (currentUser.userType === 'admin' && adminMode === 'admin') {
      // Admin sees all courses
      yearNav.classList.remove('hidden');
      instruction.textContent = 'Select a year to view available modules (Admin View)';
    }
  } else {
    // Non-logged in users see all courses
    yearNav.classList.remove('hidden');
    instruction.textContent = 'Select a year to view available modules';
  }
}

// ========== YEAR NAVIGATION ==========
document.querySelectorAll('.year-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Allow year navigation for all users
    document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const year = parseInt(btn.dataset.year);
    loadCourses(year);
  });
});

function loadCourses(year) {
  const coursesContainer = document.getElementById('courses-container');
  coursesContainer.innerHTML = '';
  const courses = coursesData[year] || [];
  
  courses.forEach(course => {
    // Check if user is teacher of this course
    const isTeacher = (currentUser && 
                      currentUser.userType === 'teacher' && 
                      currentUser.specialization && 
                      currentUser.specialization.includes(course.code)) ||
                     (currentUser && 
                      currentUser.userType === 'admin' && 
                      adminMode === 'teacher');
    
    // Check if student is enrolled in this course
    const isEnrolled = currentUser && 
                       ((currentUser.userType === 'student' && 
                         currentUser.enrolledCourses &&
                         currentUser.enrolledCourses.includes(course.code)) ||
                        (currentUser.userType === 'admin' && 
                         adminMode === 'student' &&
                         currentUser.enrolledCourses &&
                         currentUser.enrolledCourses.includes(course.code)));
    
    // Load materials for this course
    const courseMaterials = materials.filter(m => m.courseCode === course.code);
    
    // Check if user can view materials preview
    let canViewMaterialsPreview = false;
    
    if (currentUser) {
      if (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) {
        canViewMaterialsPreview = isEnrolled;
      } else if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
        canViewMaterialsPreview = isTeacher || currentUser.userType === 'admin';
      } else if (currentUser.userType === 'admin' && adminMode === 'admin') {
        canViewMaterialsPreview = true;
      }
    }
    
   const courseCard = document.createElement('div');
courseCard.className = 'course-card';
courseCard.style.cursor = 'pointer';
courseCard.onclick = (e) => {
    // Don't do anything if clicking on buttons
    if (e.target.closest('button')) {
        return;
    }
    
    // If user is logged in but NOT enrolled, show access code modal
    if (currentUser && 
        (currentUser.userType === 'student' || 
         (currentUser.userType === 'admin' && adminMode === 'student')) && 
        !isEnrolled) {
        showAccessCodeLoginModal(course.code);
    }
    // If user is NOT logged in, show access code modal
    else if (!currentUser) {
        showAccessCodeLoginModal(course.code);
    }
    // Otherwise (teacher, admin, or enrolled student), show materials
    else {
        openCourseMaterials(course.code);
    }
};
    
    courseCard.innerHTML = `
      <div class="course-header">
        <h3>${course.code} ${devMode ? '<span class="dev-tag">DEV</span>' : ''} <span class="year-badge">Year ${course.year}</span></h3>
        <p>${course.name}</p>
      </div>
      <div class="course-price">R${course.price}</div>
      <div class="course-body">
        <p>${course.description}</p>
        <p class="course-teacher">Teacher: ${course.teacher}</p>
        <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
          <i class="fas fa-folder" style="color: #4f46e5;"></i>
          <span style="color: #6b7280; font-size: 0.9rem;">
            ${canViewMaterialsPreview ? `${courseMaterials.length} material${courseMaterials.length !== 1 ? 's' : ''} available` : 'Enroll to access materials'}
          </span>
          ${!currentUser ? `<span style="font-size: 0.8rem; color: #ef4444;">(Login required)</span>` : ''}
        </div>
        
        ${canViewMaterialsPreview && courseMaterials.length > 0 ? `
          <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 6px;">
            <p style="margin: 0 0 5px 0; font-size: 0.9rem; color: #6b7280;">Recent materials:</p>
            <div style="font-size: 0.85rem; color: #6b7280;">
              ${courseMaterials.slice(0, 2).map(m => `
                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                  <i class="fas ${getMaterialIcon(m.type)}" style="font-size: 0.8rem;"></i>
                  <span>${m.title}</span>
                </div>
              `).join('')}
              ${courseMaterials.length > 2 ? `<div>...and ${courseMaterials.length - 2} more</div>` : ''}
            </div>
          </div>
        ` : ''}
        
        ${!currentUser ? `
          <div style="background: #fef2f2; padding: 10px; border-radius: 6px; margin: 10px 0;">
            <p style="color: #dc2626; font-size: 0.9rem; margin: 0 0 5px 0;">
              <i class="fas fa-lock"></i> Access Required
            </p>
            <p style="color: #991b1b; font-size: 0.85rem; margin: 0;">
              • Login to enroll • Or use access code
            </p>
          </div>
        ` : currentUser.userType === 'student' && !isEnrolled ? `
          <div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 10px 0;">
            <p style="color: #92400e; font-size: 0.9rem; margin: 0 0 5px 0;">
              <i class="fas fa-info-circle"></i> You need access to view ${courseMaterials.length} material${courseMaterials.length !== 1 ? 's' : ''}
            </p>
            <p style="color: #78350f; font-size: 0.85rem; margin: 0;">
              • Enroll (R${course.price}) • Or use access code
            </p>
          </div>
        ` : ''}
        
        ${devMode ? '<p style="color: #ff6b6b; font-size: 0.9rem;"><i class="fas fa-code"></i> Dev Mode Active</p>' : ''}
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          ${isTeacher ? `
    <button class="btn btn-success" onclick="(function(e){ e.stopPropagation(); e.preventDefault(); openAddMaterial('${course.code}'); })(event)">
        <i class="fas fa-plus"></i> Add Material
    </button>
` : ''}
          
  ${currentUser && (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) && !isEnrolled ? `
    <button class="btn" onclick="event.stopPropagation(); selectCourseForPayment('${course.code}', ${course.price});" style="width: 100%;">
        <i class="fas fa-shopping-cart"></i> Enroll (R${course.price})
    </button>
` : ''}
          
          ${currentUser && (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) && isEnrolled ? `
            <button class="btn btn-secondary" disabled onclick="event.stopPropagation();">
              <i class="fas fa-check"></i> Enrolled
            </button>
          ` : ''}
          
 ${!currentUser ? `
    <button class="btn" onclick="event.stopPropagation(); showForm(document.getElementById('loginForm'));" style="width: 100%;">
        <i class="fas fa-sign-in-alt"></i> Login to Enroll
    </button>
` : ''}
        </div>
      </div>
    `;
    
    coursesContainer.appendChild(courseCard);
  });
}


// ========== SIMPLE FIREBASE-ONLY ACCESS CODE CHECK ==========
async function checkAccessCode(accessCode, courseCode, submitBtn, originalText, errorDiv) {
    console.log("🔍 Checking access code in Firebase:", accessCode, "for course:", courseCode);
    
    // Clear any previous errors
    if (errorDiv) {
        errorDiv.textContent = '';
        errorDiv.classList.remove('show');
    }
    
    // Validate input
    const cleanAccessCode = accessCode.toUpperCase().trim();
    if (!cleanAccessCode || cleanAccessCode.length !== 6) {
        if (errorDiv) {
            errorDiv.textContent = 'Please enter a valid 6-digit access code';
            errorDiv.classList.add('show');
        } else {
            alert("Please enter a valid 6-digit access code");
        }
        if (submitBtn) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        return;
    }
    
    try {
        // STEP 1: Check Firebase
        if (!window.db) {
            throw new Error("Firebase not connected. Please check internet connection.");
        }
        
        console.log("Querying Firebase for access code:", cleanAccessCode);
        
        // Query the access_codes collection
        const accessQuery = query(
            collection(db, "access_codes"), 
            where("accessCode", "==", cleanAccessCode)
        );
        
        // Get the snapshot
        const snapshot = await getDocs(accessQuery);
        
        // Check if found
        if (snapshot.empty) {
            throw new Error('Invalid access code. Please check your code and try again.');
        }
        
        // STEP 2: Found in Firebase - Get the data
        const doc = snapshot.docs[0];
        const accessData = doc.data();
        
        console.log("✅ Access code found in Firebase for:", accessData.studentEmail);
        console.log("Enrolled courses in access code:", accessData.enrolledCourses);
        console.log("Requested course:", courseCode);
        
        // STEP 3: Create student object
        const student = {
            id: doc.id,
            firestoreId: doc.id,
            fullName: accessData.studentName,
            email: accessData.studentEmail,
            userType: 'student',
            yearLevel: 'mixed',
            enrolledCourses: accessData.enrolledCourses || [],
            accessCode: cleanAccessCode,
            status: 'active',
            firebaseUser: true,
            createdAt: accessData.createdAt || new Date().toISOString(),
            pendingPayment: accessData.totalPrice || (accessData.enrolledCourses?.length || 0) * 250
        };
        
        // STEP 4: Check if this code includes the requested course
        if (courseCode) {
            const cleanCourseCode = courseCode.replace(/\s+/g, '').toUpperCase();
            const cleanEnrolledCourses = (student.enrolledCourses || []).map(c => 
                c.replace(/\s+/g, '').toUpperCase().trim()
            );
            
            console.log("Checking if", cleanCourseCode, "is in", cleanEnrolledCourses);
            
            // Make it case-insensitive and trim spaces
            const found = cleanEnrolledCourses.some(course => 
                course === cleanCourseCode || 
                course.includes(cleanCourseCode) ||
                cleanCourseCode.includes(course)
            );
            
            if (!found) {
                const enrolledList = student.enrolledCourses.join(', ') || 'No modules yet';
                throw new Error(`This access code doesn't include ${courseCode}.\n\nYour enrolled modules: ${enrolledList}`);
            }
        }
        
        // STEP 5: SUCCESS - Login the student
        console.log("✅ Access granted! Logging in...");
        
        // Set as current user
        currentUser = student;
        localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
        
        // Also save to local storage for faster future access
        const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
        const existingIndex = students.findIndex(s => s.accessCode === cleanAccessCode);
        
        if (existingIndex !== -1) {
            students[existingIndex] = student;
        } else {
            students.push(student);
        }
        localStorage.setItem('ThriveAcademy_students', JSON.stringify(students));
        
        // STEP 6: Reset button if provided
        if (submitBtn) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        // STEP 7: Update UI
        updateUIForUser();
        updateHomePage();
        updateCoursesDisplay();
        
        // STEP 8: Show success
        let successMsg = `✅ Welcome ${student.fullName}!\n\n`;
        
        if (courseCode) {
            successMsg += `You now have access to ${courseCode}.\n\n`;
        }
        
        successMsg += `📚 Your enrolled modules:\n`;
        if (student.enrolledCourses.length > 0) {
            student.enrolledCourses.forEach((course, index) => {
                successMsg += `${index + 1}. ${course}\n`;
            });
        } else {
            successMsg += `No modules yet (contact admin)\n`;
        }
        
        successMsg += `\n💰 Pending payment: R${student.pendingPayment || 0}`;
        successMsg += `\n✅ Cross-device access enabled`;
        
        alert(successMsg);
        
        // STEP 9: Close modal and show dashboard
        closeAccessCodeModal();
        setTimeout(() => {
            showDashboard();
        }, 500);
        
        return true;
        
    } catch (error) {
        console.error("Access code error:", error);
        
        // Reset button if provided
        if (submitBtn) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        // Show error
        if (errorDiv) {
            if (error.message.includes('Firebase')) {
                errorDiv.textContent = 'Connection error. Please check internet and try again.';
            } else {
                errorDiv.textContent = error.message;
            }
            errorDiv.classList.add('show');
            if (errorDiv.scrollIntoView) {
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            alert(`❌ ${error.message}`);
        }
        
        return false;
    }
}
// ========== SIMPLIFIED SUBMIT FUNCTION ==========
function submitAccessCodeFromModal() {
    const accessCodeInput = document.getElementById('accessCodeInput');
    const courseCodeInput = document.getElementById('accessCodeForCourse');
    const errorDiv = document.getElementById('accessCodeError');
    const submitBtn = document.getElementById('submitAccessCodeBtn');
    
    if (!accessCodeInput || !submitBtn) return;
    
    const accessCode = accessCodeInput.value;
    const courseCode = courseCodeInput ? courseCodeInput.value : null;
    
    // Show loading
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    // Call the simple Firebase-only check
    checkAccessCode(accessCode, courseCode, submitBtn, originalText, errorDiv);
}

// ========== CONNECT THE SUBMIT BUTTON ==========
// Add event listener for submit button
document.getElementById('submitAccessCodeBtn').addEventListener('click', submitAccessCodeFromModal);
// ========== SIMPLIFIED SUBMIT FUNCTION ==========
function submitAccessCodeFromModal() {
    const accessCodeInput = document.getElementById('accessCodeInput');
    const courseCodeInput = document.getElementById('accessCodeForCourse');
    const errorDiv = document.getElementById('accessCodeError');
    const submitBtn = document.getElementById('submitAccessCodeBtn');
    
    if (!accessCodeInput || !submitBtn) return;
    
    const accessCode = accessCodeInput.value;
    const courseCode = courseCodeInput ? courseCodeInput.value : null;
    
    // Show loading
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    // Call the simple Firebase-only check
    checkAccessCode(accessCode, courseCode, submitBtn, originalText, errorDiv);
}

// ========== QUICK ACCESS CODE PROMPT (for course cards) ==========
function quickAccessCodeLogin(courseCode) {
    // Ask for access code
    const accessCode = prompt(`Enter your 6-digit access code to access ${courseCode}:`);
    
    if (!accessCode) {
        return; // User cancelled
    }
    
    const cleanCode = accessCode.trim().toUpperCase();
    
    if (cleanCode.length !== 6) {
        alert("Please enter a valid 6-digit access code");
        return;
    }
    
    // Show loading
    const loadingMsg = document.createElement('div');
    loadingMsg.style.position = 'fixed';
    loadingMsg.style.top = '50%';
    loadingMsg.style.left = '50%';
    loadingMsg.style.transform = 'translate(-50%, -50%)';
    loadingMsg.style.background = 'white';
    loadingMsg.style.padding = '20px';
    loadingMsg.style.borderRadius = '10px';
    loadingMsg.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
    loadingMsg.style.zIndex = '99999';
    loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking access code...';
    document.body.appendChild(loadingMsg);
    
    // Check the access code
    checkAccessCode(cleanCode, courseCode, null, null, null)
        .finally(() => {
            // Remove loading message
            if (loadingMsg.parentNode) {
                loadingMsg.remove();
            }
        });
}
// ========== STUDENT MODULE SELECTION FOR REGISTRATION ==========
function loadModulesForYear() {
  document.getElementById('studentModulesField').style.display = 'block';

  const year = document.getElementById('yearLevel').value;
  const container = document.getElementById('modulesCheckboxContainer');
  container.innerHTML = '';
  
  if (year) {
    document.getElementById('studentModulesField').classList.remove('hidden');
    
    let allCourses = [];
    
    if (year === 'mixed') {
      // Show both 1st and 2nd year modules
      allCourses = [...coursesData[1], ...coursesData[2]];
    } else if (coursesData[year]) {
      // Show specific year modules
      allCourses = coursesData[year];
    }
    
    allCourses.forEach(course => {
      const checkboxDiv = document.createElement('div');
      checkboxDiv.className = 'module-checkbox';
      checkboxDiv.innerHTML = `
        <input type="checkbox" value="${course.code}" style="margin-right: 10px;">
        <div class="module-info">
          <div class="module-code">${course.code} ${course.dev ? '<span class="dev-tag">DEV</span>' : ''}
            <span style="font-size: 0.8rem; background: #e5e7eb; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">Year ${course.year}</span>
          </div>
          <div class="module-name">${course.name}</div>
        </div>
        <div class="module-price">R${course.price}</div>
      `;
      container.appendChild(checkboxDiv);
    });
  } else {
    document.getElementById('studentModulesField').classList.add('hidden');
  }
}

// Password toggle functionality
function setupPasswordToggle(passwordId, toggleId) {
  const passwordInput = document.getElementById(passwordId);
  const toggleButton = document.getElementById(toggleId);
  const icon = toggleButton.querySelector('i');
  
  toggleButton.addEventListener('click', () => {
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      passwordInput.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  });
}

setupPasswordToggle('loginPassword', 'toggleLoginPassword');
setupPasswordToggle('password', 'togglePassword');
setupPasswordToggle('confirmPassword', 'toggleConfirmPassword');

document.getElementById('materialFile').addEventListener('change', function(e) {
  if (this.files.length > 0) {
    const file = this.files[0];
    const materialLink = document.getElementById('materialLink');
    
    // Create a "fake" URL that shows the file is uploaded
    materialLink.value = `📎 Uploaded: ${file.name}`;
    
    // Auto-fill title if empty
    const titleInput = document.getElementById('materialTitle');
    if (!titleInput.value.trim()) {
      // Use filename without extension as title
      const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
      titleInput.value = fileNameWithoutExt;
    }
    
    // Auto-select material type based on file extension
    const materialType = document.getElementById('materialType');
    if (!materialType.value) {
      const ext = file.name.split('.').pop().toLowerCase();
      
      if (['pdf', 'doc', 'docx', 'txt'].includes(ext)) {
        materialType.value = 'notes';
      } else if (['mp4', 'avi', 'mov', 'mkv'].includes(ext)) {
        materialType.value = 'video';
      } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
        materialType.value = 'other';
      }
    }
    
    // Show file info
    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
    console.log(`File selected: ${file.name} (${fileSizeMB} MB)`);
  }
});
// Validation Functions
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validatePassword(password) {
  return password.length >= 8 && /[A-Za-z]/.test(password) && /\d/.test(password);
}

// Error handling
function showError(inputId, errorId, message = '') {
  const input = document.getElementById(inputId);
  const error = document.getElementById(errorId);
  
  input.classList.add('error-input');
  error.textContent = message || error.textContent;
  error.classList.add('show');
}

function hideError(inputId, errorId) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(errorId);
  
  input.classList.remove('error-input');
  error.classList.remove('show');
}

function showSuccess(messageId, message) {
  const successDiv = document.getElementById(messageId);
  successDiv.textContent = message;
  successDiv.classList.add('show');
  setTimeout(() => successDiv.classList.remove('show'), 3000);
}


// ========== REGISTRATION ==========
// ========== CROSS-DEVICE REGISTRATION ==========
document.getElementById('registerFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  console.log('Registration form submitted - CROSS-DEVICE VERSION');
  
  let isValid = true;
  
  const fullName = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const userType = document.getElementById('userType').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  console.log('User type:', userType);
  
  // Basic validation
  if (!fullName || fullName.length < 2) {
    showError('fullName', 'fullNameError');
    isValid = false;
  } else {
    hideError('fullName', 'fullNameError');
  }
  
  if (!email || !validateEmail(email)) {
    showError('email', 'emailError');
    isValid = false;
  } else {
    hideError('email', 'emailError');
  }
  
  if (!userType) {
    showError('userType', 'userTypeError');
    isValid = false;
  } else {
    hideError('userType', 'userTypeError');
  }
  
  // Student-specific validation
  if (userType === 'student') {
    const yearLevel = document.getElementById('yearLevel').value;
    console.log('Year level:', yearLevel);
    
    if (!yearLevel) {
      showError('yearLevel', 'yearLevelError');
      isValid = false;
    } else {
      hideError('yearLevel', 'yearLevelError');
    }
  }
  
  if (!password || !validatePassword(password)) {
    showError('password', 'passwordError', 'Password must be at least 8 characters with letters and numbers');
    isValid = false;
  } else {
    hideError('password', 'passwordError');
  }
  
  if (!confirmPassword || password !== confirmPassword) {
    showError('confirmPassword', 'confirmPasswordError');
    isValid = false;
  } else {
    hideError('confirmPassword', 'confirmPasswordError');
  }
  
  console.log('Is valid:', isValid);
  
  if (!isValid) {
    return;
  }
  
  // Disable submit button
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
  submitBtn.disabled = true;
  
  try {
    // ==========CHECK IF USER ALREADY EXISTS ==========
    console.log("Checking if user already exists...");
    
    let existingUser = null;
    
    // Check Firestore
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0];
        existingUser = { id: doc.id, ...doc.data() };
        console.log('User already exists in Firestore:', existingUser);
      }
    }
    
    // Check local storage
    if (!existingUser) {
      const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
      existingUser = localUsers.find(u => u.email === email);
    }
    
    if (existingUser) {
      throw new Error('This email is already registered. Please login instead.');
    }
    
    // ========== CREATE USER OBJECT ==========
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const newUser = {
      id: userId,
      fullName,
      email,
      userType,
      password: password, // CRITICAL: Store password for cross-device login
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'active'
    };
    
    // Add user-specific fields
    if (userType === 'teacher') {
      newUser.specialization = [...teacherSelectedModules];
      if (teacherSelectedModules.length === 0) {
        newUser.specialization = ['Not assigned'];
      }
      newUser.balance = 0;
      
    } else if (userType === 'student') {
      newUser.yearLevel = document.getElementById('yearLevel').value;
      newUser.selectedModules = [];
      newUser.enrolledCourses = [];
      newUser.pendingPayment = 0;
      newUser.balance = 0;
    }
    
    console.log("New user object:", newUser);
    
    // ========== SAVE TO FIRESTORE (CRITICAL FOR CROSS-DEVICE) ==========
    let firestoreId = null;
    
    if (window.db && window.addDoc) {
      try {
        console.log("Saving user to Firestore...");
        
        // Create Firestore version WITH PASSWORD (This is the key fix!)
        const firestoreUser = { 
          ...newUser,
          // KEEP THE PASSWORD IN FIRESTORE for cross-device login
          password: password
        };
        
        const usersRef = collection(db, "users");
        const docRef = await addDoc(usersRef, firestoreUser);
        firestoreId = docRef.id;
        newUser.firestoreId = firestoreId;
        newUser.id = docRef.id; // Use Firestore ID as main ID
        
        console.log('✅ User saved to Firestore with ID:', firestoreId);
        console.log('✅ Password saved to Firestore for cross-device login');
        
      } catch (firestoreError) {
        console.error('Firestore save error:', firestoreError);
        throw new Error('Could not save to database. Please try again.');
      }
    } else {
      console.warn("Firestore not available, saving locally only");
    }
    
    // ========== TRY TO CREATE FIREBASE AUTH ACCOUNT (OPTIONAL) ==========
    // This is for advanced features, but NOT required for basic login
    if (window.auth && window.createUserWithEmailAndPassword) {
      try {
        console.log("Creating Firebase Auth account (optional)...");
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const firebaseUser = userCredential.user;
        
        newUser.firebaseUID = firebaseUser.uid;
        newUser.authProvider = 'email/password';
        
        console.log('✅ Firebase Auth account created:', firebaseUser.uid);
        
        // Update Firestore with Firebase UID if we have it
        if (firestoreId) {
          await updateDoc(doc(db, "users", firestoreId), {
            firebaseUID: firebaseUser.uid,
            authProvider: 'email/password',
            updatedAt: new Date().toISOString()
          });
        }
        
      } catch (firebaseError) {
        console.warn('Firebase Auth creation warning:', firebaseError.code);
        
        if (firebaseError.code === 'auth/email-already-in-use') {
          console.log("Firebase Auth account already exists - that's OK");
          // User can still login with Firestore password
        } else {
          // Non-critical error, user can still login with Firestore password
          console.log("User can login with Firestore password even without Firebase Auth");
        }
      }
    }
    
    // ========== SAVE TO LOCAL STORAGE (CURRENT DEVICE) ==========
    console.log("Saving to local storage...");
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    localUsers.push(newUser);
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
    window.users = localUsers; // Update global users array
    
    // ========== AUTO-LOGIN THE USER ==========
    console.log("Auto-logging in new user...");
    currentUser = newUser;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
    
    // ========== SHOW SUCCESS MESSAGE ==========
    showSuccess('registerSuccess', '✅ Account created successfully!');
    
    // ========== SHOW IMPORTANT CREDENTIALS ==========
    setTimeout(() => {
      document.getElementById('registerForm').classList.remove('active');
      this.reset();
      
      // Reset form fields
      document.getElementById('teacherFields').classList.add('hidden');
      document.getElementById('studentFields').classList.add('hidden');
      document.getElementById('studentModulesField').classList.add('hidden');
      document.getElementById('userType').value = '';
      teacherSelectedModules = [];
      updateTeacherSelectionCount();
      
      // Update UI
      updateUIForUser();
      updateHomePage();
      updateCoursesDisplay();
      
      // Show dashboard
      showDashboard();
      
      // Show CRITICAL credentials message
      const credentialsMessage = `
🎉 Welcome to Thrive Academy, ${fullName}!

YOUR LOGIN CREDENTIALS (SAVE THESE!):
----------------------------------------
📧 Email: ${email}
🔐 Password: ${password}
----------------------------------------

✅ Your account works on ALL devices!
✅ Login on any device using these credentials
✅ No Google account needed

📱 Save this information somewhere safe!

Click OK to continue to your dashboard.
      `;
      
      alert(credentialsMessage);
      
    }, 1500);
    
  } catch (error) {
    console.error('Registration error:', error);
    
    // error messages
    let errorMessage = 'Registration failed: ';
    
    if (error.message.includes('already registered')) {
      errorMessage = 'This email is already registered. Please login instead.';
    } else if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'This email is already registered with Firebase. Please login instead.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'Password is too weak. Use at least 8 characters with letters and numbers.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else {
      errorMessage += error.message;
    }
    
    alert('❌ ' + errorMessage);
    
  } finally {
    // Reset button
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});
// ========== AUTO-MIGRATE EXISTING USERS ==========
async function migrateExistingUsersToFirestore() {
  console.log("Checking for existing users to migrate...");
  
  const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
  const currentUser = JSON.parse(localStorage.getItem('ThriveAcademy_currentUser'));
  
  if (!window.db || localUsers.length === 0) {
    console.log("No users to migrate or Firestore not available");
    return;
  }
  
  try {
    let migratedCount = 0;
    
    for (const user of localUsers) {
      // Check if user already exists in Firestore
      const q = query(collection(db, "users"), where("email", "==", user.email));
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        // User doesn't exist in Firestore, migrate them
        console.log(`Migrating user to Firestore: ${user.email}`);
        
        const firestoreUser = { ...user };
        // Ensure password is included
        if (!firestoreUser.password && user.password) {
          firestoreUser.password = user.password;
        }
        
        firestoreUser.updatedAt = new Date().toISOString();
        
        const usersRef = collection(db, "users");
        const docRef = await addDoc(usersRef, firestoreUser);
        
        console.log(`✅ Migrated ${user.email} to Firestore with ID: ${docRef.id}`);
        migratedCount++;
      }
    }
    
    if (migratedCount > 0) {
      console.log(`✅ Successfully migrated ${migratedCount} users to Firestore`);
      alert(`✅ ${migratedCount} user(s) migrated to cloud storage. They can now login from any device!`);
    }
    
  } catch (error) {
    console.error("Migration error:", error);
  }
}

// Run migration check on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    if (window.db) {
      migrateExistingUsersToFirestore();
    }
  }, 3000);
});
// ========== CROSS-DEVICE REGISTRATION SYSTEM ==========
document.getElementById('registerFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  console.log('Registration form submitted - CROSS-DEVICE VERSION');
  
  let isValid = true;
  
  const fullName = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const userType = document.getElementById('userType').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  console.log('User type:', userType);
  
  // Basic validation
  if (!fullName || fullName.length < 2) {
    showError('fullName', 'fullNameError');
    isValid = false;
  } else {
    hideError('fullName', 'fullNameError');
  }
  
  if (!email || !validateEmail(email)) {
    showError('email', 'emailError');
    isValid = false;
  } else {
    hideError('email', 'emailError');
  }
  
  if (!userType) {
    showError('userType', 'userTypeError');
    isValid = false;
  } else {
    hideError('userType', 'userTypeError');
  }
  
  // Student-specific validation
  if (userType === 'student') {
    const yearLevel = document.getElementById('yearLevel').value;
    console.log('Year level:', yearLevel);
    
    if (!yearLevel) {
      showError('yearLevel', 'yearLevelError');
      isValid = false;
    } else {
      hideError('yearLevel', 'yearLevelError');
    }
  }
  
  if (!password || !validatePassword(password)) {
    showError('password', 'passwordError', 'Password must be at least 8 characters with letters and numbers');
    isValid = false;
  } else {
    hideError('password', 'passwordError');
  }
  
  if (!confirmPassword || password !== confirmPassword) {
    showError('confirmPassword', 'confirmPasswordError');
    isValid = false;
  } else {
    hideError('confirmPassword', 'confirmPasswordError');
  }
  
  console.log('Is valid:', isValid);
  
  if (!isValid) {
    return;
  }
  
  // Disable submit button
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
  submitBtn.disabled = true;
  
  try {
    // ========== CHECK IF USER EXISTS IN FIRESTORE ==========
    let userExists = false;
    let existingUser = null;
    
    if (window.db) {
      try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          userExists = true;
          const doc = querySnapshot.docs[0];
          existingUser = { id: doc.id, ...doc.data() };
          console.log('User already exists in Firestore:', existingUser);
        }
      } catch (firestoreError) {
        console.log("Could not check Firestore:", firestoreError);
      }
    }
    
    if (userExists) {
      throw new Error('This email is already registered. Please login instead.');
    }
    
    // ========== CREATE FIREBASE AUTH USER ==========
    let firebaseUser = null;
    
    if (window.auth && window.createUserWithEmailAndPassword) {
      try {
        console.log("Creating Firebase Auth user...");
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        firebaseUser = userCredential.user;
        console.log('✅ Firebase Auth user created:', firebaseUser.uid);
      } catch (firebaseError) {
        console.error('Firebase Auth error:', firebaseError);
        
        // If Firebase fails, we can still create local account
        if (firebaseError.code === 'auth/email-already-in-use') {
          throw new Error('This email is already registered with Firebase. Please login instead.');
        } else if (firebaseError.code === 'auth/network-request-failed') {
          // Network error - create local account only
          console.log('Network error, creating local account only');
        } else {
          throw firebaseError;
        }
      }
    }
    
    // ========== CREATE USER OBJECT ==========
    const newUser = {
      id: firebaseUser ? firebaseUser.uid : 'local_' + Date.now(),
      fullName,
      email,
      userType,
      password: password, // Store for local login
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'active'
    };
    
    // Add Firebase UID if available
    if (firebaseUser) {
      newUser.firebaseUID = firebaseUser.uid;
      newUser.authProvider = 'email/password';
    }
    
    // Add user-specific fields
    if (userType === 'teacher') {
      newUser.specialization = [...teacherSelectedModules];
      if (teacherSelectedModules.length === 0) {
        newUser.specialization = ['Not assigned'];
      }
      newUser.balance = 0;
      
    } else if (userType === 'student') {
      newUser.yearLevel = document.getElementById('yearLevel').value;
      newUser.selectedModules = [];
      newUser.enrolledCourses = [];
      newUser.pendingPayment = 0;
      newUser.balance = 0;
    }
    
    // ========== SAVE TO FIRESTORE ==========
    let firestoreId = null;
    
    if (window.db && window.addDoc) {
      try {
        
        // Create Firestore version WITH password
const firestoreUser = { ...newUser };
// Keep password in Firestore for cross-device login
        const usersRef = collection(db, "users");
        const docRef = await addDoc(usersRef, firestoreUser);
        firestoreId = docRef.id;
        newUser.firestoreId = firestoreId;
        
        console.log('✅ User saved to Firestore with ID:', firestoreId);
        
      } catch (firestoreError) {
        console.error('Firestore save error:', firestoreError);
        // Continue with local storage if Firestore fails
      }
    }
    
    // ========== SAVE TO LOCAL STORAGE (CURRENT DEVICE) ==========
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    
    // Remove any existing user with same email (cleanup)
    const filteredUsers = localUsers.filter(u => u.email !== email);
    filteredUsers.push(newUser);
    
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(filteredUsers));
    users = filteredUsers; // Update global users array
    
    // ==========  LOGIN USER ==========
    currentUser = newUser;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
    
    // ========== SHOW SUCCESS ==========
    showSuccess('registerSuccess', '✅ Registration successful! You are now logged in.');
    
    // ========== UPDATE UI AND REDIRECT ==========
    setTimeout(() => {
      document.getElementById('registerForm').classList.remove('active');
      this.reset();
      
      // Reset form fields
      document.getElementById('teacherFields').classList.add('hidden');
      document.getElementById('studentFields').classList.add('hidden');
      document.getElementById('studentModulesField').classList.add('hidden');
      document.getElementById('userType').value = '';
      teacherSelectedModules = [];
      updateTeacherSelectionCount();
      
      // Update UI
      updateUIForUser();
      updateHomePage();
      updateCoursesDisplay();
      
      // Show dashboard
      showDashboard();
      
      // Show welcome message
      alert(`🎉 Welcome to Thrive Academy, ${fullName}!\n\nYour account works on ALL devices.\n\nLogin on any device using:\nEmail: ${email}\nPassword: ${password}`);
      
    }, 1500);
    
  } catch (error) {
    console.error('Registration error:', error);
    
    // User-friendly error messages
    let errorMessage = 'Registration failed: ';
    
    if (error.message.includes('already registered')) {
      errorMessage = error.message;
    } else if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'This email is already registered. Please login instead.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'Password is too weak. Use at least 8 characters with letters and numbers.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else {
      errorMessage += error.message;
    }
    
    alert('❌ ' + errorMessage);
    
  } finally {
    // Reset button
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});


// ========== PAYMENT SYSTEM ==========
let selectedCourses = [];
let totalAmount = 0;

function selectCourseForPayment(courseCode, price) {
  // Check if course already selected
  const existingIndex = selectedCourses.findIndex(c => c.code === courseCode);
  
  if (existingIndex === -1) {
    // Add course
    let course = null;
    for (const year in coursesData) {
      const foundCourse = coursesData[year].find(c => c.code === courseCode);
      if (foundCourse) {
        course = foundCourse;
        break;
      }
    }
    
    if (course) {
      selectedCourses.push({
        code: courseCode,
        name: course.name,
        price: price
      });
      totalAmount += price;
    }
  } else {
    // Remove course
    selectedCourses.splice(existingIndex, 1);
    totalAmount -= price;
  }
  
  updatePaymentDisplay();
  
  // Show/hide payment section
  if (selectedCourses.length > 0) {
    document.getElementById('paymentSection').classList.remove('hidden');
    document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
  } else {
    document.getElementById('paymentSection').classList.add('hidden');
  }
}

function updatePaymentDisplay() {
  const selectedCoursesDiv = document.getElementById('selectedCourses');
  const totalAmountSpan = document.getElementById('totalAmount');
  const paymentAmountSpan = document.getElementById('paymentAmount');
  
  selectedCoursesDiv.innerHTML = '';
  selectedCourses.forEach(course => {
    const courseItem = document.createElement('div');
    courseItem.className = 'selected-course-item';
    courseItem.innerHTML = `
      <span>${course.code} - ${course.name}</span>
      <span>R${course.price}</span>
    `;
    selectedCoursesDiv.appendChild(courseItem);
  });
  
  totalAmountSpan.textContent = totalAmount.toFixed(2);
  paymentAmountSpan.textContent = totalAmount.toFixed(2);
}

document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
  if (selectedCourses.length === 0) {
    alert('Please select at least one course');
    return;
  }
  
  // Store pending enrollment
  const enrollmentId = Date.now().toString();
  if (!pendingEnrollments[currentUser.id]) {
    pendingEnrollments[currentUser.id] = [];
  }
  
  selectedCourses.forEach(course => {
    pendingEnrollments[currentUser.id].push({
      id: enrollmentId,
      courseCode: course.code,
      amount: course.price,
      timestamp: new Date().toISOString(),
      status: 'pending'
    });
  });
  
  localStorage.setItem('ThriveAcademy_pending', JSON.stringify(pendingEnrollments));
  
  alert(`Payment instructions sent! Please pay R${totalAmount} and email proof of payment. Your access will be activated within 24 hours.`);
  
  // Reset selection
  selectedCourses = [];
  totalAmount = 0;
  document.getElementById('paymentSection').classList.add('hidden');
  
  // Update user's pending payment
  currentUser.pendingPayment = (currentUser.pendingPayment || 0) + totalAmount;
  localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
});

document.getElementById('cancelEnrollmentBtn').addEventListener('click', () => {
  selectedCourses = [];
  totalAmount = 0;
  document.getElementById('paymentSection').classList.add('hidden');
});

// ========== MATERIAL MANAGEMENT ==========
let currentCourseForMaterial = '';


function openAddMaterial(courseCode) {
    console.log("Opening add material for:", courseCode);
    
    // Show the modal
    const modal = document.getElementById('addMaterialModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('active');
        
        // Set the course code
        const courseInput = document.getElementById('materialCourseCode');
        if (courseInput) {
            courseInput.value = courseCode;
        }
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay active';
        overlay.onclick = function() {
            modal.classList.remove('active');
            modal.classList.add('hidden');
            this.remove();
        };
        document.body.appendChild(overlay);
    } else {
        console.error("Add Material modal not found!");
    }
}
// Trigger file upload based on material type
function handleMaterialTypeChange() {
  const materialType = document.getElementById('materialType').value;
  const materialLink = document.getElementById('materialLink');
  
  // Clear previous file input
  if (window.currentFileInput) {
    window.currentFileInput = null;
  }
  
  // If a material type is selected (not empty), open file picker immediately
  if (materialType && materialType !== 'other') {
    console.log(`Selected ${materialType} - opening file picker...`);
    
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.style.display = 'none';
    
    // Set accepted file types based on material type
    switch(materialType) {
      case 'notes':
        fileInput.accept = '.pdf,.doc,.docx,.txt,.ppt,.pptx';
        break;
      case 'video':
        fileInput.accept = '.mp4,.avi,.mov,.mkv,.webm';
        break;
      case 'assignment':
        fileInput.accept = '.pdf,.doc,.docx,.txt';
        break;
      case 'past_paper':
        fileInput.accept = '.pdf';
        break;
      case 'exercise':
        fileInput.accept = '.pdf,.doc,.docx,.txt,.jpg,.png';
        break;
      default:
        fileInput.accept = '.pdf,.doc,.docx,.txt,.jpg,.png,.mp4,.zip';
    }
    
    // Handle file selection
    fileInput.onchange = function(e) {
      if (this.files.length > 0) {
        const file = this.files[0];
        
        // Store the file globally
        window.currentFileInput = this;
        
        // AUTO-FILL URL FIELD WITH FILE MARKER (This is the FIX)
        materialLink.value = `FILE:${file.name}`;  // "FILE:" prefix tells system it's a file
        
        // Auto-fill title if empty
        const titleInput = document.getElementById('materialTitle');
        if (!titleInput.value.trim()) {
          // Use filename without extension as title
          const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
          titleInput.value = fileNameWithoutExt;
        }
        
        // Show file info
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        console.log(`File selected: ${file.name} (${fileSizeMB} MB)`);
      }
    };
    
    // Add to page and click it
    document.body.appendChild(fileInput);
    fileInput.click();
    
    // Clean up after selection
    setTimeout(() => {
      if (fileInput.parentNode) {
        document.body.removeChild(fileInput);
      }
    }, 1000);
    
  } else if (materialType === 'other') {
    // For 'other' type, focus on link input
    materialLink.placeholder = 'Enter URL or description...';
    materialLink.focus();
  } else if (materialType) {
    materialLink.placeholder = `Optional: Enter URL for ${materialType.replace('_', ' ')}`;
  }
}
document.getElementById('cancelMaterialBtn').addEventListener('click', () => {
  const modal = document.getElementById('addMaterialModal');
  if (modal) {
    modal.classList.remove('active');
    modal.classList.add('hidden');
  }
  
  // Remove overlay
  const overlay = document.getElementById('addMaterialOverlay');
  if (overlay) {
    overlay.remove();
  }
  
  // Reset form
  document.getElementById('addMaterialForm').reset();
  
  // Clean up file URLs
  if (window.currentFileURL) {
    URL.revokeObjectURL(window.currentFileURL);
    window.currentFileURL = null;
  }
  window.currentFileInput = null;
  
  // Restore body scrolling
  document.body.style.overflow = '';
});
// Function to make file links downloadable
function setupMaterialFileLinks() {
  document.querySelectorAll('a[href^="📄"], input[value^="📄"]').forEach(element => {
    const value = element.value || element.textContent || element.href;
    const fileName = value.replace('📄 ', '');
    
    if (fileName) {
      element.style.cursor = 'pointer';
      element.style.color = '#4f46e5';
      element.title = `Click to download ${fileName}`;
      
      element.onclick = function(e) {
        e.preventDefault();
        
        // Find the material in storage
        const materials = JSON.parse(localStorage.getItem('ThriveAcademy_materials')) || [];
        const material = materials.find(m => 
          m.link === value || m.fileName === fileName
        );
        
        if (material && material.fileContent) {
          // Create downloadable link from base64
          const byteCharacters = atob(material.fileContent.split(',')[1]);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: material.fileType || 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = material.fileName || 'material';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          // Clean up
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } else {
          alert("File not found in storage");
        }
      };
    }
  });
}

// Call this after loading materials
setTimeout(setupMaterialFileLinks, 1000);
document.getElementById('addMaterialForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Get form values
  const title = document.getElementById('materialTitle').value.trim();
  const type = document.getElementById('materialType').value;
  const courseCode = document.getElementById('materialCourseCode').value;
  const link = document.getElementById('materialLink').value.trim();
  
  // BASIC VALIDATION - "FILE:" IS ACCEPTED AS VALID
  if (!title) {
    alert("Please enter a material title");
    document.getElementById('materialTitle').focus();
    return;
  }
  
  if (!type) {
    alert("Please select material type");
    document.getElementById('materialType').focus();
    return;
  }
  
  if (!courseCode) {
    alert("Error: No course selected");
    return;
  }
  
  // Check if a file was selected (URL field starts with "FILE:")
  let file = null;
  
  if (window.currentFileInput && window.currentFileInput.files.length > 0) {
    file = window.currentFileInput.files[0];
    console.log("Found file to upload:", file.name);
  }
  
  // Create material object
  const material = {
    id: 'material_' + Date.now(),
    courseCode: courseCode,
    title: title,
    type: type,
    description: document.getElementById('materialDescription').value.trim(),
    addedBy: currentUser.email || currentUser.fullName || 'Teacher',
    addedAt: new Date().toISOString()
  };
  
  // If link starts with "FILE:", it's a file upload
  if (link && link.startsWith('FILE:')) {
    const fileName = link.replace('FILE:', '').trim();
    material.fileName = fileName;
    material.isFile = true;
  } 
  // Regular URL
  else if (link) {
    material.link = link;
  }
  
  // If there's a file, store it
  if (file) {
    material.fileName = file.name;
    material.fileSize = file.size;
    material.fileType = file.type;
    
    // Convert file to base64 for storage
    try {
      const reader = new FileReader();
      material.fileContent = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Failed to read file"));
        reader.readAsDataURL(file);
      });
      
    } catch (error) {
      console.error("File reading error:", error);
      alert("Error reading file. Material saved without file.");
    }
  }
  
  // Save to materials array
  materials.push(material);
  
  // Save to localStorage
  localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
  
  // Show success
  alert(`✅ Material "${title}" added successfully to ${courseCode}!\n\nFile is now downloadable by students.`);
  
  // Close modal
  const modal = document.getElementById('addMaterialModal');
  if (modal) {
    modal.classList.remove('active');
    modal.classList.add('hidden');
  }
  
  // Remove overlay
  const overlay = document.getElementById('addMaterialOverlay');
  if (overlay) {
    overlay.remove();
  }
  
  // Reset form and global file
  this.reset();
  window.currentFileInput = null;
  
  // Restore scrolling
  document.body.style.overflow = '';
  
  // Refresh the page to show new material
  if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
    loadTeacherCourses();
  }
  
  updateHomePage();
  updateCoursesDisplay();
});
// Helper function to save material
function saveMaterialToStorage(title, type, courseCode, fileData) {
  const newMaterial = {
    id: 'material_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    courseCode: courseCode,
    title: title,
    type: type,
    description: document.getElementById('materialDescription').value.trim(),
    link: document.getElementById('materialLink').value.trim(),
    file: fileData,
    addedBy: currentUser.email || currentUser.fullName || 'Teacher',
    addedAt: new Date().toISOString()
  };
  
  console.log("Saving material:", newMaterial);
  
  // Save to materials array
  materials.push(newMaterial);
  
  // Save to localStorage
  localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
  
  // Show success message
  const successDiv = document.getElementById('materialSuccess');
  if (successDiv) {
    successDiv.textContent = '✅ Material added successfully!';
    successDiv.classList.add('show');
  } else {
    alert('✅ Material added successfully!');
  }
  
  // Close modal after 1.5 seconds
  setTimeout(() => {
    const modal = document.getElementById('addMaterialModal');
    if (modal) {
      modal.classList.remove('active');
      modal.classList.add('hidden');
    }
    
    // Remove overlay
    const overlay = document.getElementById('addMaterialOverlay');
    if (overlay) {
      overlay.remove();
    }
    
    // Reset form
    document.getElementById('addMaterialForm').reset();
    
    // Restore body scrolling
    document.body.style.overflow = '';
    
    // Remove success message
    if (successDiv) {
      successDiv.classList.remove('show');
    }
    
    // Refresh the page to show new material
    console.log("Refreshing page to show new material...");
    
    // If in teacher dashboard, reload teacher courses
    if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
      loadTeacherCourses();
    }
    
    // Update home page
    updateHomePage();
    
    // Update courses display
    updateCoursesDisplay();
    
  }, 1500);
}

// Helper function to create material with file
function createMaterialWithFile(title, type, fileData) {
  const newMaterial = {
    id: Date.now().toString(),
    courseCode: currentCourseForMaterial,
    title,
    type,
    description: document.getElementById('materialDescription').value,
    link: document.getElementById('materialLink').value,
    file: fileData, // Store file data
    addedBy: currentUser.email,
    addedAt: new Date().toISOString()
  };
  
  saveMaterial(newMaterial);
}

// Helper function to create material without file
function createMaterialWithoutFile(title, type) {
  const newMaterial = {
    id: Date.now().toString(),
    courseCode: currentCourseForMaterial,
    title,
    type,
    description: document.getElementById('materialDescription').value,
    link: document.getElementById('materialLink').value,
    addedBy: currentUser.email,
    addedAt: new Date().toISOString()
  };
  
  saveMaterial(newMaterial);
}

// Save material to storage
function saveMaterial(material) {
  materials.push(material);
  localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
  
  showSuccess('materialSuccess', 'Material added successfully!');
  
  setTimeout(() => {
    document.getElementById('addMaterialModal').classList.remove('active');
    document.getElementById('addMaterialModal').classList.add('hidden');
    document.getElementById('addMaterialForm').reset();
    
    // Reload courses to show new material
    updateCoursesDisplay();
    updateHomePage();
    
    // Update teacher dashboard
    if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
      loadTeacherCourses();
    }
  }, 1500);
}
function deleteMaterial(materialId) {
  if (!confirm('Are you sure you want to delete this material?')) {
    return;
  }
  
  // Find the material
  const materialIndex = materials.findIndex(m => m.id === materialId);
  if (materialIndex === -1) {
    alert('Material not found!');
    return;
  }
  
  // Remove from array
  materials.splice(materialIndex, 1);
  
  // Save to localStorage
  localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
  
  // If we're in the materials modal for this course, close it
  if (currentCourseForView) {
    closeCourseMaterials();
    
    // Re-open with updated materials
    setTimeout(() => {
      openCourseMaterials(currentCourseForView);
    }, 300);
  }
  
  // Update any course displays
  updateCoursesDisplay();
  updateHomePage();
  
  // Update teacher dashboard if applicable
  if (currentUser && (currentUser.userType === 'teacher' || 
      (currentUser.userType === 'admin' && adminMode === 'teacher'))) {
    loadTeacherCourses();
  }
  
  alert('Material deleted successfully!');
}

// ========== DASHBOARD FUNCTIONS ==========
// ========== DASHBOARD FUNCTIONS ==========
function showDashboard() {
    console.log("Showing dashboard for:", currentUser?.userType, currentUser?.fullName);
    
    // Hide all sections first
    document.getElementById('home').style.display = 'block';
    document.getElementById('courses').style.display = 'block';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('adminPanel').classList.remove('active');
    
    // Update user info
    document.getElementById('userName').textContent = currentUser.fullName;
    
    // Display role based on mode if admin
    if (currentUser.userType === 'admin' && devMode) {
        document.getElementById('userRole').textContent = adminMode.charAt(0).toUpperCase() + adminMode.slice(1);
        document.getElementById('userRole').style.background = '#ff6b6b';
    } else {
        document.getElementById('userRole').textContent = currentUser.userType.charAt(0).toUpperCase() + currentUser.userType.slice(1);
        document.getElementById('userRole').style.background = '#4f46e5';
    }
    
    document.getElementById('userEmail').textContent = currentUser.email;
    
    // Check which dashboard to show based on user type and mode
    if ((currentUser.userType === 'teacher') || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
        console.log("Loading TEACHER dashboard...");
        console.log("Teacher specialization:", currentUser.specialization);
        
        document.getElementById('teacherDashboard').classList.remove('hidden');
        document.getElementById('studentDashboard').classList.add('hidden');
        document.getElementById('userCourses').classList.remove('hidden');
        document.getElementById('userYearLevel').classList.add('hidden');
        document.getElementById('userBalance').classList.add('hidden');
        
        // Show teaching modules count
        if (currentUser.specialization && currentUser.specialization.length > 0) {
            document.getElementById('teachingCourses').textContent = 
                currentUser.specialization.join(', ') + ` (${currentUser.specialization.length} module${currentUser.specialization.length !== 1 ? 's' : ''})`;
        } else {
            document.getElementById('teachingCourses').textContent = 'No modules assigned yet';
        }
        
        // Load teacher courses
        setTimeout(() => {
            loadTeacherCourses();
        }, 100);
        
        // Add back to admin button if in dev mode
        if (currentUser.userType === 'admin' && devMode && adminMode !== 'admin') {
            addBackToAdminButton();
        }
        
    } else if ((currentUser.userType === 'student') || (currentUser.userType === 'admin' && adminMode === 'student')) {
        console.log("Loading STUDENT dashboard...");
        
        document.getElementById('teacherDashboard').classList.add('hidden');
        document.getElementById('studentDashboard').classList.remove('hidden');
        document.getElementById('userCourses').classList.add('hidden');
        document.getElementById('userYearLevel').classList.remove('hidden');
        document.getElementById('userBalance').classList.remove('hidden');
        
        const yearLevel = (currentUser.userType === 'admin' && adminMode === 'student') ? 'mixed' : currentUser.yearLevel;
        document.getElementById('yearLevelDisplay').textContent = getYearName(yearLevel);
        document.getElementById('balanceAmount').textContent = (currentUser.balance || 0).toFixed(2);
        
        // Load student courses
        setTimeout(() => {
            loadStudentCourses();
        }, 100);
        
        // Add back to admin button if in dev mode
        if (currentUser.userType === 'admin' && devMode && adminMode !== 'admin') {
            addBackToAdminButton();
        }
        
    } else if (currentUser.userType === 'admin' && adminMode === 'admin') {
        console.log("Loading ADMIN dashboard...");
        
        // For admin in admin mode, show admin panel instead
        showAdminPanel();
        return;
    }
    
    // Scroll to dashboard
    document.getElementById('dashboard').scrollIntoView({ behavior: 'smooth' });
    
    console.log("Dashboard loaded successfully");
}

function getYearName(year) {
    const yearNames = { '1': '1st Year', '2': '2nd Year', 'mixed': 'Mixed (1st & 2nd Year)' };
    return yearNames[year] || year;
}

// Add "Back to Admin" button function
function addBackToAdminButton() {
    // Remove existing button if it exists
    removeBackToAdminButton();
    
    // Create back to admin button
    const backButton = document.createElement('button');
    backButton.className = 'back-to-admin-btn';
    backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Admin Panel';
    backButton.onclick = () => {
        switchAdminMode('admin');
        showAdminPanel();
    };
    
    // Add button to user info section
    const userInfo = document.querySelector('.user-info');
    if (userInfo) {
        userInfo.appendChild(backButton);
    }
}

function removeBackToAdminButton() {
    const existingButton = document.querySelector('.back-to-admin-btn');
    if (existingButton) {
        existingButton.remove();
    }
}
function getYearName(year) {
  const yearNames = { '1': '1st Year', '2': '2nd Year', 'mixed': 'Mixed (1st & 2nd Year)' };
  return yearNames[year] || year;
}

function loadTeacherCourses() {
    console.log("=== LOAD TEACHER COURSES ===");
    console.log("Current user:", currentUser);
    console.log("User type:", currentUser.userType);
    console.log("Admin mode:", adminMode);
    console.log("Teacher specialization:", currentUser.specialization);
    
    const container = document.getElementById('teacherCoursesContainer');
    if (!container) {
        console.error("❌ Teacher courses container not found!");
        return;
    }
    
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading teaching modules...</div>';
    
    // Get ALL courses from both years
    const allCourses = [...coursesData[1], ...coursesData[2]];
    console.log("Total courses available:", allCourses.length);
    
    // Get teacher's modules
    let teacherModules = [];
    
    if (currentUser.userType === 'admin' && adminMode === 'teacher') {
        // Admin in teacher mode: Show all modules
        teacherModules = allCourses;
        console.log("✅ Admin teacher mode - showing ALL modules:", teacherModules.length);
    } else if (currentUser.specialization) {
        // Regular teacher: Show only assigned modules
        console.log("Looking for teacher's modules:", currentUser.specialization);
        
        // Find each module in the courses data
        currentUser.specialization.forEach(moduleCode => {
            // Clean the module code (remove spaces, make uppercase)
            const cleanCode = moduleCode.replace(/\s+/g, '').toUpperCase().trim();
            console.log(`Searching for module: "${cleanCode}"`);
            
            // Try to find the module
            let foundModule = null;
            
            // First try exact match
            foundModule = allCourses.find(course => 
                course.code.replace(/\s+/g, '').toUpperCase() === cleanCode
            );
            
            // If not found, try partial match
            if (!foundModule) {
                foundModule = allCourses.find(course => 
                    course.code.replace(/\s+/g, '').toUpperCase().includes(cleanCode) ||
                    cleanCode.includes(course.code.replace(/\s+/g, '').toUpperCase())
                );
            }
            
            if (foundModule) {
                console.log(`✅ Found module: ${foundModule.code} - ${foundModule.name}`);
                teacherModules.push(foundModule);
            } else {
                console.warn(`❌ Module not found in courses data: ${moduleCode}`);
                
                // Create a placeholder module if not found
                teacherModules.push({
                    code: moduleCode,
                    name: 'Module (Details not found)',
                    description: 'Please contact admin to update module information',
                    teacher: currentUser.fullName,
                    year: 'Unknown',
                    price: 0
                });
            }
        });
        
        console.log("✅ Teacher modules found:", teacherModules.length);
    } else {
        console.log("⚠️ No specialization found for teacher");
    }
    
    // Clear container and show message if no modules
    if (teacherModules.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: white; border-radius: 10px; grid-column: 1 / -1;">
                <i class="fas fa-chalkboard-teacher" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                <h3>No Teaching Modules Assigned</h3>
                <p style="color: #6b7280; margin: 15px 0;">Please contact admin to get assigned teaching modules.</p>
                ${currentUser.specialization ? `
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p style="color: #92400e; margin: 0;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Your assigned modules (not found in system): 
                            <strong>${currentUser.specialization.join(', ')}</strong>
                        </p>
                    </div>
                ` : ''}
                <button class="btn" onclick="window.location.reload()" style="margin-top: 10px;">
                    <i class="fas fa-sync-alt"></i> Refresh Page
                </button>
            </div>
        `;
        return;
    }
    
    // Display teacher's modules
    container.innerHTML = '';
    
    teacherModules.forEach(course => {
        const courseMaterials = materials.filter(m => m.courseCode === course.code);
        
        const card = document.createElement('div');
        card.className = 'course-card';
        card.style.marginBottom = '20px';
        
        card.innerHTML = `
            <div class="course-header">
                <h3>${course.code} <span class="year-badge">Year ${course.year || 'Unknown'}</span></h3>
                <p>${course.name}</p>
            </div>
            <div class="course-body">
                <p style="color: #6b7280; font-size: 0.9rem;">${course.description || 'No description available'}</p>
                <p><strong>Materials Added:</strong> ${courseMaterials.length}</p>
                
                ${courseMaterials.length > 0 ? `
                    <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                        <p style="margin: 0 0 5px 0; font-size: 0.9rem; color: #4f46e5;">Recent materials:</p>
                        <div style="font-size: 0.85rem; color: #6b7280;">
                            ${courseMaterials.slice(0, 2).map(m => `
                                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                    <i class="fas ${getMaterialIcon(m.type)}" style="font-size: 0.8rem;"></i>
                                    <span>${m.title}</span>
                                </div>
                            `).join('')}
                            ${courseMaterials.length > 2 ? `<div>...and ${courseMaterials.length - 2} more</div>` : ''}
                        </div>
                    </div>
                ` : `
                    <div style="margin: 10px 0; padding: 15px; background: #f9fafb; border-radius: 6px; text-align: center;">
                        <i class="fas fa-folder-open" style="font-size: 1.5rem; color: #d1d5db; margin-bottom: 10px;"></i>
                        <p style="color: #6b7280; margin: 0; font-size: 0.9rem;">No materials added yet</p>
                    </div>
                `}
                
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" onclick="openAddMaterial('${course.code}')">
                        <i class="fas fa-plus"></i> Add Material
                    </button>
                    
                    ${courseMaterials.length > 0 ? `
                        <button class="btn" onclick="openTeacherMaterials('${course.code}')">
                            <i class="fas fa-eye"></i> View All Materials (${courseMaterials.length})
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    console.log("✅ Teacher dashboard loaded successfully with", teacherModules.length, "modules");
}

// ========== TEACHER MATERIALS VIEWER ==========
function openTeacherMaterials(courseCode) {
    console.log("Opening teacher materials for:", courseCode);
    
    // Get course details
    let courseDetails = null;
    for (const year in coursesData) {
        const course = coursesData[year].find(c => c.code === courseCode);
        if (course) {
            courseDetails = course;
            break;
        }
    }
    
    // Get materials for this course
    const courseMaterials = materials.filter(m => m.courseCode === courseCode);
    
    // Create modal
    const modalHTML = `
        <div id="teacherMaterialsModal" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        ">
            <div style="
                background: #4f46e5;
                color: white;
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div>
                    <h3 style="margin: 0;">${courseDetails?.code || courseCode} - Materials Management</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">Total: ${courseMaterials.length} materials</p>
                </div>
                <button onclick="closeTeacherMaterials()" style="
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.2rem;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #1f2937;">All Materials</h4>
                    <button onclick="openAddMaterial('${courseCode}'); closeTeacherMaterials();" class="btn btn-success" style="padding: 8px 15px;">
                        <i class="fas fa-plus"></i> Add New Material
                    </button>
                </div>
                
                ${courseMaterials.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${courseMaterials.map(material => `
                            <div style="
                                border: 1px solid #e5e7eb;
                                border-radius: 8px;
                                padding: 15px;
                                background: white;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                            <i class="fas ${getMaterialIcon(material.type)}" style="color: #4f46e5;"></i>
                                            <h5 style="margin: 0; font-size: 1rem;">${material.title}</h5>
                                            <span style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">
                                                ${material.type.replace('_', ' ')}
                                            </span>
                                        </div>
                                        <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #6b7280; margin-top: 5px;">
                                            <span><i class="far fa-calendar"></i> ${formatDate(material.addedAt)}</span>
                                            <span><i class="fas fa-user"></i> ${material.addedBy || 'You'}</span>
                                        </div>
                                    </div>
                                    <button onclick="deleteMaterial('${material.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                
                                ${material.description ? `
                                    <p style="margin: 10px 0 0 0; color: #6b7280; font-size: 0.9rem; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                        ${material.description}
                                    </p>
                                ` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    ${material.link ? `
                                        <a href="${material.link}" target="_blank" class="btn" style="padding: 8px 15px; flex: 1;">
                                            <i class="fas fa-external-link-alt"></i> Open Link
                                        </a>
                                    ` : `
                                        <button onclick="downloadMaterial('${material.id}')" class="btn" style="padding: 8px 15px; flex: 1;">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                        <h4 style="color: #6b7280; margin-bottom: 10px;">No Materials Yet</h4>
                        <p style="color: #9ca3af;">Click "Add New Material" to create your first study material.</p>
                    </div>
                `}
            </div>
            
            <div style="padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <button onclick="closeTeacherMaterials()" class="btn" style="flex: 1;">
                    Close
                </button>
                <button onclick="openAddMaterial('${courseCode}'); closeTeacherMaterials();" class="btn btn-success" style="flex: 1;">
                    <i class="fas fa-plus"></i> Add New Material
                </button>
            </div>
        </div>
    `;
    
    // Add modal to page
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.id = 'teacherMaterialsOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99999;
    `;
    overlay.onclick = closeTeacherMaterials;
    document.body.appendChild(overlay);
    
    // Prevent scrolling
    document.body.style.overflow = 'hidden';
}

function closeTeacherMaterials() {
    const modal = document.getElementById('teacherMaterialsModal');
    const overlay = document.getElementById('teacherMaterialsOverlay');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
    
    document.body.style.overflow = '';
}

// Make sure functions are available globally
window.openTeacherMaterials = openTeacherMaterials;
window.closeTeacherMaterials = closeTeacherMaterials;

function loadStudentCourses() {
    const container = document.getElementById('studentCoursesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Get enrolled courses from current user
    let enrolledCourses = currentUser.enrolledCourses || [];
    
    // If empty, try to find student data
    if (enrolledCourses.length === 0 && currentUser) {
        if (currentUser.accessCode) {
            const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
            const studentData = students.find(s => s.accessCode === currentUser.accessCode);
            if (studentData && studentData.enrolledCourses) {
                enrolledCourses = studentData.enrolledCourses;
                currentUser.enrolledCourses = enrolledCourses;
                localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
            }
        } else if (currentUser.email) {
            const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
            const studentData = students.find(s => s.email === currentUser.email);
            if (studentData && studentData.enrolledCourses) {
                enrolledCourses = studentData.enrolledCourses;
                currentUser.enrolledCourses = enrolledCourses;
                localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
            }
        }
    }
    
    console.log("Loading student courses. Enrolled in:", enrolledCourses);
    
    if (enrolledCourses.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: white; border-radius: 10px; grid-column: 1 / -1;">
                <i class="fas fa-book" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                <h3>No Courses Enrolled Yet</h3>
                <p style="color: #6b7280; margin: 15px 0;">Please contact admin to get enrolled in modules.</p>
                <p style="color: #ef4445; font-size: 0.9rem; margin: 10px 0;">
                    <i class="fas fa-exclamation-triangle"></i> You need an access code from admin
                </p>
            </div>
        `;
        return;
    }
    
    // Display enrolled courses
    enrolledCourses.forEach(courseCode => {
        // Find course details
        let courseDetails = null;
        
        for (const year in coursesData) {
            const course = coursesData[year].find(c => c.code === courseCode);
            if (course) {
                courseDetails = course;
                break;
            }
        }
        
        if (courseDetails) {
            const courseMaterials = materials.filter(m => m.courseCode === courseCode);
            
            const card = document.createElement('div');
            card.className = 'course-card';
            
            // Make the whole card clickable to view materials
            card.style.cursor = 'pointer';
            card.onclick = function(e) {
                // Don't trigger if clicking on buttons
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                // Open materials for this course
                openCourseMaterials(courseCode);
            };
            
            card.innerHTML = `
                <div class="course-header">
                    <h3>${courseDetails.code} <span class="year-badge">Year ${courseDetails.year}</span></h3>
                    <p>${courseDetails.name}</p>
                </div>
                <div class="course-body">
                    <p>${courseDetails.description}</p>
                    <p><strong>Teacher:</strong> ${courseDetails.teacher}</p>
                    <p><strong>Available Materials:</strong> ${courseMaterials.length}</p>
                    
                    ${courseMaterials.length > 0 ? `
                        <div style="margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                            <p style="margin: 0 0 5px 0; font-size: 0.9rem; color: #4f46e5;">Recent materials:</p>
                            <div style="font-size: 0.85rem; color: #6b7280;">
                                ${courseMaterials.slice(0, 2).map(m => `
                                    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                        <i class="fas ${getMaterialIcon(m.type)}" style="font-size: 0.8rem;"></i>
                                        <span>${m.title}</span>
                                    </div>
                                `).join('')}
                                ${courseMaterials.length > 2 ? `<div>...and ${courseMaterials.length - 2} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                  
<button class="btn" onclick="openStudentMaterials('${courseCode}')">
    <i class="fas fa-folder-open"></i> View Materials (${courseMaterials.length})
</button>
                </div>
            `;
            
            container.appendChild(card);
        }
    });
    
    // Make sure openCourseMaterials is globally available
    if (typeof openCourseMaterials !== 'function') {
        window.openCourseMaterials = openCourseMaterials;
    }
}
function viewCourseMaterials(courseCode) {
  // Find which year this course belongs to
  for (const year in coursesData) {
    const course = coursesData[year].find(c => c.code === courseCode);
    if (course) {
      // Load courses for that year
      if (currentUser && (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student'))) {
        document.querySelectorAll('.year-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.year === year.toString());
        });
        loadCourses(parseInt(year));
      }
      
      // Scroll to courses section
      document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
      break;
    }
  }
}

// ========== ADMIN FUNCTIONS ==========
function showAdminPanel() {
  // Guard: must be logged in
  if (!currentUser) {
    console.error("Admin panel blocked: currentUser not set");
    return;
  }

  // If developer mode is ON and viewing as teacher/student, redirect
  if (devMode && adminMode !== 'admin') {
    showDashboard();
    return;
  }

  // Show admin panel normally (REAL ADMIN MODE WORKS HERE)
  document.getElementById('adminPanel').classList.add('active');
  document.getElementById('dashboard').classList.remove('active');

  // Scroll safely
  document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });

  // Load admin data
  loadStudentsForAdmin();

  // Update dev controls visibility
  updateAdminPanelForMode();

  // Cleanup
  removeBackToAdminButton();
}


// View All Students button - FIXED VERSION,There may be Duplicates Due To Many Bug
document.getElementById('viewStudentsBtn').addEventListener('click', async function(e) {
  e.preventDefault();
  e.stopPropagation();
  
  console.log("View All Students button clicked - Loading from Firebase");
  
  // Show students list
  document.getElementById('enrollmentForm').classList.add('hidden');
  document.getElementById('studentsList').classList.remove('hidden');
  document.getElementById('paymentVerification').classList.add('hidden');
  
  // Clear the container first
  const studentsContainer = document.getElementById('studentsContainer');
  if (studentsContainer) {
    studentsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">Loading students...</p>';
  }
  
  // Try to load from Firebase first
  try {
    if (typeof window.displayStudentsFromFirebase === 'function' && window.db) {
      console.log("Calling displayStudentsFromFirebase()");
      await window.displayStudentsFromFirebase();
    } else {
      // Fallback to local storage
      console.log("Firebase not available, using local storage");
      const students = users.filter(u => u.userType === 'student');
      
      if (studentsContainer) {
        studentsContainer.innerHTML = '';
        students.forEach(student => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          studentItem.innerHTML = `
            <div>
              <strong>${student.fullName}</strong>
              <p style="color: #6b7280; font-size: 0.9rem;">${student.email} - ${getYearName(student.yearLevel)}</p>
              <p style="font-size: 0.9rem;">Enrolled in: ${student.enrolledCourses ? student.enrolledCourses.join(', ') : 'None'}</p>
              <p style="font-size: 0.9rem; color: ${student.pendingPayment > 0 ? '#ef4444' : '#10b981'}">
                Balance: R${(student.balance || 0).toFixed(2)} | Pending: R${(student.pendingPayment || 0).toFixed(2)}
              </p>
            </div>
            <div>
              <button class="btn" onclick="adminEnrollStudent('${student.id}')" style="margin-right: 10px;">Enroll</button>
              <button class="btn btn-warning" onclick="verifyStudentPayment('${student.id}')">Verify Payment</button>
            </div>
          `;
          studentsContainer.appendChild(studentItem);
        });
      }
    }
  } catch (error) {
    console.error("Error loading students:", error);
    if (studentsContainer) {
      studentsContainer.innerHTML = `<p style="color: #ef4444; padding: 20px;">Error loading students: ${error.message}</p>`;
    }
  }
});

// Enroll Student button
document.getElementById('enrollStudentBtn').addEventListener('click', () => {
  document.getElementById('enrollmentForm').classList.remove('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.add('hidden');
  loadCourseOptionsForAdmin();
});

// Verify Payment button
document.getElementById('verifyPaymentBtn').addEventListener('click', () => {
  document.getElementById('enrollmentForm').classList.add('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.remove('hidden');
  loadStudentsForAdmin();
});

// Cancel Enrollment button
document.getElementById('cancelEnrollmentBtn2').addEventListener('click', () => {
  document.getElementById('enrollmentForm').classList.add('hidden');
  selectedStudentForEnrollment = null;
  selectedCourseForEnrollment = null;
  document.getElementById('studentSelect').value = '';
  document.querySelectorAll('.enrollment-option').forEach(o => o.classList.remove('selected'));
});

// Cancel Verification button
document.getElementById('cancelVerificationBtn').addEventListener('click', () => {
  document.getElementById('paymentStudentSelect').value = '';
  document.getElementById('paymentReference').value = '';
  document.getElementById('paymentAmountInput').value = '';
  document.getElementById('studentPaymentInfo').classList.add('hidden');
  selectedStudentForPayment = null;
});
// ========== SIMPLIFIED FIREBASE STUDENT LOADER ==========
async function loadStudentsForAdmin() {
  console.log("Loading students from Firebase...");
  
  const studentSelect = document.getElementById('studentSelect');
  const paymentStudentSelect = document.getElementById('paymentStudentSelect');
  const studentsContainer = document.getElementById('studentsContainer');
  
  // Clear existing content
  studentSelect.innerHTML = '<option value="">Select a student</option>';
  paymentStudentSelect.innerHTML = '<option value="">Select a student</option>';
  
  if (studentsContainer) {
    studentsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">Loading students from database...</p>';
  }
  
  try {
    // Check if Firebase is available
    if (!window.db || !window.collection || !window.getDocs || !window.query) {
      console.warn("Firebase not available, using local storage");
      throw new Error("Firebase not available");
    }
    
    // Get ALL users from Firestore
    const usersRef = collection(db, "users");
    const snapshot = await getDocs(usersRef);
    
    console.log(`Found ${snapshot.size} total users in Firestore`);
    
    // Filter for students
    const students = [];
    snapshot.forEach((doc) => {
      const userData = doc.data();
      if (userData.userType === 'student') {
        students.push({
          id: doc.id,
          ...userData
        });
      }
    });
    
    console.log(`Found ${students.length} students`);
    
    if (students.length === 0) {
      if (studentsContainer) {
        studentsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">No students found in database.</p>';
      }
      return;
    }
    
    // Update dropdowns
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = `${student.fullName} (${student.email}) - ${getYearName(student.yearLevel || 'mixed')}`;
      
      studentSelect.appendChild(option.cloneNode(true));
      paymentStudentSelect.appendChild(option);
    });
    
    // Update students list if visible
    if (studentsContainer && document.getElementById('studentsList') && 
        !document.getElementById('studentsList').classList.contains('hidden')) {
      
      studentsContainer.innerHTML = '';
      
      students.forEach(student => {
        const studentItem = document.createElement('div');
        studentItem.className = 'student-item';
        
        // Format enrolled courses
        const enrolledCourses = student.enrolledCourses || [];
        const coursesText = enrolledCourses.length > 0 ? 
          enrolledCourses.join(', ') : 'None';
        
        studentItem.innerHTML = `
          <div>
            <strong>${student.fullName || 'No name'}</strong>
            <p style="color: #6b7280; font-size: 0.9rem;">${student.email || 'No email'} - ${getYearName(student.yearLevel || 'mixed')}</p>
            <p style="font-size: 0.9rem;">Enrolled in: ${coursesText}</p>
            <p style="font-size: 0.9rem; color: ${(student.pendingPayment || 0) > 0 ? '#ef4444' : '#10b981'}">
              Balance: R${(student.balance || 0).toFixed(2)} | Pending: R${(student.pendingPayment || 0).toFixed(2)}
            </p>
          </div>
          <div>
            <button class="btn" onclick="adminEnrollStudent('${student.id}')" style="margin-right: 10px;">Enroll</button>
            <button class="btn btn-warning" onclick="verifyStudentPayment('${student.id}')">Verify Payment</button>
          </div>
        `;
        
        studentsContainer.appendChild(studentItem);
      });
    }
    
    console.log("✅ Students loaded successfully from Firestore");
    
  } catch (error) {
    console.error("Error loading students from Firebase:", error);
    
    // Fallback to local storage
    console.log("Falling back to local storage...");
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const localStudents = localUsers.filter(u => u.userType === 'student');
    
    if (studentsContainer) {
      if (localStudents.length > 0) {
        studentsContainer.innerHTML = '<p style="color: #f59e0b; padding: 10px;">⚠️ Using local data (Firebase unavailable)</p>';
      }
    }
    
    // Update dropdowns with local students
    localStudents.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id || student.email;
      option.textContent = `${student.fullName} (${student.email}) - ${getYearName(student.yearLevel || 'mixed')}`;
      
      studentSelect.appendChild(option.cloneNode(true));
      paymentStudentSelect.appendChild(option);
    });
  }
}
function getYearName(year) {
  if (!year) return 'Not specified';
  const yearNames = { 
    '1': '1st Year', 
    '2': '2nd Year', 
    'mixed': 'Mixed (1st & 2nd Year)' 
  };
  return yearNames[year] || year;
}
// ========== STUDENT REMOVAL FUNCTIONS ==========
async function removeStudent(studentId, studentName) {
  if (!confirm(`Are you sure you want to remove ${studentName}? This will delete their account permanently!`)) {
    return;
  }
  
  try {
    // Remove from Firestore
    await db.collection('users').doc(studentId).delete();
    
    // Remove from local storage if exists
    const users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const updatedUsers = users.filter(u => u.id !== studentId && u.uid !== studentId);
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(updatedUsers));
    
    // If this is the current user, log them out
    if (currentUser && (currentUser.id === studentId || currentUser.uid === studentId)) {
      await auth.signOut();
      currentUser = null;
      localStorage.removeItem('ThriveAcademy_currentUser');
      updateUIForUser();
      updateHomePage();
      updateCoursesDisplay();
    }
    
    alert(`Student ${studentName} removed successfully!`);
    loadStudentsForAdmin();
    
  } catch (error) {
    console.error("Error removing student:", error);
    alert("Error removing student. Check console for details.");
  }
}

async function removeAllStudents() {
  if (!confirm("Are you sure you want to remove ALL students? This action cannot be undone!")) {
    return;
  }
  
  try {
    // Get all students from Firestore
    const snapshot = await db.collection('users').where('userType', '==', 'student').get();
    
    // Delete each student
    const deletePromises = [];
    snapshot.forEach(doc => {
      deletePromises.push(db.collection('users').doc(doc.id).delete());
    });
    
    await Promise.all(deletePromises);
    
    // Clear local storage students
    const users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const updatedUsers = users.filter(u => u.userType !== 'student');
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(updatedUsers));
    
    alert(`Successfully removed ${snapshot.size} student(s)!`);
    loadStudentsForAdmin();
    
  } catch (error) {
    console.error("Error removing all students:", error);
    alert("Error removing students. Check console for details.");
  }
}
// Simple loadCourseOptionsForAdmin function
function loadCourseOptionsForAdmin() {
  const courseOptions = document.getElementById('courseOptions');
  if (!courseOptions) return;
  
  courseOptions.innerHTML = '';
  
  // Add all courses from both years
  for (const year in coursesData) {
    coursesData[year].forEach(course => {
      const option = document.createElement('div');
      option.className = 'enrollment-option';
      option.dataset.course = course.code;
      option.innerHTML = `
        <strong>${course.code}</strong>
        <p style="font-size: 0.9rem; margin: 5px 0;">${course.name}</p>
        <p style="font-size: 0.8rem; color: #6b7280;">Year ${course.year} - R${course.price}</p>
      `;
      option.addEventListener('click', () => {
        document.querySelectorAll('.enrollment-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        selectedCourseForEnrollment = course.code;
      });
      courseOptions.appendChild(option);
    });
  }
}
let selectedStudentForEnrollment = null;
let selectedCourseForEnrollment = null;

// These event listeners should already be set up above

document.getElementById('studentSelect').addEventListener('change', function() {
  selectedStudentForEnrollment = this.value;
});

document.getElementById('courseOptions').addEventListener('click', (e) => {
  const option = e.target.closest('.enrollment-option');
  if (option) {
    selectedCourseForEnrollment = option.dataset.course;
  }
});

document.getElementById('confirmEnrollmentBtn').addEventListener('click', () => {
  if (!selectedStudentForEnrollment) {
    alert('Please select a student');
    return;
  }
  
  if (!selectedCourseForEnrollment) {
    alert('Please select a course');
    return;
  }
  
  // Find student
  const student = users.find(u => u.id === selectedStudentForEnrollment);
  if (!student) {
    alert('Student not found');
    return;
  }
  
  // Find course
  let coursePrice = 0;
  for (const year in coursesData) {
    const course = coursesData[year].find(c => c.code === selectedCourseForEnrollment);
    if (course) {
      coursePrice = course.price;
      break;
    }
  }
  
  // Add to student's pending payment
  student.pendingPayment = (student.pendingPayment || 0) + coursePrice;
  
  // Enroll student in course
  if (!student.enrolledCourses) {
    student.enrolledCourses = [];
  }
  
  if (!student.enrolledCourses.includes(selectedCourseForEnrollment)) {
    student.enrolledCourses.push(selectedCourseForEnrollment);
    
    // Update in storage
    const userIndex = users.findIndex(u => u.id === student.id);
    if (userIndex !== -1) {
      users[userIndex] = student;
      localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
    }
    
    // If this is the current user, update their data too
    if (currentUser && currentUser.id === student.id) {
      currentUser.enrolledCourses = student.enrolledCourses;
      currentUser.pendingPayment = student.pendingPayment;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      updateHomePage();
    }
    
    alert(`Successfully enrolled ${student.fullName} in ${selectedCourseForEnrollment}! R${coursePrice} added to pending payment.`);
    loadStudentsForAdmin();
    
    // Reset form
    document.getElementById('studentSelect').value = '';
    document.querySelectorAll('.enrollment-option').forEach(o => o.classList.remove('selected'));
    selectedStudentForEnrollment = null;
    selectedCourseForEnrollment = null;
    document.getElementById('enrollmentForm').classList.add('hidden');
  } else {
    alert(`${student.fullName} is already enrolled in ${selectedCourseForEnrollment}`);
  }
});

function adminEnrollStudent(studentId) {
  selectedStudentForEnrollment = studentId;
  document.getElementById('studentSelect').value = studentId;
  document.getElementById('enrollmentForm').classList.remove('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.add('hidden');
  loadCourseOptionsForAdmin();
}

// Payment Verification
let selectedStudentForPayment = null;

document.getElementById('paymentStudentSelect').addEventListener('change', function() {
  selectedStudentForPayment = this.value;
  const student = users.find(u => u.id === this.value);
  
  if (student) {
    document.getElementById('studentPaymentInfo').classList.remove('hidden');
    document.getElementById('paymentStudentName').textContent = student.fullName;
    document.getElementById('paymentStudentEmail').textContent = student.email;
    document.getElementById('pendingAmount').textContent = (student.pendingPayment || 0).toFixed(2);
  } else {
    document.getElementById('studentPaymentInfo').classList.add('hidden');
  }
});

document.getElementById('verifyPaymentConfirmBtn').addEventListener('click', async () => {
  if (!selectedStudentForPayment) {
    alert('Please select a student');
    return;
  }
  
  const paymentRef = document.getElementById('paymentReference').value.trim();
  const paymentAmount = parseFloat(document.getElementById('paymentAmountInput').value);
  
  if (!paymentRef) {
    alert('Please enter payment reference');
    return;
  }
  
  if (!paymentAmount || paymentAmount <= 0 || isNaN(paymentAmount)) {
    alert('Please enter valid payment amount');
    return;
  }
  
  try {
    // Get current student data
    const studentDoc = await db.collection('users').doc(selectedStudentForPayment).get();
    
    if (!studentDoc.exists) {
      alert('Student not found');
      return;
    }
    
    const student = studentDoc.data();
    
    // Calculate new balance and pending payment
    const newBalance = (student.balance || 0) + paymentAmount;
    const newPending = Math.max(0, (student.pendingPayment || 0) - paymentAmount);
    
    // Update student in Firestore
    await db.collection('users').doc(selectedStudentForPayment).update({
      balance: newBalance,
      pendingPayment: newPending,
      lastPayment: {
        reference: paymentRef,
        amount: paymentAmount,
        date: new Date().toISOString()
      }
    });
    
    // Update local storage for compatibility
    const users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const userIndex = users.findIndex(u => u.id === selectedStudentForPayment || u.uid === selectedStudentForPayment);
    if (userIndex !== -1) {
      users[userIndex].balance = newBalance;
      users[userIndex].pendingPayment = newPending;
      localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
    }
    
    // If this is the current user, update their session
    if (currentUser && (currentUser.id === selectedStudentForPayment || currentUser.uid === selectedStudentForPayment)) {
      currentUser.balance = newBalance;
      currentUser.pendingPayment = newPending;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      updateUIForUser();
    }
    
    alert(`✅ Payment of R${paymentAmount} verified for ${student.fullName}!\nReference: ${paymentRef}`);
    
    // Reset form
    document.getElementById('paymentStudentSelect').value = '';
    document.getElementById('paymentReference').value = '';
    document.getElementById('paymentAmountInput').value = '';
    document.getElementById('studentPaymentInfo').classList.add('hidden');
    selectedStudentForPayment = null;
    
    // Reload students list
    loadStudentsForAdmin();
    
  } catch (error) {
    console.error("Error verifying payment:", error);
    alert("Error verifying payment. Check console for details.");
  }
});

async function verifyStudentPayment(studentId) {
  selectedStudentForPayment = studentId;
  document.getElementById('paymentStudentSelect').value = studentId;
  
  // Show payment verification section
  document.getElementById('enrollmentForm').classList.add('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.remove('hidden');
  
  try {
    // Get student data from Firestore
    const studentDoc = await db.collection('users').doc(studentId).get();
    
    if (studentDoc.exists) {
      const student = studentDoc.data();
      
      // Show student info
      document.getElementById('studentPaymentInfo').classList.remove('hidden');
      document.getElementById('paymentStudentName').textContent = student.fullName;
      document.getElementById('paymentStudentEmail').textContent = student.email;
      document.getElementById('pendingAmount').textContent = (student.pendingPayment || 0).toFixed(2);
    } else {
      alert("Student not found in database!");
      document.getElementById('studentPaymentInfo').classList.add('hidden');
    }
  } catch (error) {
    console.error("Error loading student data:", error);
    alert("Error loading student information.");
  }
}

// ========== UI UPDATES ==========
function updateUIForUser() {
  const dashboardLink = document.getElementById('dashboardLink');
  const adminLink = document.getElementById('adminLink');
  const logoutLink = document.getElementById('logoutLink');
  const loginLink = document.getElementById('loginLink');
  const registerLink = document.getElementById('registerLink');
  
  if (currentUser) {
    dashboardLink.classList.remove('hidden');
    logoutLink.classList.remove('hidden');
    loginLink.classList.add('hidden');
    registerLink.classList.add('hidden');
    
    // Show admin link if user is admin
    if (currentUser.userType === 'admin') {
      adminLink.classList.remove('hidden');
    } else {
      adminLink.classList.add('hidden');
    }
    
    // HIDE BOTH FORMS when user is logged in
    document.getElementById('loginForm').classList.remove('active');
    document.getElementById('registerForm').classList.remove('active');
    
  } else {
    dashboardLink.classList.add('hidden');
    adminLink.classList.add('hidden');
    logoutLink.classList.add('hidden');
    loginLink.classList.remove('hidden');
    registerLink.classList.remove('hidden');
  }
  
}
// ========== NAVIGATION ==========
document.getElementById("homeLink").addEventListener("click", e => {
  e.preventDefault();
  document.getElementById("home").scrollIntoView({ behavior: "smooth" });
  document.getElementById('loginForm').classList.remove('active');
  document.getElementById('registerForm').classList.remove('active');
});

document.getElementById("coursesLink").addEventListener("click", e => {
  e.preventDefault();
  document.getElementById("courses").scrollIntoView({ behavior: "smooth" });
  document.getElementById('loginForm').classList.remove('active');
  document.getElementById('registerForm').classList.remove('active');
});

document.getElementById("dashboardLink").addEventListener("click", e => {
  e.preventDefault();
  if (currentUser) {
    showDashboard();
  } else {
    showForm(document.getElementById('loginForm'));
  }
});

document.getElementById("adminLink").addEventListener("click", e => {
  e.preventDefault();
  if (currentUser && currentUser.userType === 'admin') {
    showAdminPanel();
  }
});


document.getElementById("loginLink").addEventListener("click", e => {
  e.preventDefault();
  showForm(document.getElementById('loginForm'));
});

document.getElementById("registerLink").addEventListener("click", e => {
  e.preventDefault();
  showForm(document.getElementById('registerForm'));
});

document.getElementById("logoutLink").addEventListener("click", async (e) => {
  e.preventDefault();
  try {
    await auth.signOut();
    currentUser = null;
    localStorage.removeItem('ThriveAcademy_currentUser');
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    document.getElementById('dashboard').classList.remove('active');
    document.getElementById('adminPanel').classList.remove('active');
    document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    console.error("Logout error:", error);
  }
});
document.getElementById("ctaRegister").addEventListener("click", e => {
  e.preventDefault();
  showForm(document.getElementById('registerForm'));
});

document.getElementById("switchToRegister").addEventListener("click", e => {
  e.preventDefault();
  showForm(document.getElementById('registerForm'));
});

document.getElementById("switchToLogin").addEventListener("click", e => {
  e.preventDefault();
  showForm(document.getElementById('loginForm'));
});

// Form Management
function showForm(form) {
  document.getElementById('loginForm').classList.remove('active');
  document.getElementById('registerForm').classList.remove('active');
  document.getElementById('addMaterialModal').classList.remove('active');
  document.getElementById('addMaterialModal').classList.add('hidden');
  
  form.classList.add('active');
  form.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ========== MOBILE MENU ==========
document.getElementById('hamburger').addEventListener('click', (e) => {
  e.stopPropagation();
  document.getElementById('navLinks').classList.toggle('active');
  
  const icon = document.getElementById('hamburger').querySelector('i');
  if (document.getElementById('navLinks').classList.contains('active')) {
    icon.classList.remove('fa-bars');
    icon.classList.add('fa-times');
  } else {
    icon.classList.remove('fa-times');
    icon.classList.add('fa-bars');
  }
});

document.addEventListener('click', (e) => {
  const navLinks = document.getElementById('navLinks');
  const hamburger = document.getElementById('hamburger');
  
  if (!navLinks.contains(e.target) && !hamburger.contains(e.target)) {
    navLinks.classList.remove('active');
    const icon = hamburger.querySelector('i');
    icon.classList.remove('fa-times');
    icon.classList.add('fa-bars');
  }
});

document.querySelectorAll('.nav-links a').forEach(link => {
  link.addEventListener('click', () => {
    document.getElementById('navLinks').classList.remove('active');
    const icon = document.getElementById('hamburger').querySelector('i');
    icon.classList.remove('fa-times');
    icon.classList.add('fa-bars');
  });
});


// Initial load of courses
loadCourses(1);
// ========== FIX HOME MODULES BUTTONS ==========
function fixHomeModuleButtons() {
  // Find buttons in home modules section
  const homeModulesSection = document.getElementById('homeModulesSection');
  if (!homeModulesSection) return;
  
  // Fix login buttons (with sign-in icon)
  const loginButtons = homeModulesSection.querySelectorAll('a.btn');
  loginButtons.forEach(btn => {
    if (btn.innerHTML.includes('fa-sign-in-alt')) {
      // Remove existing onclick
      btn.onclick = null;
      // Add proper event listener
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        showForm(document.getElementById('loginForm'));
      });
    }
  });
  
  // Fix register buttons (with user-plus icon)
  const registerButtons = homeModulesSection.querySelectorAll('a.btn');
  registerButtons.forEach(btn => {
    if (btn.innerHTML.includes('fa-user-plus')) {
      // Remove existing onclick
      btn.onclick = null;
      // Add proper event listener
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        showForm(document.getElementById('registerForm'));
      });
    }
  });
}

// Wrap the original updateHomePage function to add our fix
const originalUpdateHomePage = updateHomePage;
updateHomePage = function() {
  originalUpdateHomePage();
  // Fix buttons after home page is updated
  setTimeout(fixHomeModuleButtons, 100);
};

// Fix buttons on initial page load
setTimeout(fixHomeModuleButtons, 500);
// ========== FIREBASE INTEGRATION FUNCTIONS ==========
// ========== FIX MATERIAL UPLOAD BUTTONS ==========
function setupMaterialUploadButtons() {
    console.log("Setting up material upload buttons...");
    
    // Function to handle Add Material button clicks
    function handleAddMaterialClick(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Get course code from button's data attribute or onclick
        const button = event.currentTarget;
        const courseCode = button.dataset.course || 
                          (button.getAttribute('onclick') ? 
                           button.getAttribute('onclick').match(/'([^']+)'/)?.pop() : null);
        
        if (courseCode) {
            console.log("Opening add material for:", courseCode);
            openAddMaterial(courseCode);
        } else {
            console.error("Could not find course code for material button");
            alert("Error: Could not identify course. Please refresh the page.");
        }
    }
    
    // Fix all Add Material buttons on the page
    document.querySelectorAll('button.btn-success').forEach(button => {
        const buttonText = button.textContent || button.innerHTML;
        if (buttonText.includes('Add Material') || buttonText.includes('fa-plus')) {
            // Remove any existing onclick
            button.removeAttribute('onclick');
            
            // Extract course code from original onclick if it exists
            const originalOnClick = button.getAttribute('onclick');
            if (originalOnClick && originalOnClick.includes("'")) {
                const match = originalOnClick.match(/'([^']+)'/);
                if (match && match[1]) {
                    button.dataset.course = match[1];
                }
            }
            
            // If no course code in data, try to get it from parent course card
            if (!button.dataset.course) {
                const courseCard = button.closest('.course-card');
                if (courseCard) {
                    const header = courseCard.querySelector('.course-header h3');
                    if (header) {
                        // Extract course code (e.g., "MATH130" from "MATH130 Year 1")
                        const text = header.textContent || header.innerText;
                        const courseCodeMatch = text.match(/([A-Z]+\s*\d+[A-Z]*)/);
                        if (courseCodeMatch) {
                            button.dataset.course = courseCodeMatch[1].replace(/\s+/g, '');
                        }
                    }
                }
            }
            
            // Add new event listener
            button.addEventListener('click', handleAddMaterialClick);
            console.log("Fixed Add Material button for course:", button.dataset.course);
        }
    });
}

// Run this function whenever the page updates
function updatePageWithMaterialButtons() {
    // Run initially
    setTimeout(setupMaterialUploadButtons, 100);
    
    // Also run after any dynamic content loads
    const originalLoadTeacherCourses = window.loadTeacherCourses;
    window.loadTeacherCourses = function() {
        const result = originalLoadTeacherCourses.apply(this, arguments);
        setTimeout(setupMaterialUploadButtons, 300);
        return result;
    };
    
    const originalUpdateHomePage = window.updateHomePage;
    window.updateHomePage = function() {
        const result = originalUpdateHomePage.apply(this, arguments);
        setTimeout(setupMaterialUploadButtons, 300);
        return result;
    };
    
    const originalLoadCourses = window.loadCourses;
    window.loadCourses = function(year) {
        const result = originalLoadCourses.apply(this, arguments);
        setTimeout(setupMaterialUploadButtons, 300);
        return result;
    };
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updatePageWithMaterialButtons, 500);
});
// Ensure getYearName function is available
if (typeof getYearName !== 'function') {
  function getYearName(year) {
    const yearNames = { '1': '1st Year', '2': '2nd Year', 'mixed': 'Mixed (1st & 2nd Year)' };
    return yearNames[year] || year || 'Not specified';
  }
  // Make it available globally
  window.getYearName = getYearName;
}

// Function to load students from Firebase (will be called from Firebase script)
window.loadStudentsFromFirebase = async function() {
  console.log("Fallback: loadStudentsFromFirebase not implemented yet");
  return [];
};

// Function to display students from Firebase (will be called from Firebase script)
window.displayStudentsFromFirebase = async function() {
  console.log("Fallback: displayStudentsFromFirebase not implemented yet");
  return [];
};

// Save the original function
const originalLoadStudentsForAdmin = window.loadStudentsForAdmin;

// Override to use Firebase when available
// ========== LOAD STUDENTS FUNCTION WITH FIREBASE SUPPORT ==========
window.loadStudentsForAdmin = async function() {
  console.log("loadStudentsForAdmin called");
  // Add event listener for the Add Material button
document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('btn-success') && 
        e.target.textContent.includes('Add Material') && 
        document.getElementById('addMaterialModal') && 
        document.getElementById('addMaterialModal').classList.contains('active')) {
        
        e.preventDefault();
        e.stopPropagation();
        uploadMaterial();
    }
});
  try {
    // First try Firebase
    if (typeof window.displayStudentsFromFirebase === 'function' && window.db) {
      console.log("Using Firebase to load students");
      
      // Load student dropdowns
      const students = await window.loadStudentsFromFirebase();
      
      const studentSelect = document.getElementById('studentSelect');
      const paymentStudentSelect = document.getElementById('paymentStudentSelect');
      
      if (studentSelect && paymentStudentSelect) {
        studentSelect.innerHTML = '<option value="">Select a student</option>';
        paymentStudentSelect.innerHTML = '<option value="">Select a student</option>';
        
        students.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.fullName} (${student.email}) - ${window.getYearName(student.yearLevel || '')}`;
          
          studentSelect.appendChild(option.cloneNode(true));
          paymentStudentSelect.appendChild(option);
        });
      }
      
      // Display in the list if visible
      const studentsList = document.getElementById('studentsList');
      if (studentsList && !studentsList.classList.contains('hidden')) {
        await window.displayStudentsFromFirebase();
      }
      
      return students;
      
    } else {
      // Fallback to local storage
      console.log("Firebase not available, using local storage");
      return loadStudentsFromLocalStorage();
    }
  } catch (error) {
    console.error("Error loading students:", error);
    return loadStudentsFromLocalStorage();
  }
};

// Local storage fallback function
function loadStudentsFromLocalStorage() {
  const students = users.filter(u => u.userType === 'student');
  const studentSelect = document.getElementById('studentSelect');
  const paymentStudentSelect = document.getElementById('paymentStudentSelect');
  const studentsContainer = document.getElementById('studentsContainer');
  
  // Update student select dropdowns
  if (studentSelect && paymentStudentSelect) {
    studentSelect.innerHTML = '<option value="">Select a student</option>';
    paymentStudentSelect.innerHTML = '<option value="">Select a student</option>';
    
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = `${student.fullName} (${student.email}) - ${getYearName(student.yearLevel)}`;
      studentSelect.appendChild(option.cloneNode(true));
      paymentStudentSelect.appendChild(option);
    });
  }
  
  // Update students list if visible
  if (studentsContainer && document.getElementById('studentsList') && 
      !document.getElementById('studentsList').classList.contains('hidden')) {
    studentsContainer.innerHTML = '';
    students.forEach(student => {
      const studentItem = document.createElement('div');
      studentItem.className = 'student-item';
      studentItem.innerHTML = `
        <div>
          <strong>${student.fullName}</strong>
          <p style="color: #6b7280; font-size: 0.9rem;">${student.email} - ${getYearName(student.yearLevel)}</p>
          <p style="font-size: 0.9rem;">Enrolled in: ${student.enrolledCourses ? student.enrolledCourses.join(', ') : 'None'}</p>
          <p style="font-size: 0.9rem; color: ${student.pendingPayment > 0 ? '#ef4444' : '#10b981'}">
            Balance: R${(student.balance || 0).toFixed(2)} | Pending: R${(student.pendingPayment || 0).toFixed(2)}
          </p>
        </div>
        <div>
          <button class="btn" onclick="adminEnrollStudent('${student.id}')" style="margin-right: 10px;">Enroll</button>
          <button class="btn btn-warning" onclick="verifyStudentPayment('${student.id}')">Verify Payment</button>
        </div>
      `;
      studentsContainer.appendChild(studentItem);
    });
  }
  
  return students;
}

// Make sure these functions are available globally
window.adminEnrollStudent = function(studentId) {
  console.log("adminEnrollStudent called with:", studentId);
  selectedStudentForEnrollment = studentId;
  const studentSelect = document.getElementById('studentSelect');
  if (studentSelect) {
    studentSelect.value = studentId;
  }
  document.getElementById('enrollmentForm').classList.remove('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.add('hidden');
  loadCourseOptionsForAdmin();
};

window.verifyStudentPayment = function(studentId) {
  console.log("verifyStudentPayment called with:", studentId);
  selectedStudentForPayment = studentId;
  const paymentSelect = document.getElementById('paymentStudentSelect');
  if (paymentSelect) {
    paymentSelect.value = studentId;
  }
  document.getElementById('enrollmentForm').classList.add('hidden');
  document.getElementById('studentsList').classList.add('hidden');
  document.getElementById('paymentVerification').classList.remove('hidden');
  
  // Trigger change event
  setTimeout(() => {
    const event = new Event('change');
    paymentSelect.dispatchEvent(event);
  }, 100);
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log("Firebase integration loaded");
    // Check user sync on page load
  setTimeout(() => {
    if (currentUser && window.db) {
      checkUserSyncOnLoad();
    }
  }, 2000);

});
// ========== COURSE MATERIALS MODAL FUNCTIONS ==========
let currentCourseForView = '';

function openCourseMaterials(courseCode) {
  currentCourseForView = courseCode;
  
  // Find course details
  let courseDetails = null;
  for (const year in coursesData) {
    const course = coursesData[year].find(c => c.code === courseCode);
    if (course) {
      courseDetails = course;
      break;
    }
  }
  
  // Check if user is enrolled (for students) or is teacher/admin
  let canAccessMaterials = false;
  let isEnrolled = false;
  
  if (currentUser) {
    if (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) {
      // Student: Check if enrolled in this course
      isEnrolled = currentUser.enrolledCourses && currentUser.enrolledCourses.includes(courseCode);
      canAccessMaterials = isEnrolled;
    } else if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
      // Teacher: Check if they teach this course
      const teachesCourse = currentUser.specialization && currentUser.specialization.includes(courseCode);
      canAccessMaterials = teachesCourse || currentUser.userType === 'admin';
    } else if (currentUser.userType === 'admin' && adminMode === 'admin') {
      // Admin in admin mode: Can access all materials
      canAccessMaterials = true;
    }
  }
  
  // Load materials for this course
  const courseMaterials = materials.filter(m => m.courseCode === courseCode);
  
  // Create and show modal
  const modalHTML = `
    <div id="courseMaterialsModal" class="form-container active">
      <div class="form-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>${courseDetails?.code || courseCode} - Course Materials</h2>
          <button class="btn btn-secondary" onclick="closeCourseMaterials()" style="padding: 5px 15px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        ${courseDetails ? `
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="color: #4f46e5; margin-bottom: 5px;">${courseDetails.name}</h4>
            <p style="color: #6b7280; margin-bottom: 5px;">Teacher: ${courseDetails.teacher}</p>
            <p style="color: #6b7280;">${courseDetails.description || 'No description available'}</p>
          </div>
        ` : ''}
        
        ${!currentUser ? `
          <div style="text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 8px; margin: 20px 0;">
            <i class="fas fa-lock" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
            <h4 style="color: #6b7280; margin-bottom: 10px;">Login Required</h4>
            <p style="color: #9ca3af; margin-bottom: 20px;">Please login to view course materials.</p>
            <button class="btn" onclick="closeCourseMaterials(); showForm(document.getElementById('loginForm'));">
              <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
          </div>
        ` : !canAccessMaterials ? `
          <div style="text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 8px; margin: 20px 0;">
            ${currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student') ? `
              <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
              <h4 style="color: #6b7280; margin-bottom: 10px;">Enrollment Required</h4>
              <p style="color: #9ca3af; margin-bottom: 20px;">You need to enroll in this course to access the materials.</p>
              <button class="btn" onclick="closeCourseMaterials(); selectCourseForPayment('${courseCode}', ${courseDetails?.price || 250});">
                <i class="fas fa-shopping-cart"></i> Enroll Now (R${courseDetails?.price || 250})
              </button>
            ` : `
              <i class="fas fa-user-lock" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
              <h4 style="color: #6b7280; margin-bottom: 10px;">Access Denied</h4>
              <p style="color: #9ca3af;">You don't have permission to view these materials.</p>
            `}
          </div>
        ` : `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>Study Materials (${courseMaterials.length})</h3>
              ${currentUser && ((currentUser.userType === 'teacher' && currentUser.specialization && currentUser.specialization.includes(courseCode)) || 
                 (currentUser.userType === 'admin' && adminMode === 'teacher')) ? `
                <button class="btn btn-success" onclick="openAddMaterial('${courseCode}')" style="padding: 8px 15px;">
                  <i class="fas fa-plus"></i> Add Material
                </button>
              ` : ''}
            </div>
            
            ${courseMaterials.length > 0 ? `
              <div class="materials-container">
                ${courseMaterials.map(material => `
                  <div class="material-item">
                    <div>
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas ${getMaterialIcon(material.type)}" style="color: #4f46e5; font-size: 1.2rem;"></i>
                        <div>
                          <h4 style="margin: 0 0 5px 0; font-size: 1rem;">${material.title}</h4>
                          <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="material-type">
                              ${material.type.replace('_', ' ')}
                            </span>
                            <span style="color: #6b7280; font-size: 0.8rem;">
                              <i class="far fa-clock"></i> ${formatDate(material.addedAt)}
                            </span>
                            <span style="color: #6b7280; font-size: 0.8rem;">
                              <i class="fas fa-user"></i> ${material.addedBy}
                            </span>
                          </div>
                        </div>
                      </div>
                      ${material.description ? `<p style="margin: 10px 0 0 0; color: #6b7280; font-size: 0.9rem;">${material.description}</p>` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                      ${material.link ? `
                        <button class="btn" onclick="downloadMaterial('${material.id}')" style="padding: 8px 15px;">
                          <i class="fas fa-download"></i> Download
                        </button>
                      ` : `
                        <button class="btn" disabled style="padding: 8px 15px; opacity: 0.6;">
                          <i class="fas fa-download"></i> No File
                        </button>
                      `}
                      
                      ${(currentUser && ((currentUser.userType === 'teacher' && currentUser.specialization && currentUser.specialization.includes(courseCode)) || 
                         (currentUser.userType === 'admin' && adminMode === 'teacher')) ||
                         currentUser?.userType === 'admin') ? `
                        <button class="btn btn-danger" onclick="deleteMaterial('${material.id}')" style="padding: 8px 15px;">
                          <i class="fas fa-trash"></i>
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div style="text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 8px; margin-top: 15px;">
                <i class="fas fa-folder-open" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                <h4 style="color: #6b7280; margin-bottom: 10px;">No Materials Yet</h4>
                <p style="color: #9ca3af;">Materials will appear here once uploaded by the teacher.</p>
              </div>
            `}
          </div>
        `}
        
        ${currentUser && (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) && !isEnrolled ? `
          <div class="form-switch" style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center;">
            <button class="btn" onclick="closeCourseMaterials(); selectCourseForPayment('${courseCode}', ${courseDetails?.price || 250});" style="width: 100%;">
              <i class="fas fa-shopping-cart"></i> Enroll Now to Access Materials (R${courseDetails?.price || 250})
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Add modal to page
  const modalContainer = document.createElement('div');
  modalContainer.innerHTML = modalHTML;
  document.body.appendChild(modalContainer);
  
  // Add overlay
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay active';
  overlay.id = 'materialsModalOverlay';
  overlay.onclick = closeCourseMaterials;
  document.body.appendChild(overlay);
  
  // Prevent scrolling on body
  document.body.style.overflow = 'hidden';
}

function closeCourseMaterials() {
  const modal = document.getElementById('courseMaterialsModal');
  const overlay = document.getElementById('materialsModalOverlay');
  
  if (modal) modal.remove();
  if (overlay) overlay.remove();
  
  document.body.style.overflow = '';
}

function getMaterialIcon(type) {
  const icons = {
    'notes': 'fa-file-alt',
    'video': 'fa-video',
    'assignment': 'fa-tasks',
    'past_paper': 'fa-file-pdf',
    'exercise': 'fa-running',
    'other': 'fa-file'
  };
  return icons[type] || 'fa-file';
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}


async function loadCourseMaterials(courseCode) {
    try {
        if (!window.supabase) {
            console.warn("Supabase not available");
            return [];
        }
        
        console.log(`Loading materials for course: ${courseCode}`);
        
        // ✅ FILTER BY COURSE CODE
        const { data, error } = await window.supabase
            .from('materials')
            .select('*')
            .eq('course_code', courseCode)  // ← THIS IS CRITICAL
            .order('uploaded_at', { ascending: false });
        
        if (error) {
            console.error("Supabase error:", error);
            return [];
        }
        
        console.log(`Loaded ${data.length} materials for course ${courseCode}`);
        
        // Transform to your format
        return data.map(item => ({
            id: item.id,
            courseCode: item.course_code,
            title: item.title,
            type: item.type,
            description: item.description,
            file_url: item.file_url,
            file_name: item.file_name,
            file_size: item.file_size,
            file_type: item.file_type,
            addedBy: item.uploaded_by,
            addedAt: item.uploaded_at,
            downloadUrl: item.file_url
        }));
        
    } catch (error) {
        console.error(`Error loading materials for course ${courseCode}:`, error);
        return [];
    }
}
// Load materials from Supabase (no Firebase)
async function loadMaterialsFromSupabase() {
    try {
        if (!window.supabase) {
            console.warn("Supabase not available");
            return;
        }
        
        console.log("Loading materials from Supabase...");
        
        const { data, error } = await window.supabase
            .from('materials')
            .select('*')
            .order('uploaded_at', { ascending: false });
        
        if (error) {
            console.error("Supabase error:", error);
            return;
        }
        
        console.log(`Loaded ${data.length} materials from Supabase`);
        
        // Update local materials array
        window.materials = data.map(item => ({
            id: item.id,
            courseCode: item.course_code,
            title: item.title,
            type: item.type,
            description: item.description,
            file_url: item.file_url,  // ✅ This is the Supabase URL
            file_name: item.file_name,
            file_size: item.file_size,
            file_type: item.file_type,
            addedBy: item.uploaded_by,
            addedAt: item.uploaded_at,
            // For compatibility:
            downloadUrl: item.file_url  // Map to old field name if needed
        }));
        
        // Save to localStorage
        localStorage.setItem('ThriveAcademy_materials', JSON.stringify(window.materials));
        
        return window.materials;
        
    } catch (error) {
        console.error("Error loading materials:", error);
        return window.materials || [];
    }
}
// ========== PURE SUPABASE DOWNLOAD FUNCTION ==========
async function downloadMaterial(materialId) {
    console.log("📥 SUPABASE DOWNLOAD (NO FIREBASE)");
    
    // Find material
    const material = materials.find(m => m.id === materialId);
    
    if (!material) {
        console.error("Material not found:", materialId);
        alert("❌ Material not found");
        return;
    }
    
    console.log("Found material:", material);
    
    // Check for Supabase file URL
    if (material.file_url) {
        console.log("Using Supabase URL:", material.file_url);
        
        // Create download link
        const link = document.createElement('a');
        link.href = material.file_url;
        
        // Set download filename
        const fileName = material.file_name || 
                         material.fileName || 
                         `${material.title.replace(/[^a-z0-9]/gi, '_')}.${getFileExtension(material.type)}`;
        link.download = fileName;
        
        // Open in new tab for viewing, download for saving
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        
        // Add to page, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log(`✅ Download initiated: ${fileName}`);
        return;
    }
    
    // Check for any other URL
    if (material.link) {
        console.log("Opening link:", material.link);
        window.open(material.link, '_blank');
        return;
    }
    
    // If no URL at all
    console.error("No file URL found for material:", material);
    alert(`❌ No file available for: ${material.title}\n\nPlease contact the teacher.`);
}

// Helper function
function getFileExtension(type) {
    const extensions = {
        'notes': 'pdf',
        'video': 'mp4',
        'assignment': 'pdf',
        'past_paper': 'pdf',
        'exercise': 'pdf',
        'other': 'txt'
    };
    return extensions[type] || 'txt';
}
// ========== SIMPLE OPEN FILE FUNCTION ==========
// ========== SUPABASE OPEN FILE FUNCTION ==========
function openMaterialFile(materialId) {
    console.log("📂 Opening material:", materialId);
    
    const material = materials.find(m => m.id === materialId);
    
    if (!material) {
        alert("❌ Material not found");
        return;
    }
    
    // Use Supabase URL
    const fileUrl = material.file_url || material.link;
    
    if (!fileUrl) {
        alert(`❌ No file available for: ${material.title}`);
        return;
    }
    
    console.log("Opening:", fileUrl);
    window.open(fileUrl, '_blank');
}


      
// Helper function
function getFileExtension(type) {
    const extensions = {
        'notes': 'pdf',
        'video': 'mp4',
        'assignment': 'pdf',
        'past_paper': 'pdf',
        'exercise': 'pdf',
        'other': 'txt'
    };
    return extensions[type] || 'txt';
}
// Helper function to get file extension
function getFileExtension(type) {
    const extensions = {
        'notes': 'pdf',
        'video': 'mp4',
        'assignment': 'docx',
        'past_paper': 'pdf',
        'exercise': 'pdf',
        'other': 'txt'
    };
    return extensions[type] || 'txt';
}
// Helper function to create demo files
function createDemoMaterialFile(material) {
  console.log("Creating demo file for:", material.title);
  
  // Determine file type and content
  let fileName, fileContent, fileType;
  
  switch(material.type) {
    case 'notes':
      fileName = `${material.title}_Notes.txt`;
      fileContent = `THRIVE ACADEMY - STUDY NOTES\n\nCourse: ${material.courseCode}\nTitle: ${material.title}\n\n${material.description || 'Study notes for this course.'}\n\n---\nThis is a demo file. In the real system, this would be actual study notes.`;
      fileType = 'text/plain';
      break;
      
    case 'video':
      fileName = `${material.title}_Video_Link.txt`;
      fileContent = `Video Lecture Link\n\nCourse: ${material.courseCode}\nTitle: ${material.title}\n\nVideo URL would be here: ${material.link || 'No link provided'}\n\nDescription: ${material.description || 'Video lecture material'}`;
      fileType = 'text/plain';
      break;
      
    case 'assignment':
      fileName = `${material.title}_Assignment.pdf`;
      fileContent = `PDF CONTENT FOR: ${material.title}\n\nThis would be a PDF assignment file.`;
      fileType = 'application/pdf';
      break;
      
    case 'past_paper':
      fileName = `${material.title}_Past_Paper.pdf`;
      fileContent = `PAST PAPER: ${material.title}\n\nYear: 2023\nCourse: ${material.courseCode}\n\nQuestions and answers would appear here.`;
      fileType = 'application/pdf';
      break;
      
    default:
      fileName = `${material.title}.txt`;
      fileContent = `THRIVE ACADEMY MATERIAL\n\nCourse: ${material.courseCode}\nTitle: ${material.title}\nType: ${material.type}\n\n${material.description || 'Study material'}`;
      fileType = 'text/plain';
  }
  
  // Create download link
  const blob = new Blob([fileContent], { type: fileType });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = fileName;
  link.style.display = 'none';
  
  document.body.appendChild(link);
  link.click();
  
  // Clean up
  setTimeout(() => {
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    console.log("Download completed for:", fileName);
  }, 100);
}
function getFileExtension(type) {
  const extensions = {
    'notes': 'pdf',
    'video': 'mp4',
    'assignment': 'docx',
    'past_paper': 'pdf',
    'exercise': 'pdf',
    'other': 'txt'
  };
  return extensions[type] || 'txt';
}



// Generate unique student access codes
function generateAccessCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

// Admin: Create student access codes
// ========== ADMIN: CREATE STUDENT ACCESS CODE (FIXED FOR FIREBASE) ==========
// ========== CREATE STUDENT ACCESS CODE - FIXED VERSION ==========
        // STEP 2: Save to Firestore users collection
        const userData = {
            fullName: studentName,
            email: studentEmail,
            userType: 'student',
            yearLevel: 'mixed',
            enrolledCourses: selectedModules,
            accessCode: accessCode,
            status: 'active',  // FIXED: Added comma here
            pendingPayment: totalPrice,
            balance: 0,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            authMethod: 'access_code'
        };

// Student access code login
document.getElementById('accessCodeLoginBtn').addEventListener('click', function() {
    const accessCode = document.getElementById('studentAccessCode').value.trim().toUpperCase();
    
    if (!accessCode || accessCode.length !== 6) {
        alert("Please enter a valid 6-digit access code");
        return;
    }
    
    // Show loading
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    this.disabled = true;
    
    // Check in localStorage
    const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
    const student = students.find(s => s.accessCode === accessCode);
    
    if (student) {
        // LOGIN SUCCESS
        currentUser = student;
        localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
        
        // Update UI
        updateUIForUser();
        updateHomePage();
        updateCoursesDisplay();
        
        // Close login form
        document.getElementById('loginForm').classList.remove('active');
        
        // Show dashboard
        showDashboard();
        
        alert(`✅ Welcome ${student.fullName}!\n\nYou are enrolled in: ${student.enrolledCourses?.join(', ') || 'No modules yet'}`);
    } else {
        alert("❌ Invalid access code. Please check your code and try again.");
    }
    
    // Reset button
    this.innerHTML = 'Access';
    this.disabled = false;
});
// Cancel button
document.getElementById('cancelTeacherBtn').addEventListener('click', function() {
  document.getElementById('teacherCreationForm').classList.add('hidden');
  adminTeacherSelectedModules = [];
  updateAdminTeacherSelectionCount();
});

// Load modules for admin to assign
function loadAdminTeacherModules() {
  const container = document.getElementById('adminTeacherModules');
  if (!container) return;
  
  // Combine all modules
  let allCourses = [...coursesData[1], ...coursesData[2]];
  
  container.innerHTML = '';
  
  allCourses.forEach(course => {
    const option = document.createElement('div');
    option.className = 'teacher-module-option';
    option.dataset.code = course.code;
    option.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>${course.code}</strong>
          <div style="color: #6b7280; font-size: 0.9rem;">${course.name}</div>
          <div style="font-size: 0.8rem; color: #4f46e5;">Year ${course.year}</div>
        </div>
        <div style="color: #6b7280; font-size: 0.8rem;">Click to select</div>
      </div>
    `;
    
    option.addEventListener('click', function() {
      toggleAdminTeacherModule(course.code, this);
    });
    
    container.appendChild(option);
  });
  
  updateAdminTeacherSelectionCount();
}

// Toggle module selection
function toggleAdminTeacherModule(courseCode, element) {
  const index = adminTeacherSelectedModules.indexOf(courseCode);
  
  if (index === -1) {
    // Add module
    adminTeacherSelectedModules.push(courseCode);
    element.classList.add('selected');
    element.querySelector('div > div:last-child').innerHTML = '✓ Selected';
    element.querySelector('div > div:last-child').style.color = '#10b981';
  } else {
    // Remove module
    adminTeacherSelectedModules.splice(index, 1);
    element.classList.remove('selected');
    element.querySelector('div > div:last-child').innerHTML = 'Click to select';
    element.querySelector('div > div:last-child').style.color = '#6b7280';
  }
  
  updateAdminTeacherSelectionCount();
}

function updateAdminTeacherSelectionCount() {
  document.getElementById('adminSelectedCount').textContent = adminTeacherSelectedModules.length;
}

// Create teacher account
// ========== CREATE TEACHER ACCOUNT WITH FIREBASE AUTH ==========
document.getElementById('confirmCreateTeacherBtn').addEventListener('click', async function() {
  const fullName = document.getElementById('teacherFullName').value.trim();
  const email = document.getElementById('teacherEmail').value.trim();
  const password = document.getElementById('teacherPassword').value;
  
  // Validation
  if (!fullName || fullName.length < 2) {
    alert('Please enter teacher\'s full name');
    return;
  }
  
  if (!email || !validateEmail(email)) {
    alert('Please enter a valid email address');
    return;
  }
  
  if (users.some(u => u.email === email)) {
    alert('This email is already registered');
    return;
  }
  
  if (!password || password.length < 6) {
    alert('Password must be at least 6 characters');
    return;
  }
  
  if (adminTeacherSelectedModules.length === 0) {
    alert('Please assign at least one teaching module to the teacher');
    return;
  }
  
  // Show loading
  const originalText = this.innerHTML;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Teacher...';
  this.disabled = true;
  
  try {
    // CREATE FIREBASE AUTH USER (This is CRITICAL for login)
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const firebaseUser = userCredential.user;
    console.log('Firebase Auth teacher created:', firebaseUser.uid);
    
    // Create teacher account object
    const teacherId = 'teacher_' + Date.now();
    const newTeacher = {
      id: teacherId,
      firebaseUID: firebaseUser.uid,
      fullName,
      email,
      userType: 'teacher',
      password: password, // Store for local login fallback
      specialization: [...adminTeacherSelectedModules],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      balance: 0,
      status: 'active',
      authProvider: 'email/password'
    };
    
    // Save to Firestore (without password)
    const firestoreTeacher = { ...newTeacher };
    delete firestoreTeacher.password; // Don't store password in Firestore
    
    if (window.db && window.collection && window.addDoc) {
      const usersRef = collection(db, "users");
      const docRef = await addDoc(usersRef, firestoreTeacher);
      console.log('Teacher saved to Firestore with ID:', docRef.id);
      newTeacher.firestoreId = docRef.id;
    }
    
    // Save to localStorage for offline use
    users.push(newTeacher);
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
    
    // Reset form
    document.getElementById('teacherFullName').value = '';
    document.getElementById('teacherEmail').value = '';
    document.getElementById('teacherPassword').value = '';
    adminTeacherSelectedModules = [];
    updateAdminTeacherSelectionCount();
    document.getElementById('teacherCreationForm').classList.add('hidden');
    
    // Clear module selections visually
    document.querySelectorAll('#adminTeacherModules .teacher-module-option.selected').forEach(el => {
      el.classList.remove('selected');
      el.querySelector('div > div:last-child').innerHTML = 'Click to select';
      el.querySelector('div > div:last-child').style.color = '#6b7280';
    });
    
    // Show success with login credentials
    alert(`✅ Teacher account created successfully!\n\nTEACHER LOGIN CREDENTIALS:\n-------------------------\nEmail: ${email}\nPassword: ${password}\n\nAssigned modules: ${newTeacher.specialization.join(', ')}\n\nIMPORTANT: They must use these exact credentials to login.`);
    
  } catch (error) {
    console.error('Error creating teacher:', error);
    
    // User-friendly error messages
    let errorMessage = 'Error creating teacher account: ';
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = '❌ This email is already registered in Firebase. Please use a different email or ask the teacher to use "Forgot Password".';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = '❌ Password is too weak. Please use a stronger password (at least 6 characters).';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = '❌ Invalid email address format.';
    } else {
      errorMessage += error.message;
    }
    
    alert(errorMessage);
    
    // Try to delete any partially created Firebase user
    try {
      if (window.auth && auth.currentUser) {
        await auth.currentUser.delete();
      }
    } catch (deleteError) {
      console.error("Could not delete partial user:", deleteError);
    }
  } finally {
    // Reset button
    this.innerHTML = originalText;
    this.disabled = false;
  }
});
// ========== GOOGLE LOGIN/REGISTRATION ==========
document.getElementById('googleRegisterBtn')?.addEventListener('click', async function() {
  console.log("Google registration clicked");
  
  // Show loading
  const originalText = this.innerHTML;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting to Google...';
  this.disabled = true;
  
  try {
    // Check if Firebase is available
    if (!window.auth || !window.GoogleAuthProvider || !window.signInWithPopup) {
      throw new Error("Google authentication not available");
    }
    
    const provider = new GoogleAuthProvider();
    
    // Optional: Request additional permissions
    provider.addScope('email');
    provider.addScope('profile');
    
    // Sign in with Google popup
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    
    console.log("Google user:", user);
    
    // Check if user already exists in our system
    let existingUser = null;
    
    // Try to find in Firebase
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", user.email));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0];
        existingUser = { id: doc.id, ...doc.data() };
        console.log("Existing user found:", existingUser);
      }
    }
    
    // If user doesn't exist, create new student account
    if (!existingUser) {
      console.log("Creating new student account from Google...");
      
      const newStudent = {
        id: user.uid,
        fullName: user.displayName || user.email.split('@')[0],
        email: user.email,
        userType: 'student',
        yearLevel: 'mixed', // Default to mixed year
        enrolledCourses: [],
        selectedModules: [],
        pendingPayment: 0,
        balance: 0,
        googleId: user.uid,
        photoURL: user.photoURL,
        authProvider: 'google',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        status: 'active'
      };
      
      // Save to Firestore
      if (window.db && window.collection && window.addDoc) {
        const usersRef = collection(db, "users");
        await addDoc(usersRef, newStudent);
        console.log("New student saved to Firestore");
        
        // Update with Firestore ID
        const q = query(collection(db, "users"), where("email", "==", user.email));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          newStudent.firestoreId = doc.id;
        }
      }
      
      // Save to localStorage for offline use
      users.push(newStudent);
      localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
      
      // Set as current user
      currentUser = newStudent;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      
      console.log("New student created:", newStudent);
      
      // Show success and redirect
      
      
    } else {
      // User exists, log them in
      console.log("Existing user logging in:", existingUser);
      currentUser = existingUser;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      
      
    }
    
    // Close registration form
    document.getElementById('registerForm').classList.remove('active');
    
    // Update UI
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    
    // Show dashboard
    showDashboard();
    
  } catch (error) {
    console.error("Google authentication error:", error);
    
    // Show user-friendly error
    let errorMessage = "Google authentication failed. ";
    
    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage += "You closed the Google popup.";
    } else if (error.code === 'auth/account-exists-with-different-credential') {
      errorMessage += "This email is already registered with another method.";
    } else {
      errorMessage += error.message;
    }
    
    alert("❌ " + errorMessage);
    
    // Reset button
    this.innerHTML = originalText;
    this.disabled = false;
  }
});
// ========== FIX EXISTING TEACHER LOGIN ==========
document.getElementById('fixTeacherLoginBtn')?.addEventListener('click', async function() {
  const teacherEmail = prompt("Enter the teacher's email who can't login:");
  
  if (!teacherEmail) return;
  
  // Show loading
  const originalText = this.innerHTML;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
  this.disabled = true;
  
  try {
    // Find teacher in local storage
    const teacher = users.find(u => u.email === teacherEmail && u.userType === 'teacher');
    
    if (!teacher) {
      alert('❌ Teacher not found with email: ' + teacherEmail);
      this.innerHTML = originalText;
      this.disabled = false;
      return;
    }
    
    const action = prompt(
      `Choose action for ${teacherEmail}:\n\n` +
      `1. Create new Firebase account (if never created)\n` +
      `2. Reset password\n` +
      `3. Check account status\n\n` +
      `Enter 1, 2, or 3:`
    );
    
    if (action === '1') {
      // Create Firebase Auth account
      const newPassword = prompt(`Enter new password for ${teacherEmail} (min 6 chars):`);
      
      if (!newPassword || newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        this.innerHTML = originalText;
        this.disabled = false;
        return;
      }
      
      try {
        // Create Firebase Auth user
        const userCredential = await createUserWithEmailAndPassword(auth, teacherEmail, newPassword);
        const firebaseUser = userCredential.user;
        
        // Update teacher record
        teacher.firebaseUID = firebaseUser.uid;
        
        // Update in Firestore if exists
        if (window.db) {
          const q = query(collection(db, "users"), where("email", "==", teacherEmail));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            await updateDoc(doc.ref, { 
              firebaseUID: firebaseUser.uid,
              updatedAt: new Date().toISOString()
            });
          }
        }
        
        // Update local storage
        localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
        
        alert(`✅ Firebase account created for ${teacherEmail}\n\nNEW PASSWORD: ${newPassword}\n\nGive this password to the teacher. They can now login.`);
        
      } catch (firebaseError) {
        if (firebaseError.code === 'auth/email-already-in-use') {
          alert('⚠️ This email already has a Firebase account.\n\nChoose option 2 to reset password instead.');
        } else {
          throw firebaseError;
        }
      }
      
    } else if (action === '2') {
      // Reset password
      const newPassword = prompt(`Enter NEW password for ${teacherEmail} (min 6 chars):`);
      
      if (!newPassword || newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        this.innerHTML = originalText;
        this.disabled = false;
        return;
      }
      
      // Update password in local storage
      teacher.password = newPassword;
      localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
      
      // Note: In Firebase, password reset requires backend or user action
      alert(`✅ Password updated in local system for ${teacherEmail}\n\nNEW PASSWORD: ${newPassword}\n\nTeacher can now login with this password.\n\nNote: If they still can't login, they may need to:\n1. Use "Forgot Password" on login page\n2. Or you need to create Firebase account (option 1)`);
      
    } else if (action === '3') {
      // Check account status
      let status = `ACCOUNT STATUS for ${teacherEmail}:\n\n`;
      status += `Name: ${teacher.fullName}\n`;
      status += `User Type: ${teacher.userType}\n`;
      status += `Has Firebase UID: ${teacher.firebaseUID ? 'YES' : 'NO'}\n`;
      status += `Modules: ${teacher.specialization ? teacher.specialization.join(', ') : 'None'}\n`;
      status += `Created: ${teacher.createdAt ? new Date(teacher.createdAt).toLocaleDateString() : 'Unknown'}\n\n`;
      
      if (!teacher.firebaseUID) {
        status += '⚠️ ISSUE: No Firebase account exists.\n';
        status += 'SOLUTION: Use option 1 to create Firebase account.';
      } else {
        status += '✓ Firebase account exists.\n';
        status += 'If login fails, use option 2 to reset password.';
      }
      
      alert(status);
      
    } else {
      alert('Cancelled');
    }
    
  } catch (error) {
    console.error("Fix teacher login error:", error);
    alert("❌ Error: " + error.message);
  } finally {
    // Reset button
    this.innerHTML = originalText;
    this.disabled = false;
  }
});
// ========== HELPER FUNCTIONS FOR CROSS-DEVICE LOGIN ==========

// Sync user data to local storage
async function syncUserToLocalStorage(user) {
  try {
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    
    // Remove existing user with same email
    const filteredUsers = localUsers.filter(u => u.email !== user.email);
    
    // Add/update user
    filteredUsers.push(user);
    
    // Save to local storage
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(filteredUsers));
    
    // Update global users array
    window.users = filteredUsers;
    
    console.log('✅ User synced to local storage');
    return true;
    
  } catch (error) {
    console.error('Sync error:', error);
    return false;
  }
}

// Upgrade local user to Firestore
async function upgradeLocalUserToFirestore(user, password) {
  try {
    if (!window.db || !window.auth) return false;
    
    // Check if already in Firestore
    const q = query(collection(db, "users"), where("email", "==", user.email));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      // Already exists in Firestore
      console.log('User already in Firestore');
      return true;
    }
    
    // Create Firebase Auth account
    let firebaseUID = user.firebaseUID;
    
    if (!firebaseUID && window.createUserWithEmailAndPassword) {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, user.email, password);
        firebaseUID = userCredential.user.uid;
        console.log('Created Firebase Auth account');
      } catch (authError) {
        if (authError.code === 'auth/email-already-in-use') {
          console.log('Firebase account already exists');
        } else {
          throw authError;
        }
      }
    }
    
    // Prepare Firestore data
    const firestoreUser = { ...user };
    delete firestoreUser.password;
    
    if (firebaseUID) {
      firestoreUser.firebaseUID = firebaseUID;
      firestoreUser.authProvider = 'email/password';
    }
    
    firestoreUser.updatedAt = new Date().toISOString();
    
    // Save to Firestore
    const usersRef = collection(db, "users");
    const docRef = await addDoc(usersRef, firestoreUser);
    
    // Update local user
    user.firestoreId = docRef.id;
    if (firebaseUID) user.firebaseUID = firebaseUID;
    
    // Update local storage
    await syncUserToLocalStorage(user);
    
    console.log('✅ Local user upgraded to Firestore');
    return true;
    
  } catch (error) {
    console.error('Upgrade error:', error);
    return false;
  }
}

// Check and fix user sync on page load
async function checkUserSyncOnLoad() {
  if (!currentUser || !window.db) return;
  
  try {
    console.log('Checking user sync on page load...');
    
    //Check if user exists in Firestore
    const q = query(collection(db, "users"), where("email", "==", currentUser.email));
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      console.log('Current user not in Firestore, attempting to save...');
      
      //Save current user to Firestore
      const firestoreUser = { ...currentUser };
      delete firestoreUser.password;
      
      const usersRef = collection(db, "users");
      const docRef = await addDoc(usersRef, firestoreUser);
      currentUser.firestoreId = docRef.id;
      
      //Update local storage
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
      
      console.log('✅ User saved to Firestore');
    }
    
  } catch (error) {
    console.error('Sync check error:', error);
  }
}
// ========== CANCEL BUTTON FUNCTIONALITY ==========

// Cancel Login Button
document.getElementById('cancelLoginBtn')?.addEventListener('click', function() {
  // Hide the login form
  document.getElementById('loginForm').classList.remove('active');
  
  // Clear the form fields
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  
  // Remove any error messages
  document.getElementById('loginEmailError').classList.remove('show');
  document.getElementById('loginPasswordError').classList.remove('show');
  
  // Scroll back to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Cancel Register Button
document.getElementById('cancelRegisterBtn')?.addEventListener('click', function() {
  // Hide the registration form
  document.getElementById('registerForm').classList.remove('active');
  
  // Clear all form fields
  document.getElementById('fullName').value = '';
  document.getElementById('email').value = '';
  document.getElementById('userType').value = '';
  document.getElementById('yearLevel').value = '';
  document.getElementById('password').value = '';
  document.getElementById('confirmPassword').value = '';
  
  // Hide any shown fields
  document.getElementById('teacherFields').classList.add('hidden');
  document.getElementById('studentFields').classList.add('hidden');
  document.getElementById('studentModulesField').classList.add('hidden');
  
  // Clear teacher module selection
  teacherSelectedModules = [];
  updateTeacherSelectionCount();
  
  // Clear any error messages
  document.querySelectorAll('.error-message').forEach(error => {
    error.classList.remove('show');
  });
  
  document.querySelectorAll('.error-input').forEach(input => {
    input.classList.remove('error-input');
  });
  
  // Scroll back to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
// Close forms with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Close login form if open
    if (document.getElementById('loginForm').classList.contains('active')) {
      document.getElementById('cancelLoginBtn')?.click();
    }
    
    // Close register form if open
    if (document.getElementById('registerForm').classList.contains('active')) {
      document.getElementById('cancelRegisterBtn')?.click();
    }
    
    // Close material modal if open
    const materialModal = document.getElementById('addMaterialModal');
    if (materialModal && materialModal.classList.contains('active')) {
      document.getElementById('cancelMaterialBtn')?.click();
    }
  }
});

// ========== ACCESS CODE LOGIN SYSTEM ==========

// Add this to your nav links (optional, for non-logged-in users)
function addAccessCodeLoginToNav() {
    const navLinks = document.getElementById('navLinks');
    const loginLink = document.getElementById('loginLink');
    
    // Create access code login link
    const accessCodeLink = document.createElement('a');
    accessCodeLink.href = '#';
    accessCodeLink.id = 'accessCodeNavLink';
    accessCodeLink.innerHTML = '<i class="fas fa-key"></i> Access Code';
    accessCodeLink.style.color = '#8b5cf6';
    accessCodeLink.style.fontWeight = '600';
    
    // Insert before login link
    if (loginLink && loginLink.parentNode) {
        loginLink.parentNode.insertBefore(accessCodeLink, loginLink);
    }
    
    // Add click event
    accessCodeLink.addEventListener('click', function(e) {
        e.preventDefault();
        showAccessCodeLoginModal();
    });
}



// Update the course card button to use the new modal
// In the loadCourses function, update the button:
function updateCourseCardForAccessCode(courseCode) {
    // Instead of showing the input inline, just trigger the modal
    return `
        <button class="btn btn-secondary" onclick="event.stopPropagation(); showAccessCodeLoginModal('${courseCode}');" 
                style="font-size: 0.9rem; padding: 8px 15px;">
            <i class="fas fa-key"></i> Use Access Code
        </button>
    `;
}

// For non-logged-in users on course cards:
function updateCourseCardForNonLoggedIn(courseCode) {
    return `
        <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
            <button class="btn" onclick="event.stopPropagation(); showForm(document.getElementById('loginForm'));">
                <i class="fas fa-sign-in-alt"></i> Login to Enroll
            </button>
            <button class="btn btn-secondary" onclick="event.stopPropagation(); showAccessCodeLoginModal('${courseCode}');" 
                    style="font-size: 0.9rem; padding: 8px 15px;">
                <i class="fas fa-key"></i> Use Access Code
            </button>
        </div>
    `;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add access code link to nav
    addAccessCodeLoginToNav();
    
    // Clean up any old access code section from login form
    const loginForm = document.getElementById('loginForm');
    const accessCodeSection = loginForm.querySelector('.student-access-section');
    if (accessCodeSection) {
        accessCodeSection.remove();
    }
});




// Function to show access code login modal
function showAccessCodeLoginModal(courseCode = null) {
    // Create modal HTML
    const modalHTML = `
        <div id="accessCodeModal" class="form-container active">
            <div class="form-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-key"></i> Student Access Code</h2>
                    <button class="btn btn-secondary" onclick="closeAccessCodeModal()" style="padding: 5px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                ${courseCode ? `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #4f46e5; margin-bottom: 5px;">Accessing: ${courseCode}</h4>
                        <p style="color: #6b7280;">Enter your 6-digit access code to unlock this course</p>
                    </div>
                ` : `
                    <p style="color: #6b7280; margin-bottom: 20px; text-align: center;">
                        If you have a student access code, enter it below to access your enrolled courses.
                    </p>
                `}
                
                <div class="form-group">
                    <label for="accessCodeInput">Access Code (6 digits)</label>
                    <input type="text" id="accessCodeInput" placeholder="Enter your 6-digit access code" 
                           style="text-transform: uppercase; letter-spacing: 2px; font-size: 1.2rem; text-align: center;">
                    <div class="error-message" id="accessCodeError"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" id="submitAccessCodeBtn" style="width: 100%; background: #8b5cf6;">
                        <i class="fas fa-unlock"></i> Access My Courses
                    </button>
                    ${!currentUser ? `
                        <p style="text-align: center; margin-top: 15px; color: #6b7280;">
                            Don't have an access code? 
                            <a href="#" onclick="closeAccessCodeModal(); showForm(document.getElementById('loginForm'));" style="color: #4f46e5;">
                                Login here
                            </a>
                        </p>
                    ` : ''}
                </div>
                
                <input type="hidden" id="accessCodeForCourse" value="${courseCode || ''}">
            </div>
        </div>
    `;
    
    // Add modal to page
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    overlay.id = 'accessCodeModalOverlay';
    overlay.onclick = closeAccessCodeModal;
    document.body.appendChild(overlay);
    
    // Prevent scrolling
    document.body.style.overflow = 'hidden';
    
    // Focus on input
    setTimeout(() => {
        const input = document.getElementById('accessCodeInput');
        if (input) input.focus();
    }, 100);
    
    // Add event listener for submit button
    document.getElementById('submitAccessCodeBtn').addEventListener('click', submitAccessCodeFromModal);
    
    // Allow Enter key to submit
    document.getElementById('accessCodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitAccessCodeFromModal();
        }
    });
}

// Function to close access code modal
function closeAccessCodeModal() {
    const modal = document.getElementById('accessCodeModal');
    const overlay = document.getElementById('accessCodeModalOverlay');
    
    if (modal) modal.remove();
    if (overlay) overlay.remove();
    
    document.body.style.overflow = '';
}

// Function to submit access code from modal
function submitAccessCodeFromModal() {
    const accessCode = document.getElementById('accessCodeInput').value.trim().toUpperCase();
    const courseCode = document.getElementById('accessCodeForCourse').value;
    const errorDiv = document.getElementById('accessCodeError');
    
    // Validation
    if (!accessCode || accessCode.length !== 6) {
        errorDiv.textContent = 'Please enter a valid 6-digit access code';
        errorDiv.classList.add('show');
        return;
    }
    
    // Show loading
    const submitBtn = document.getElementById('submitAccessCodeBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    // Call the new checkAccessCode function
    checkAccessCode(accessCode, courseCode, submitBtn, originalText, errorDiv);
}

// ACCESS CODE - FIXED VERSION ==========
document.getElementById('createStudentCodeBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    const studentName = prompt("Enter student's full name:");
    if (!studentName) return;
    
    const studentEmail = prompt("Enter student's email:").toLowerCase().trim();
    if (!studentEmail) return;
    
    // Generate access code
    const accessCode = generateAccessCode();
    
    // Ask for modules
    const coursesStr = prompt("Enter module codes (comma separated):\nExample: MATH130, MATH140, STAT130");
    let selectedModules = [];
    
    if (coursesStr) {
        coursesStr.split(',').forEach(code => {
            const cleanCode = code.trim().toUpperCase();
            if (cleanCode) selectedModules.push(cleanCode);
        });
    }
    
    const totalPrice = selectedModules.length * 250;
    
    // Show loading
    const originalHtml = this.innerHTML;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    this.disabled = true;
    
    try {
        console.log("Creating student with access code:", accessCode);
        
        // STEP 1: Save to Firestore access_codes collection
        const accessCodeData = {
            accessCode: accessCode,
            studentEmail: studentEmail,
            studentName: studentName,
            enrolledCourses: selectedModules,
            totalPrice: totalPrice,
            status: 'active',
            createdAt: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() // 1 year
        };
        
        console.log("Saving to access_codes collection:", accessCodeData);
        
        if (window.db && window.addDoc) {
            const accessCodesRef = collection(db, "access_codes");
            const accessDocRef = await addDoc(accessCodesRef, accessCodeData);
            console.log("✅ Access code saved to Firestore with ID:", accessDocRef.id);
        }
        
        // STEP 2: Save to Firestore users collection
        const userData = {
            fullName: studentName,
            email: studentEmail,
            userType: 'student',
            yearLevel: 'mixed',
            enrolledCourses: selectedModules,
            accessCode: accessCode,
            status: 'active',
            pendingPayment: totalPrice,
            balance: 0,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            authMethod: 'access_code'
        };
        
        console.log("Saving to users collection:", userData);
        
        if (window.db && window.addDoc) {
            const usersRef = collection(db, "users");
            const userDocRef = await addDoc(usersRef, userData);
            console.log("✅ Student saved to users collection with ID:", userDocRef.id);
            
            // Store the Firestore ID
            userData.id = userDocRef.id;
            userData.firestoreId = userDocRef.id;
        } else {
            // Local fallback ID
            userData.id = 'local_' + Date.now();
        }
        
        // STEP 3: Save to localStorage for backup
        const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
        students.push(userData);
        localStorage.setItem('ThriveAcademy_students', JSON.stringify(students));
        
        const users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        users.push(userData);
        localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
        
        // STEP 4: Show success message
        let successMsg = `✅ STUDENT CREATED SUCCESSFULLY!\n\n`;
        successMsg += `📋 STUDENT INFORMATION:\n`;
        successMsg += `─────────────────────────────\n`;
        successMsg += `👤 Name: ${studentName}\n`;
        successMsg += `📧 Email: ${studentEmail}\n`;
        successMsg += `🔑 Access Code: ${accessCode}\n\n`;
        
        successMsg += `📚 ENROLLED MODULES:\n`;
        successMsg += `─────────────────────────────\n`;
        if (selectedModules.length > 0) {
            selectedModules.forEach((module, index) => {
                successMsg += `${index + 1}. ${module} (R250)\n`;
            });
            successMsg += `\n💰 TOTAL PENDING: R${totalPrice}\n`;
        } else {
            successMsg += `No modules yet (add later)\n`;
        }
        
        successMsg += `\n🔐 ACCESS INSTRUCTIONS:\n`;
        successMsg += `─────────────────────────────\n`;
        successMsg += `• Student can use this code on ANY device\n`;
        successMsg += `• Click "Access Code" button or course cards\n`;
        successMsg += `• Works across all browsers and devices\n`;
        
        if (window.db) {
            successMsg += `\n✅ SAVED TO FIREBASE - CROSS-DEVICE READY!`;
        }
        
        alert(successMsg);
        
        // STEP 5: Refresh admin panel
        if (currentUser && currentUser.userType === 'admin') {
            setTimeout(() => {
                loadStudentsForAdmin();
            }, 500);
        }
        
    } catch (error) {
        console.error("❌ Error creating student:", error);
        
        let errorMsg = `❌ ERROR CREATING STUDENT:\n\n`;
        
        if (error.code === 'permission-denied') {
            errorMsg += `Firebase permission denied!\n\n`;
            errorMsg += `Please update Firestore rules to:\n`;
            errorMsg += `1. Go to Firebase Console\n`;
            errorMsg += `2. Open Firestore Database\n`;
            errorMsg += `3. Click "Rules" tab\n`;
            errorMsg += `4. Replace with:\n\n`;
            errorMsg += `rules_version = '2';\n`;
            errorMsg += `service cloud.firestore {\n`;
            errorMsg += `  match /databases/{database}/documents {\n`;
            errorMsg += `    match /{document=**} {\n`;
            errorMsg += `      allow read, write: if true;\n`;
            errorMsg += `    }\n`;
            errorMsg += `  }\n`;
            errorMsg += `}`;
        } else {
            errorMsg += `${error.message}\n\n`;
            errorMsg += `Student saved locally only.`;
        }
        
        alert(errorMsg);
        
        // Save locally as fallback
        const localStudent = {
            id: 'local_' + Date.now(),
            fullName: studentName,
            email: studentEmail,
            userType: 'student',
            yearLevel: 'mixed',
            enrolledCourses: selectedModules,
            accessCode: accessCode,
            status: 'active',
            pendingPayment: totalPrice,
            balance: 0,
            createdAt: new Date().toISOString(),
            _localOnly: true
        };
        
        const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
        students.push(localStudent);
        localStorage.setItem('ThriveAcademy_students', JSON.stringify(students));
        
        alert(`✅ Saved locally only. Access code: ${accessCode}\n\nWill NOT work on other devices.`);
        
    } finally {
        this.innerHTML = originalHtml;
        this.disabled = false;
    }
});
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add access code link to nav
    addAccessCodeLoginToNav();
});
// ========== TEST FIREBASE CONNECTION ==========
async function testFirebaseConnection() {
    console.log("Testing Firebase connection...");
    
    try {
        // Test 1: Check if Firebase is loaded
        if (!window.db) {
            throw new Error("Firestore not loaded");
        }
        
        // Test 2: Try to write to test collection
        const testRef = collection(db, "test_connection");
        const testDoc = await addDoc(testRef, {
            test: "Firebase connection test",
            timestamp: new Date().toISOString(),
            app: "Thrive Academy"
        });
        
        console.log("✅ Firebase write test passed:", testDoc.id);
        
        // Test 3: Try to read
        const querySnapshot = await getDocs(testRef);
        console.log("✅ Firebase read test passed:", querySnapshot.size, "documents");
        
        // Test 4: Clean up
        // Note: Can't delete without doc reference, but that's okay
        
        alert("✅ FIREBASE CONNECTION SUCCESSFUL!\n\nPermissions are working correctly.");
        
        return true;
        
    } catch (error) {
        console.error("❌ Firebase test failed:", error);
        
        let errorMsg = "FIREBASE ERROR:\n\n";
        errorMsg += error.message + "\n\n";
        
        if (error.code === 'permission-denied') {
            errorMsg += "PERMISSION DENIED\n\n";
            errorMsg += "Please update Firestore rules to:\n\n";
            errorMsg += "allow read, write: if true;\n\n";
            errorMsg += "Then try again.";
        }
        
        alert(errorMsg);
        return false;
    }
}

// Add test button to admin panel
setTimeout(() => {
    const testBtn = document.getElementById('testFirebaseBtn');
    if (testBtn) {
        testBtn.addEventListener('click', testFirebaseConnection);
    }
}, 1000);
// ========== FIXED: CREATE STUDENT ACCESS CODE WITH MODULE SELECTION ==========
document.getElementById('createStudentCodeBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    // Show student information form
    showStudentAccessCodeForm();
});

// Function to show student information form
function showStudentAccessCodeForm() {
    const formHTML = `
        <div id="studentAccessCodeForm" class="form-container active">
            <div class="form-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><i class="fas fa-user-plus"></i> Create Student Access Code</h2>
                    <button class="btn btn-secondary" onclick="closeStudentAccessCodeForm()" style="padding: 5px 15px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="studentAccessName">Student Full Name</label>
                    <input type="text" id="studentAccessName" placeholder="Enter student's full name">
                    <div class="error-message" id="studentNameError"></div>
                </div>
                
                <div class="form-group">
                    <label for="studentAccessEmail">Student Email</label>
                    <input type="email" id="studentAccessEmail" placeholder="student@example.com">
                    <div class="error-message" id="studentEmailError"></div>
                </div>
                
                <div class="form-group">
                    <label>Select Modules to Enroll</label>
                    <div class="modules-container" id="accessCodeModulesContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; background: #f9fafb;">
                        <!-- Modules will be loaded here -->
                    </div>
                    <div style="margin-top: 10px; color: #6b7280; font-size: 0.9rem;">
                        <span id="selectedModulesCount">0</span> modules selected (R250 each)
                    </div>
                    <div class="error-message" id="modulesError"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" id="generateAccessCodeBtn" style="width: 100%; background: #8b5cf6;">
                        <i class="fas fa-key"></i> Generate Access Code
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add form to page
    const formContainer = document.createElement('div');
    formContainer.innerHTML = formHTML;
    document.body.appendChild(formContainer);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay active';
    overlay.id = 'studentAccessFormOverlay';
    overlay.onclick = closeStudentAccessCodeForm;
    document.body.appendChild(overlay);
    
    // Prevent scrolling
    document.body.style.overflow = 'hidden';
    
    // Load modules for selection
    loadModulesForAccessCode();
    
    // Focus on first input
    setTimeout(() => {
        document.getElementById('studentAccessName').focus();
    }, 100);
}

// Function to load modules for selection
function loadModulesForAccessCode() {
    const container = document.getElementById('accessCodeModulesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Combine all modules from both years
    let allCourses = [...coursesData[1], ...coursesData[2]];
    
    if (allCourses.length === 0) {
        container.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">No modules available</p>';
        return;
    }
    
    allCourses.forEach(course => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'module-checkbox';
        checkboxDiv.style.cursor = 'pointer';
        checkboxDiv.innerHTML = `
            <input type="checkbox" value="${course.code}" id="module_${course.code}" style="margin-right: 10px;">
            <div class="module-info">
                <div class="module-code">
                    ${course.code} 
                    <span style="font-size: 0.8rem; background: #e5e7eb; padding: 2px 6px; border-radius: 3px; margin-left: 5px;">Year ${course.year}</span>
                </div>
                <div class="module-name">${course.name}</div>
            </div>
            <div class="module-price">R${course.price}</div>
        `;
        
        // Make the whole div clickable
        checkboxDiv.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
        
        // Update count on change
        checkboxDiv.querySelector('input').addEventListener('change', updateSelectedModulesCount);
        
        container.appendChild(checkboxDiv);
    });
    
    // Add event listener for generate button
    document.getElementById('generateAccessCodeBtn').addEventListener('click', generateStudentAccessCode);
}

// Update selected modules count
function updateSelectedModulesCount() {
    const checkboxes = document.querySelectorAll('#accessCodeModulesContainer input[type="checkbox"]:checked');
    const count = checkboxes.length;
    document.getElementById('selectedModulesCount').textContent = count;
}

// Generate the access code
async function generateStudentAccessCode() {
    // Get form values
    const studentName = document.getElementById('studentAccessName').value.trim();
    const studentEmail = document.getElementById('studentAccessEmail').value.trim().toLowerCase();
    
    // Get selected modules
    const selectedCheckboxes = document.querySelectorAll('#accessCodeModulesContainer input[type="checkbox"]:checked');
    const selectedModules = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    // Validation
    let isValid = true;
    
    // Clear errors
    document.getElementById('studentNameError').textContent = '';
    document.getElementById('studentNameError').classList.remove('show');
    document.getElementById('studentEmailError').textContent = '';
    document.getElementById('studentEmailError').classList.remove('show');
    document.getElementById('modulesError').textContent = '';
    document.getElementById('modulesError').classList.remove('show');
    
    if (!studentName || studentName.length < 2) {
        document.getElementById('studentNameError').textContent = 'Please enter student name';
        document.getElementById('studentNameError').classList.add('show');
        isValid = false;
    }
    
    if (!studentEmail || !validateEmail(studentEmail)) {
        document.getElementById('studentEmailError').textContent = 'Please enter valid email';
        document.getElementById('studentEmailError').classList.add('show');
        isValid = false;
    }
    
    if (selectedModules.length === 0) {
        document.getElementById('modulesError').textContent = 'Please select at least one module';
        document.getElementById('modulesError').classList.add('show');
        isValid = false;
    }
    
    if (!isValid) {
        return;
    }
    
    const totalPrice = selectedModules.length * 250;
    
    // Generate access code
    const accessCode = generateAccessCode();
    
    // Show loading
    const generateBtn = document.getElementById('generateAccessCodeBtn');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    generateBtn.disabled = true;
    
    try {
        console.log("Creating student with access code:", accessCode);
        
        // STEP 1: Save to Firestore access_codes collection
        const accessCodeData = {
            accessCode: accessCode,
            studentEmail: studentEmail,
            studentName: studentName,
            enrolledCourses: selectedModules,
            totalPrice: totalPrice,
            status: 'active',
            createdAt: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() // 1 year
        };
        
        console.log("Saving to access_codes collection:", accessCodeData);
        
        if (window.db && window.addDoc) {
            const accessCodesRef = collection(db, "access_codes");
            const accessDocRef = await addDoc(accessCodesRef, accessCodeData);
            console.log("✅ Access code saved to Firestore with ID:", accessDocRef.id);
        }
        
        // STEP 2: Save to Firestore users collection
        const userData = {
            fullName: studentName,
            email: studentEmail,
            userType: 'student',
            yearLevel: 'mixed',
            enrolledCourses: selectedModules,
            accessCode: accessCode,
            status: 'active',
            pendingPayment: totalPrice,
            balance: 0,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            authMethod: 'access_code'
        };
        
        console.log("Saving to users collection:", userData);
        
        if (window.db && window.addDoc) {
            const usersRef = collection(db, "users");
            const userDocRef = await addDoc(usersRef, userData);
            console.log("✅ Student saved to users collection with ID:", userDocRef.id);
            
            // Store the Firestore ID
            userData.id = userDocRef.id;
            userData.firestoreId = userDocRef.id;
        } else {
            // Local fallback ID
            userData.id = 'local_' + Date.now();
        }
        
        // STEP 3: Save to localStorage for backup
        const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
        students.push(userData);
        localStorage.setItem('ThriveAcademy_students', JSON.stringify(students));
        
        const users = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        users.push(userData);
        localStorage.setItem('ThriveAcademy_users', JSON.stringify(users));
        
        // STEP 4: Close form and show success
        closeStudentAccessCodeForm();
        
        // STEP 5: Show success message
        setTimeout(() => {
            showAccessCodeSuccess(studentName, studentEmail, accessCode, selectedModules, totalPrice);
        }, 300);
        
        // STEP 6: Refresh admin panel
        if (currentUser && currentUser.userType === 'admin') {
            setTimeout(() => {
                loadStudentsForAdmin();
            }, 500);
        }
        
    } catch (error) {
        console.error("❌ Error creating student:", error);
        
        // Reset button
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
        
        let errorMsg = `❌ ERROR CREATING STUDENT:\n\n`;
        
        if (error.code === 'permission-denied') {
            errorMsg += `Firebase permission denied!\n\n`;
            errorMsg += `Please check Firestore rules.`;
        } else {
            errorMsg += `${error.message}`;
        }
        
        alert(errorMsg);
    }
}

// Function to show success message
function showAccessCodeSuccess(studentName, studentEmail, accessCode, selectedModules, totalPrice) {
    let successMsg = `✅ STUDENT ACCESS CODE CREATED!\n\n`;
    successMsg += `📋 STUDENT INFORMATION:\n`;
    successMsg += `─────────────────────────────\n`;
    successMsg += `👤 Name: ${studentName}\n`;
    successMsg += `📧 Email: ${studentEmail}\n`;
    successMsg += `🔑 Access Code: ${accessCode}\n\n`;
    
    successMsg += `📚 ENROLLED MODULES:\n`;
    successMsg += `─────────────────────────────\n`;
    selectedModules.forEach((module, index) => {
        // Find course name
        let courseName = '';
        for (const year in coursesData) {
            const course = coursesData[year].find(c => c.code === module);
            if (course) {
                courseName = course.name;
                break;
            }
        }
        successMsg += `${index + 1}. ${module} - ${courseName} (R250)\n`;
    });
    successMsg += `\n💰 TOTAL: R${totalPrice}\n`;
    
    successMsg += `\n🔐 ACCESS INSTRUCTIONS:\n`;
    successMsg += `─────────────────────────────\n`;
    successMsg += `• Student can use this code on ANY device\n`;
    successMsg += `• Click "Access Code" button or course cards\n`;
    successMsg += `• Code will work immediately\n`;
    
    if (window.db) {
        successMsg += `\n✅ SAVED TO CLOUD DATABASE!`;
    }
    
    // Create a nice formatted alert with copy button
    const alertDiv = document.createElement('div');
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '50%';
    alertDiv.style.left = '50%';
    alertDiv.style.transform = 'translate(-50%, -50%)';
    alertDiv.style.background = 'white';
    alertDiv.style.padding = '25px';
    alertDiv.style.borderRadius = '12px';
    alertDiv.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
    alertDiv.style.zIndex = '999999';
    alertDiv.style.maxWidth = '500px';
    alertDiv.style.maxHeight = '80vh';
    alertDiv.style.overflow = 'auto';
    
    alertDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="background: #10b981; color: white; width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <i class="fas fa-check" style="font-size: 1.5rem;"></i>
            </div>
            <h3 style="color: #10b981; margin-bottom: 10px;">Access Code Created!</h3>
        </div>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0 0 10px 0; font-weight: 600;">Student Information</p>
            <p style="margin: 5px 0;"><strong>Name:</strong> ${studentName}</p>
            <p style="margin: 5px 0;"><strong>Email:</strong> ${studentEmail}</p>
            <p style="margin: 5px 0;">
                <strong>Access Code:</strong> 
                <span style="background: #e5e7eb; padding: 5px 10px; border-radius: 4px; font-family: monospace; letter-spacing: 2px; margin-left: 10px;">
                    ${accessCode}
                </span>
                <button onclick="copyToClipboard('${accessCode}')" style="margin-left: 10px; padding: 4px 8px; background: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </p>
        </div>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0 0 10px 0; font-weight: 600;">Enrolled Modules (${selectedModules.length})</p>
            <ul style="margin: 0; padding-left: 20px;">
                ${selectedModules.map(module => {
                    let courseName = '';
                    for (const year in coursesData) {
                        const course = coursesData[year].find(c => c.code === module);
                        if (course) {
                            courseName = course.name;
                            break;
                        }
                    }
                    return `<li style="margin-bottom: 5px;">${module} - ${courseName}</li>`;
                }).join('')}
            </ul>
            <p style="margin: 10px 0 0 0; font-weight: 600;">Total: R${totalPrice}</p>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 0 0 10px 0; font-weight: 600;"><i class="fas fa-info-circle"></i> Access Instructions</p>
            <ul style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                <li>Student uses code on ANY device</li>
                <li>Click "Access Code" button or course cards</li>
                <li>Code works immediately</li>
                <li>Cross-device access enabled</li>
            </ul>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeAccessCodeSuccess()" class="btn" style="flex: 1;">
                <i class="fas fa-times"></i> Close
            </button>
            <button onclick="copyAllInfo('${studentName}', '${studentEmail}', '${accessCode}', ${totalPrice})" class="btn" style="flex: 1; background: #4f46e5;">
                <i class="fas fa-copy"></i> Copy All
            </button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Add overlay
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.right = '0';
    overlay.style.bottom = '0';
    overlay.style.background = 'rgba(0,0,0,0.5)';
    overlay.style.zIndex = '999998';
    overlay.id = 'successAlertOverlay';
    overlay.onclick = closeAccessCodeSuccess;
    document.body.appendChild(overlay);
}

// Helper function to copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Access code copied to clipboard!');
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

// Function to copy all information
function copyAllInfo(name, email, code, total) {
    const text = `THRIVE ACADEMY - STUDENT ACCESS CODE\n\nStudent: ${name}\nEmail: ${email}\nAccess Code: ${code}\nAmount Due: R${total}\n\nGive this information to the student.`;
    navigator.clipboard.writeText(text).then(() => {
        alert('All information copied to clipboard!');
    });
}

// Close success alert
function closeAccessCodeSuccess() {
    const alertDiv = document.querySelector('div[style*="position: fixed"][style*="top: 50%"]');
    const overlay = document.getElementById('successAlertOverlay');
    
    if (alertDiv) alertDiv.remove();
    if (overlay) overlay.remove();
}

// Close the student access code form
function closeStudentAccessCodeForm() {
    const form = document.getElementById('studentAccessCodeForm');
    const overlay = document.getElementById('studentAccessFormOverlay');
    
    if (form) form.remove();
    if (overlay) overlay.remove();
    
    document.body.style.overflow = '';
}

// Keep the original generateAccessCode function
function generateAccessCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}
// Fix Cancel Buttons
document.getElementById('cancelLoginBtn')?.addEventListener('click', function() {
    console.log("Closing login form");
    document.getElementById('loginForm').classList.remove('active');
});

document.getElementById('cancelRegisterBtn')?.addEventListener('click', function() {
    console.log("Closing register form");
    document.getElementById('registerForm').classList.remove('active');
});


function closeMaterialModal() {
    console.log("Closing material modal");
    
    // Hide modal
    const modal = document.getElementById('addMaterialModal');
    if (modal) {
        modal.classList.remove('active');
        modal.classList.add('hidden');
        console.log("Modal hidden");
    }
    
    // Remove overlay
    const overlay = document.querySelector('.modal-overlay.active');
    if (overlay) {
        overlay.remove();
        console.log("Overlay removed");
    }
    
    // Reset form
    const form = document.getElementById('addMaterialForm');
    if (form) {
        form.reset();
        console.log("Form reset");
    }
    
    // Clear file input
    window.currentFileInput = null;
    
    // Restore scrolling
    document.body.style.overflow = '';
    
    // Refresh page
    setTimeout(() => {
        updateHomePage();
        console.log("Page refreshed");
    }, 500);
}
// ========== LOAD MATERIALS FROM FIRESTORE ==========
async function loadMaterialsFromFirestore() {
    console.log("Loading materials from Firestore...");
    
    try {
        if (!window.db || !window.collection || !window.getDocs) {
            console.log("Firestore not available, using localStorage");
            return;
        }
        
        const materialsRef = collection(db, "materials");
        const snapshot = await getDocs(materialsRef);
        
        // Clear current materials
        materials = [];
        
        snapshot.forEach((doc) => {
            const materialData = doc.data();
            materials.push({
                firestoreId: doc.id,
                ...materialData
            });
        });
        
        console.log(`✅ Loaded ${materials.length} materials from Firestore`);
        
        // Save to localStorage for offline access
        localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
        
    } catch (error) {
        console.error("Error loading materials from Firestore:", error);
        
        // Fallback to localStorage
        const savedMaterials = JSON.parse(localStorage.getItem('ThriveAcademy_materials')) || [];
        materials = savedMaterials;
    }
}

// ========== INITIALIZE MATERIALS ON PAGE LOAD ==========
document.addEventListener('DOMContentLoaded', function() {
    // Load materials when page loads
    setTimeout(() => {
        loadMaterialsFromFirestore();
    }, 1000);
});
// Helper function to save material to storage
function saveMaterialToStorage(material) {
    console.log("Saving material to storage:", material.title);
    
    // Add to materials array
    materials.push(material);
    
    // Save to localStorage
    localStorage.setItem('ThriveAcademy_materials', JSON.stringify(materials));
    
    // Show success message
    alert(`✅ Material "${material.title}" added successfully to ${material.courseCode}!`);
    
    // Close modal
    const modal = document.getElementById('addMaterialModal');
    if (modal) {
        modal.classList.remove('active');
        modal.classList.add('hidden');
    }
    
    // Remove overlay if exists
    const overlay = document.getElementById('addMaterialOverlay');
    if (overlay) {
        overlay.remove();
    }
    
    // Reset form
    document.getElementById('addMaterialForm').reset();
    
    // Clear file reference
    window.currentFileInput = null;
    
    // Restore body scrolling
    document.body.style.overflow = '';
    
    // Refresh the page to show new material
    if (currentUser && (currentUser.userType === 'teacher' || 
        (currentUser.userType === 'admin' && adminMode === 'teacher'))) {
        loadTeacherCourses();
    }
    
    updateHomePage();
    updateCoursesDisplay();
}
// ====== SIMPLE MATERIAL UPDATER ======
// Add this function anywhere in your JavaScript file

async function refreshCourseMaterials(courseCode) {
    console.log(`Refreshing materials for course: ${courseCode}`);
    
    // Find the course card for this course
    const courseCards = document.querySelectorAll('.course-card');
    let targetCard = null;
    
    // Find the card with this course code
    for (let card of courseCards) {
        if (card.innerHTML.includes(courseCode) || 
            (card.querySelector && card.querySelector(`[onclick*="${courseCode}"]`))) {
            targetCard = card;
            break;
        }
    }
    
    if (!targetCard) {
        console.log('Course card not found for:', courseCode);
        return;
    }
    
    try {
        // 1. Fetch materials from Supabase for this course
        const { data: materials, error } = await supabase
            .from('materials')
            .select('*')
            .eq('course_code', courseCode)
            .order('uploaded_at', { ascending: false });
        
        if (error) throw error;
        
        console.log(`Found ${materials.length} materials for ${courseCode}`);
        
        // 2. Create simple materials display
        let materialsHTML = '';
        
        if (materials.length > 0) {
            materialsHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>📚 Materials (${materials.length}):</strong>
                    ${materials.map(material => `
                        <div style="margin: 5px 0; padding: 5px; border-bottom: 1px solid #ddd;">
                            <span style="font-weight:500;">${material.title}</span>
                            ${material.file_url ? 
                                `<a href="${material.file_url}" 
                                   style="margin-left:10px; color:#007bff; text-decoration:none;" 
                                   target="_blank"
                                   download>
                                    📥 Download
                                </a>` : 
                                ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // 3. Find where to add materials in the card
        // Look for "Add Material" button to insert before it
        const addMaterialBtn = targetCard.querySelector('button[onclick*="addMaterial"], button:contains("Add Material")');
        
        if (addMaterialBtn) {
            // Remove old materials display if exists
            const oldMaterials = targetCard.querySelector('.materials-display');
            if (oldMaterials) oldMaterials.remove();
            
            // Create new materials display
            const materialsDiv = document.createElement('div');
            materialsDiv.className = 'materials-display';
            materialsDiv.innerHTML = materialsHTML;
            
            // Insert before the "Add Material" button
            addMaterialBtn.parentNode.insertBefore(materialsDiv, addMaterialBtn);
        }
        
    } catch (error) {
        console.error('Error refreshing materials:', error);
    }
}
// SIMPLE FUNCTION TO UPDATE COURSE CARD
function updateCourseCardWithMaterial(courseCode, material) {
    console.log(`Updating course card for: ${courseCode}`);
    
    // 1. Find all course cards
    const courseCards = document.querySelectorAll('.course-card');
    
    // 2. Find the right course card (simplest logic)
    for (let card of courseCards) {
        // Check if card contains this course code
        const cardHTML = card.innerHTML;
        const cardText = card.textContent || card.innerText;
        
        if (cardHTML.includes(courseCode) || cardText.includes(courseCode)) {
            console.log('Found course card to update');
            
            // 3. Add a simple material indicator
            let materialIndicator = card.querySelector('.material-indicator');
            
            if (!materialIndicator) {
                // Create indicator if doesn't exist
                materialIndicator = document.createElement('div');
                materialIndicator.className = 'material-indicator';
                materialIndicator.style.cssText = `
                    margin-top: 10px;
                    padding: 8px;
                    background: #f8f9fa;
                    border-radius: 5px;
                    font-size: 14px;
                `;
                card.appendChild(materialIndicator);
            }
            
            // 4. Update indicator with download link
            materialIndicator.innerHTML = `
                <strong>📚 Material Added:</strong><br>
                <a href="${material.file_url}" 
                   target="_blank" 
                   style="color: #007bff; text-decoration: none;"
                   download="${material.file_name}">
                    📥 ${material.title}
                </a>
            `;
            
            break;
        }
    }
}

</script>

<!--Firebase module script-->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    GoogleAuthProvider, 
    signInWithPopup ,
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";  
  import { 
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    deleteDoc,
    getDoc,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  // Add these to your existing Firebase imports
import { getStorage } from "firebase/storage";
import { ref, uploadBytes, getDownloadURL } from "firebase/storage";
  const firebaseConfig = {
    apiKey: "AIzaSyBBta5FZwjKEvh6aBfpo_ALdWTPqGwqBk0",
    authDomain: "thrive-academy-cc537.firebaseapp.com",
    projectId: "thrive-academy-cc537",
    storageBucket: "thrive-academy-cc537.firebasestorage.app",
    messagingSenderId: "830537338362",
    appId: "1:830537338362:web:027fc690e63cfc9ef0e843",
    measurementId: "G-XLP0TJLVNK"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app);

  //🔑 expose globally
  window.firebaseApp = app;
  window.auth = getAuth(app);
  window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
  window.db = getFirestore(app);
  window.collection = collection;
  window.addDoc = addDoc;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
  window.deleteDoc = deleteDoc;
  window.getDoc = getDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;
  // After your existing Firebase initialization
const storage = getStorage(app);

// Make it globally available
 window.storage = storage;
 window.ref = ref;
 window.uploadBytes = uploadBytes;
 window.getDownloadURL =        getDownloadURL;
  console.log("🔥 Thrive Academy Firebase ready");

  //========== FIREBASE AUTH STATE LISTENER==========
  auth.onAuthStateChanged(async (firebaseUser) => {
    if (firebaseUser) {
      console.log("User signed in:", firebaseUser.email);
      
    } else {
      console.log("User signed out");
      //Clear local user data
      if (window.currentUser) {
        window.currentUser = null;
        localStorage.removeItem('ThriveAcademy_currentUser');
        
        //Update UI
        const dashboardLink = document.getElementById('dashboardLink');
        const adminLink = document.getElementById('adminLink');
        const logoutLink = document.getElementById('logoutLink');
        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');
        
        if (dashboardLink) dashboardLink.classList.add('hidden');
        if (adminLink) adminLink.classList.add('hidden');
        if (logoutLink) logoutLink.classList.add('hidden');
        if (loginLink) loginLink.classList.remove('hidden');
        if (registerLink) registerLink.classList.remove('hidden');
      }
    }
  });

  //==========FIREBASE TEST FUNCTION ==========
  async function testFirebaseConnection() {
    console.log("Testing Firebase connection...");
    
    try {
      //Check if Firebase is loaded
      if (!window.db) {
        throw new Error("Firestore not loaded");
      }
      
      if (!window.auth) {
        throw new Error("Authentication not loaded");
      }
      
      console.log("✅ Firebase modules loaded");
      
      //Create a test document
      const testRef = collection(db, "test_connection");
      const docRef = await addDoc(testRef, {
        message: "Firebase connection test",
        timestamp: new Date().toISOString(),
        app: "Thrive Academy"
      });
      
      console.log("✅ Test document created with ID:", docRef.id);
      
      
      await deleteDoc(docRef);
      console.log("✅ Test document cleaned up");
      
      return {
        success: true,
        message: "Firebase connection successful!",
        testId: docRef.id
      };
      
    } catch (error) {
      console.error("❌ Firebase test failed:", error);
      return {
        success: false,
        message: "Firebase error: " + error.message
      };
    }
  }

  
  //Function to load students from Firebase
  window.loadStudentsFromFirebase = async function() {
    try {
      console.log("Loading students from Firebase...");
      
      //Reference to users collection
      const usersRef = collection(db, "users");
      
      //Query for students only
      const q = query(usersRef, where("userType", "==", "student"));
      const querySnapshot = await getDocs(q);
      
      const firebaseStudents = [];
      
      querySnapshot.forEach((doc) => {
        const studentData = doc.data();
        firebaseStudents.push({
          id: doc.id,
          ...studentData
        });
      });
      
      console.log(`Found ${firebaseStudents.length} students in Firebase`);
      return firebaseStudents;
      
    } catch (error) {
      console.error("Error loading students from Firebase:", error);
      return [];
    }
  };

  //Function to display students from Firebase
  window.displayStudentsFromFirebase = async function() {
    try {
      const students = await window.loadStudentsFromFirebase();
      const studentsContainer = document.getElementById('studentsContainer');
      
      if (studentsContainer) {
        studentsContainer.innerHTML = '';
        
        if (students.length === 0) {
          studentsContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">No students found in Firebase</p>';
          return;
        }
        
        students.forEach(student => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          studentItem.innerHTML = `
            <div>
              <strong>${student.fullName || 'Unknown'}</strong>
              <p style="color: #6b7280; font-size: 0.9rem;">${student.email || 'No email'} - ${window.getYearName ? window.getYearName(student.yearLevel || '') : student.yearLevel || 'Not specified'}</p>
              <p style="font-size: 0.9rem;">Enrolled in: ${student.enrolledCourses ? student.enrolledCourses.join(', ') : 'None'}</p>
              <p style="font-size: 0.9rem; color: ${(student.pendingPayment || 0) > 0 ? '#ef4444' : '#10b981'}">
                Balance: R${(student.balance || 0).toFixed(2)} | Pending: R${(student.pendingPayment || 0).toFixed(2)}
              </p>
            </div>
            <div>
              <button class="btn" onclick="adminEnrollStudent('${student.id}')" style="margin-right: 10px;">Enroll</button>
              <button class="btn btn-warning" onclick="verifyStudentPayment('${student.id}')">Verify Payment</button>
            </div>
          `;
          studentsContainer.appendChild(studentItem);
        });
      }
      
    } catch (error) {
      console.error("Error displaying students:", error);
      const studentsContainer = document.getElementById('studentsContainer');
      if (studentsContainer) {
        studentsContainer.innerHTML = `<p style="color: #ef4444; padding: 20px;">Error loading students: ${error.message}</p>`;
      }
    }
  };

  //Add event listener for test button
  document.getElementById('testFirebaseBtn')?.addEventListener('click', async () => {
    const result = await testFirebaseConnection();
    
    if (result.success) {
      alert("✅ " + result.message);
    } else {
      alert("❌ " + result.message);
    }
  });

  //Initialize on page load
  document.addEventListener('DOMContentLoaded', async function() {
    console.log("Firebase student functions loaded");
    
    //Check if we're in admin panel
    if (window.currentUser && window.currentUser.userType === 'admin') {
      console.log("Admin detected, pre-loading Firebase students");
    }
  });
  //Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeCourseMaterials();
  }
});
//Helper function to check material access
function checkMaterialAccess(courseCode) {
    console.log("🔒 Checking access for:", courseCode);
    
    if (!currentUser) {
        console.log("❌ No user logged in");
        return false;
    }
    
    // Admin can access everything
    if (currentUser.userType === 'admin') {
        console.log("✅ Admin access granted");
        return true;
    }
    
    // Teachers can access their own modules
    if (currentUser.userType === 'teacher' || (currentUser.userType === 'admin' && adminMode === 'teacher')) {
        const teachesCourse = currentUser.specialization && currentUser.specialization.includes(courseCode);
        console.log("Teacher access:", teachesCourse ? "YES" : "NO");
        return teachesCourse;
    }
    
    // STUDENT ACCESS CHECK - This is the important part!
    if (currentUser.userType === 'student' || (currentUser.userType === 'admin' && adminMode === 'student')) {
        console.log("Checking student access...");
        
        // Get enrolled courses from currentUser first
        let enrolledCourses = currentUser.enrolledCourses || [];
        console.log("Current user enrolled courses:", enrolledCourses);
        
        // If empty, try to find student data from localStorage
        if (enrolledCourses.length === 0) {
            console.log("No courses in currentUser, checking localStorage...");
            
            // Method 1: Check by access code
            if (currentUser.accessCode) {
                console.log("Looking by access code:", currentUser.accessCode);
                const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
                const studentData = students.find(s => s.accessCode === currentUser.accessCode);
                if (studentData && studentData.enrolledCourses) {
                    enrolledCourses = studentData.enrolledCourses;
                    console.log("Found by access code:", enrolledCourses);
                }
            }
            
            // Method 2: Check by email
            if (enrolledCourses.length === 0 && currentUser.email) {
                console.log("Looking by email:", currentUser.email);
                const students = JSON.parse(localStorage.getItem('ThriveAcademy_students')) || [];
                const studentData = students.find(s => s.email === currentUser.email);
                if (studentData && studentData.enrolledCourses) {
                    enrolledCourses = studentData.enrolledCourses;
                    console.log("Found by email:", enrolledCourses);
                }
            }
            
            // Update currentUser with found courses
            if (enrolledCourses.length > 0) {
                currentUser.enrolledCourses = enrolledCourses;
                localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
                console.log("Updated currentUser with courses");
            }
        }
        
        const hasAccess = enrolledCourses.includes(courseCode);
        console.log("Student has access to", courseCode + "?", hasAccess);
        return hasAccess;
    }
    
    console.log("❌ No access conditions met");
    return false;
}
</script>


<!--Teacher Folders Modal-->
<div id="teacherFoldersModal" class="form-container hidden">
  <div class="folders-modal-content">
    <h2>Upload Teaching Material</h2>
    <p style="color: #6b7280; margin-bottom: 20px;">Select folder type to add material for <strong id="currentCourseFolder"></strong></p>
    
    <div class="folders-grid" id="foldersContainer">
      <!--Folders will be dynamically loaded here-->
    </div>
    
    <div class="folder-actions">
      <button class="btn btn-secondary" id="closeFoldersModal">Cancel</button>
    </div>
  </div>
</div>

<!--Upload Material-->
<div id="uploadMaterialModal" class="form-container hidden">
  <div class="upload-modal-content">
    <h2>Upload Material to <span id="uploadFolderName"></span></h2>
    <p style="color: #6b7280; margin-bottom: 20px;">Course: <strong id="uploadCourseName"></strong></p>
    
    <div class="form-group">
      <label for="materialTitleInput">Material Title</label>
      <input type="text" id="materialTitleInput" placeholder="e.g., Chapter 1 Lecture, Week 2 Notes">
      <div class="error-message" id="materialTitleUploadError">Please enter a title</div>
    </div>
    
    <div class="form-group">
      <label for="materialDescriptionInput">Description (Optional)</label>
      <textarea id="materialDescriptionInput" placeholder="Brief description of the material" rows="3"></textarea>
    </div>
    
    <div class="file-upload-area" id="fileUploadArea">
      <i class="fas fa-cloud-upload-alt"></i>
      <h4>Drag & Drop Files Here</h4>
      <p>or click to browse files</p>
      <input type="file" id="fileInput" style="display: none;">
    </div>
    
    <div class="file-preview" id="filePreview">
      <div class="file-info">
        <i class="fas fa-file file-icon"></i>
        <div class="file-details">
          <div class="file-name" id="fileName">No file selected</div>
          <div class="file-size" id="fileSize">-</div>
        </div>
        <button class="remove-file" id="removeFileBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 30px;">
      <button type="button" class="btn btn-success" id="uploadMaterialBtn" style="flex: 1;">
        <i class="fas fa-upload"></i> Upload Material
      </button>
      <button type="button" class="btn btn-secondary" id="cancelUploadBtn" style="flex: 1;">
        Cancel
      </button>
    </div>
  </div>
</div>

<!--Overlay-->
<div class="modal-overlay" id="modalOverlay"></div>

<div class="modal-overlay" id="modalOverlay"></div>
<script>
//EMERGENCY LOGIN OVERRIDE
document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  
  // Add this function to help debug
function debugStudentEnrollment() {
  console.log("=== DEBUG STUDENT ENROLLMENT ===");
  console.log("Current User:", currentUser);
  console.log("User Type:", currentUser?.userType);
  console.log("Enrolled Courses:", currentUser?.enrolledCourses);
  console.log("Total Materials:", materials.length);
  
  if (currentUser?.enrolledCourses) {
    currentUser.enrolledCourses.forEach(courseCode => {
      const courseMaterials = materials.filter(m => m.courseCode === courseCode);
      console.log(`Course ${courseCode}: ${courseMaterials.length} materials`);
    });
  }
  
  alert("Check console for enrollment debug info");
}


  //Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
  submitBtn.disabled = true;
  
  try {
    //Check local storage ONLY
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const user = localUsers.find(u => u.email === email && u.password === password);
    
    if (!user) {
      //Try case-insensitive email match
      const user2 = localUsers.find(u => u.email.toLowerCase() === email && u.password === password);
      
      if (!user2) {
        throw new Error("Wrong email or password");
      }
    }
    
    //LOGIN SUCCESS
    currentUser = user || user2;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
    
    //Update UI
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    
    //Close form
    document.getElementById('loginForm').classList.remove('active');
    this.reset();
    
    //Show dashboard
    showDashboard();
    
    //alert("✅ Login successful!");
    
  } catch (error) {
    alert("❌ " + error.message);
  } finally {
    submitBtn.innerHTML = "Login";
    submitBtn.disabled = false;
  }
});
</script>
<script>
// ========== EMERGENCY FIX FOR USER LOGIN ==========


document.addEventListener('DOMContentLoaded', function() {
  console.log("Loading emergency login fix...");
  
  // Override the login form with a more robust solution
  document.getElementById('loginFormElement')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const password = document.getElementById('loginPassword').value;
    
    if (!email) {
      alert("Please enter your email");
      return;
    }
    
    if (!password) {
      alert("Please enter your password");
      return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    submitBtn.disabled = true;
    
    try {
      console.log(`Login attempt for: ${email}`);
      
      let user = null;
      let foundIn = '';
      
      // ==========  Check Firestore with password (CRITICAL FIX) ==========
      if (window.db && window.query && window.collection && window.getDocs) {
        try {
          console.log("Checking Firestore...");
          const q = query(collection(db, "users"), where("email", "==", email));
          const snapshot = await getDocs(q);
          
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            const firestoreUser = doc.data();
            
            // CRITICAL: Check if password exists in Firestore
            if (firestoreUser.password && firestoreUser.password === password) {
              user = { id: doc.id, ...firestoreUser };
              foundIn = 'Firestore';
              console.log(`✅ Found in Firestore with matching password`);
            } else {
              console.log("❌ Password doesn't match in Firestore or no password field");
              
              // If user exists but no password, this is the bug! We need to add it
              if (firestoreUser && !firestoreUser.password) {
                console.log("⚠️ User exists in Firestore but has no password field");
                
                // Try to update Firestore with password
                try {
                  await updateDoc(doc.ref, {
                    password: password,
                    updatedAt: new Date().toISOString()
                  });
                  console.log("✅ Added password to Firestore user");
                  
                  user = { id: doc.id, ...firestoreUser, password: password };
                  foundIn = 'Firestore (fixed)';
                } catch (updateError) {
                  console.log("Could not update password in Firestore:", updateError);
                }
              }
            }
          }
        } catch (firestoreError) {
          console.log("Firestore check error:", firestoreError);
        }
      }
      
      // ==========  Check local storage ==========
      if (!user) {
        console.log("Checking local storage...");
        const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        const localUser = localUsers.find(u => u.email === email && u.password === password);
        
        if (localUser) {
          user = localUser;
          foundIn = 'Local Storage';
          console.log("✅ Found in local storage");
          
          // If found locally but not in Firestore, try to save to Firestore
          if (window.db && !user.firestoreId) {
            try {
              const firestoreUser = { ...user };
              const usersRef = collection(db, "users");
              const docRef = await addDoc(usersRef, firestoreUser);
              user.firestoreId = docRef.id;
              console.log("✅ Saved local user to Firestore for future cross-device login");
            } catch (saveError) {
              console.log("Could not save to Firestore:", saveError);
            }
          }
        }
      }
      
      // ==========  Try Firebase Auth (for teachers/admin) ==========
      if (!user && window.auth && window.signInWithEmailAndPassword) {
        try {
          console.log("Trying Firebase Auth...");
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const firebaseUser = userCredential.user;
          
          // Try to find in Firestore
          if (window.db) {
            const q = query(collection(db, "users"), where("email", "==", email));
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
              const doc = snapshot.docs[0];
              user = { id: doc.id, ...doc.data() };
              foundIn = 'Firebase Auth + Firestore';
              console.log("✅ Found via Firebase Auth");
            }
          }
        } catch (authError) {
          console.log("Firebase Auth failed:", authError.code);
        }
      }
      
      // ========== LOGIN SUCCESS ==========
      if (user) {
        console.log(`✅ Login successful! Found in: ${foundIn}`);
        
        // Ensure user has password property
        if (!user.password) {
          user.password = password;
        }
        
        // Save user session
        currentUser = user;
        localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(user));
        
        // Also save to local users list (update if exists)
        const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        const existingIndex = localUsers.findIndex(u => u.email === user.email);
        
        if (existingIndex !== -1) {
          // Update existing user with current data
          localUsers[existingIndex] = user;
        } else {
          // Add new user to local storage
          localUsers.push(user);
        }
        
        localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
        
        // Update UI
        updateUIForUser();
        updateHomePage();
        updateCoursesDisplay();
        
        // Close form
        document.getElementById('loginForm').classList.remove('active');
        this.reset();
        
        // Show dashboard
        showDashboard();
        
        // Show welcome back message
        setTimeout(() => {
          alert(`🎉 Welcome back, ${user.fullName}!\n\nYour account is now synced across devices.`);
        }, 500);
        
      } else {
        // ========== USER NOT FOUND ==========
        // Check if email exists anywhere (for better error message)
        let emailExists = false;
        
        if (window.db) {
          const q = query(collection(db, "users"), where("email", "==", email));
          const snapshot = await getDocs(q);
          emailExists = !snapshot.empty;
        }
        
        if (!emailExists) {
          // Check local storage
          const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
          emailExists = localUsers.some(u => u.email === email);
        }
        
        if (emailExists) {
          throw new Error('❌ Wrong password. Please use the password you registered with.');
        } else {
          throw new Error('❌ No account found with this email. Please register first.');
        }
      }
      
    } catch (error) {
      console.error('Login error:', error);
      alert(error.message);
    } finally {
      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
  
  // ========== EMERGENCY PASSWORD RECOVERY ==========
  
  setTimeout(() => {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      // Add "Forgot Password" link
      const formSwitch = loginForm.querySelector('.form-switch');
      if (formSwitch) {
        const forgotPasswordLink = document.createElement('div');
        forgotPasswordLink.style.marginTop = '15px';
        forgotPasswordLink.style.textAlign = 'center';
        forgotPasswordLink.innerHTML = '<a href="#" id="forgotPasswordLink" style="color: #ef4444; font-size: 0.9rem;">Forgot Password?</a>';
        formSwitch.parentNode.insertBefore(forgotPasswordLink, formSwitch.nextSibling);
        
        // Add click handler
        document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
          e.preventDefault();
          const email = prompt("Enter your registered email address:");
          if (email) {
            recoverPassword(email);
          }
        });
      }
    }
  }, 1000);
});

// Password recovery function
async function recoverPassword(email) {
  email = email.trim().toLowerCase();
  
  try {
    console.log(`Password recovery for: ${email}`);
    
    let user = null;
    let source = '';
    
    // Check Firestore
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        user = { id: doc.id, ...doc.data() };
        source = 'Firestore';
      }
    }
    
    // Check local storage
    if (!user) {
      const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
      user = localUsers.find(u => u.email === email);
      if (user) source = 'Local Storage';
    }
    
    if (user) {
      if (user.password) {
        alert(`🔐 Password found for ${email}:\n\nPassword: ${user.password}\n\nPlease save this somewhere safe!`);
      } else {
        alert(`⚠️ Account found for ${email} but no password is stored.\n\nPlease contact support or try registering again.`);
      }
    } else {
      alert(`❌ No account found with email: ${email}\n\nPlease check your email or register for a new account.`);
    }
    
  } catch (error) {
    console.error("Password recovery error:", error);
    alert("Error recovering password. Please check console for details.");
  }
}

// ========== FIX REGISTRATION TO SAVE PASSWORD TO FIRESTORE ==========

const originalRegistrationHandler = document.getElementById('registerFormElement').onsubmit;
document.getElementById('registerFormElement').onsubmit = async function(e) {
  e.preventDefault();
  
  console.log("EMERGENCY FIX: Registration with password saving to Firestore");
  
  // Get form values
  const fullName = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const userType = document.getElementById('userType').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // Basic validation
  if (!fullName || !email || !userType || !password || !confirmPassword) {
    alert("Please fill in all required fields");
    return;
  }
  
  if (password !== confirmPassword) {
    alert("Passwords do not match");
    return;
  }
  
  if (password.length < 6) {
    alert("Password must be at least 6 characters");
    return;
  }
  
  // Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
  submitBtn.disabled = true;
  
  try {
    // Check if user already exists
    let existingUser = null;
    
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      existingUser = !snapshot.empty;
    }
    
    if (existingUser) {
      throw new Error("This email is already registered. Please login instead.");
    }
    
    // Create user object WITH PASSWORD
    const newUser = {
      fullName,
      email,
      userType,
      password: password, // CRITICAL: Save password
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'active'
    };
    
    // Add user-specific fields
    if (userType === 'student') {
      newUser.yearLevel = document.getElementById('yearLevel').value || 'mixed';
      newUser.enrolledCourses = [];
      newUser.selectedModules = [];
      newUser.pendingPayment = 0;
      newUser.balance = 0;
    } else if (userType === 'teacher') {
      newUser.specialization = teacherSelectedModules.length > 0 ? [...teacherSelectedModules] : ['Not assigned'];
      newUser.balance = 0;
    }
    
    // ========== CRITICAL: Save to Firestore WITH PASSWORD ==========
    let firestoreId = null;
    
    if (window.db && window.collection && window.addDoc) {
      try {
        console.log("Saving user to Firestore WITH PASSWORD...");
        const usersRef = collection(db, "users");
        const docRef = await addDoc(usersRef, newUser);
        firestoreId = docRef.id;
        newUser.id = docRef.id;
        newUser.firestoreId = docRef.id;
        console.log("✅ User saved to Firestore with ID:", firestoreId);
      } catch (firestoreError) {
        console.error("Firestore save error:", firestoreError);
        // Continue with local storage if Firestore fails
      }
    }
    
    // Save to local storage
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    localUsers.push(newUser);
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
    window.users = localUsers;
    
    // Auto-login
    currentUser = newUser;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
    
    // Show success
    alert(`✅ Account created successfully!\n\nIMPORTANT: Save these credentials:\n\n📧 Email: ${email}\n🔐 Password: ${password}\n\nYour account works on ALL devices!`);
    
    // Reset form and redirect
    this.reset();
    document.getElementById('registerForm').classList.remove('active');
    
    // Update UI
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    
    // Show dashboard
    showDashboard();
    
  } catch (error) {
    console.error("Registration error:", error);
    alert("❌ " + error.message);
  } finally {
    // Reset button
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
};
</script>
<script>
// ========== FIREBASE LOGIN FIX ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log("Loading Firebase login fix...");
  
  // Replace the login handler
  document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      alert("Please enter both email and password");
      return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    submitBtn.disabled = true;
    
    try {
      console.log(`Login attempt for: ${email}`);
      
      let user = null;
      let foundSource = '';
      
      // =====  CHECK FIRESTORE (USERS ARE HERE) =====
      if (window.db && window.query && window.collection && window.getDocs) {
        try {
          console.log("Checking Firestore users...");
          const q = query(collection(db, "users"), where("email", "==", email));
          const snapshot = await getDocs(q);
          
          if (!snapshot.empty) {
            console.log(`Found ${snapshot.size} user(s) in Firestore with email: ${email}`);
            
            snapshot.forEach((doc) => {
              const firestoreUser = doc.data();
              console.log("Firestore user data:", firestoreUser);
              
              
              if (firestoreUser.password) {
                console.log("User has password field in Firestore");
                if (firestoreUser.password === password) {
                  user = { id: doc.id, ...firestoreUser };
                  foundSource = 'Firestore (with password)';
                  console.log("✅ Password matches in Firestore!");
                } else {
                  console.log("❌ Password doesn't match in Firestore");
                }
              } 
              
              else if (firestoreUser.userPassword) {
                console.log("Trying userPassword field...");
                if (firestoreUser.userPassword === password) {
                  user = { id: doc.id, ...firestoreUser, password: firestoreUser.userPassword };
                  foundSource = 'Firestore (with userPassword)';
                  console.log("✅ Password matches in userPassword field!");
                }
              }
              
              else {
                console.log("⚠️ User exists in Firestore but has NO password field!");
                console.log("User fields:", Object.keys(firestoreUser));
                
                // EMERGENCY FIX: Check local storage for password
                const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
                const localUser = localUsers.find(u => u.email === email);
                
                if (localUser && localUser.password === password) {
                  // Found password in local storage
                  user = { id: doc.id, ...firestoreUser, password: localUser.password };
                  foundSource = 'Firestore + Local Storage (password fixed)';
                  console.log("✅ Found password in local storage!");
                  
                  // FIX: Add password to Firestore for future logins
                  try {
                    await updateDoc(doc.ref, {
                      password: localUser.password,
                      updatedAt: new Date().toISOString()
                    });
                    console.log("✅ Added missing password to Firestore!");
                  } catch (updateError) {
                    console.log("Could not update Firestore:", updateError);
                  }
                }
              }
            });
          } else {
            console.log("No user found in Firestore with that email");
          }
        } catch (firestoreError) {
          console.error("Firestore error:", firestoreError);
        }
      }
      
      // ===== CHECK LOCAL STORAGE (FALLBACK) =====
      if (!user) {
        console.log("Checking local storage as fallback...");
        const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        const localUser = localUsers.find(u => u.email === email && u.password === password);
        
        if (localUser) {
          user = localUser;
          foundSource = 'Local Storage';
          console.log("✅ Found in local storage");
          
          // Try to save this user to Firestore for cross-device
          if (window.db && !user.firestoreId) {
            try {
              const firestoreUser = { ...user };
              const usersRef = collection(db, "users");
              const docRef = await addDoc(usersRef, firestoreUser);
              user.firestoreId = docRef.id;
              console.log("✅ Saved local user to Firestore");
            } catch (saveError) {
              console.log("Could not save to Firestore:", saveError);
            }
          }
        }
      }
      
      // ===== LOGIN SUCCESS =====
      if (user) {
        console.log(`✅ LOGIN SUCCESS from: ${foundSource}`);
        
        // Ensure user has password
        if (!user.password) {
          user.password = password;
        }
        
        // Save to current session
        currentUser = user;
        localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(user));
        
        // Update local storage users list
        const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
        const existingIndex = localUsers.findIndex(u => u.email === user.email);
        
        if (existingIndex !== -1) {
          localUsers[existingIndex] = user;
        } else {
          localUsers.push(user);
        }
        
        localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
        
        // Update UI
        updateUIForUser();
        updateHomePage();
        updateCoursesDisplay();
        
        // Close form
        document.getElementById('loginForm').classList.remove('active');
        this.reset();
        
        // Show dashboard
        showDashboard();
        
        alert(`🎉 Welcome back, ${user.fullName}!`);
        
      } else {
        
        // First, check if email exists (for better error message)
        let emailExists = false;
        let emailSource = '';
        
        if (window.db) {
          try {
            const q = query(collection(db, "users"), where("email", "==", email));
            const snapshot = await getDocs(q);
            emailExists = !snapshot.empty;
            if (emailExists) emailSource = 'Firestore';
          } catch (error) {
            console.log("Could not check Firestore:", error);
          }
        }
        
        if (!emailExists) {
          const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
          emailExists = localUsers.some(u => u.email === email);
          if (emailExists) emailSource = 'Local Storage';
        }
        
        if (emailExists) {
          throw new Error(`❌ Wrong password for ${email}\n\nAccount exists in ${emailSource} but password is incorrect.\n\nIf you forgot your password, contact support.`);
        } else {
          throw new Error(`❌ No account found with email: ${email}\n\nPlease register first.`);
        }
      }
      
    } catch (error) {
      console.error('Login error:', error);
      alert(error.message);
    } finally {
      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
  
  // ===== ADD PASSWORD RECOVERY BUTTON =====
  setTimeout(() => {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      const formSwitch = loginForm.querySelector('.form-switch');
      if (formSwitch) {
        const recoveryDiv = document.createElement('div');
        recoveryDiv.style.marginTop = '10px';
        recoveryDiv.style.textAlign = 'center';
        recoveryDiv.innerHTML = `
          <button class="btn btn-warning" id="emergencyRecoveryBtn" style="padding: 8px 15px; font-size: 0.9rem;">
            <i class="fas fa-key"></i> Can't Login? Emergency Recovery
          </button>
        `;
        formSwitch.parentNode.insertBefore(recoveryDiv, formSwitch.nextSibling);
        
        document.getElementById('emergencyRecoveryBtn').addEventListener('click', function(e) {
          e.preventDefault();
          const email = prompt("Enter your email to check account status:");
          if (email) {
            emergencyAccountCheck(email);
          }
        });
      }
    }
  }, 1000);
});

// ===== EMERGENCY ACCOUNT CHECK FUNCTION =====
async function emergencyAccountCheck(email) {
  email = email.trim().toLowerCase();
  
  try {
    let message = `🔍 ACCOUNT CHECK for: ${email}\n\n`;
    
    //  Check Firestore
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        const user = doc.data();
        message += `✅ Found in Firestore:\n`;
        message += `- Name: ${user.fullName || 'Unknown'}\n`;
        message += `- Type: ${user.userType || 'Unknown'}\n`;
        message += `- Has Password Field: ${!!user.password ? 'YES' : 'NO'}\n`;
        message += `- Has userPassword Field: ${!!user.userPassword ? 'YES' : 'NO'}\n`;
        message += `- Created: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown'}\n\n`;
        
        if (!user.password) {
          message += `⚠️ ISSUE: No password stored in Firestore!\n`;
          message += `SOLUTION: Use the password you remember and login. It will be saved to Firestore automatically.\n\n`;
        }
      } else {
        message += `❌ NOT in Firestore\n\n`;
      }
    }
    
    // Check Local Storage
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    const localUser = localUsers.find(u => u.email === email);
    
    if (localUser) {
      message += `✅ Found in Local Storage:\n`;
      message += `- Has Password: ${!!localUser.password ? 'YES' : 'NO'}\n`;
      if (localUser.password) {
        message += `- Password: ${localUser.password}\n`;
      }
      message += `\n`;
    } else {
      message += `❌ NOT in Local Storage\n\n`;
    }
    
    // Recommendations
    message += `📝 RECOMMENDATIONS:\n`;
    message += `1. Try the password you remember\n`;
    message += `2. If it works, password will be saved to Firestore\n`;
    message += `3. If not, you may need to register again\n`;
    
    alert(message);
    
  } catch (error) {
    console.error("Emergency check error:", error);
    alert("Error checking account. Please check console.");
  }
}

// ===== FIX REGISTRATION TO ALWAYS SAVE PASSWORD TO FIRESTORE =====
document.getElementById('registerFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  console.log("Registration with guaranteed password save...");
  
  // Get values
  const fullName = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const userType = document.getElementById('userType').value;
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // Validation
  if (password !== confirmPassword) {
    alert("Passwords don't match!");
    return;
  }
  
  if (password.length < 6) {
    alert("Password must be at least 6 characters");
    return;
  }
  
  // Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
  submitBtn.disabled = true;
  
  try {
    // Check if exists
    let exists = false;
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      exists = !snapshot.empty;
    }
    
    if (exists) {
      throw new Error("Email already registered. Please login instead.");
    }
    
    // Create user WITH PASSWORD
    const newUser = {
      fullName,
      email,
      userType,
      password: password, // CRITICAL: Store password
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      status: 'active'
    };
    
    // Add extra fields
    if (userType === 'student') {
      newUser.yearLevel = document.getElementById('yearLevel').value || 'mixed';
      newUser.enrolledCourses = [];
      newUser.pendingPayment = 0;
      newUser.balance = 0;
    } else if (userType === 'teacher') {
      newUser.specialization = teacherSelectedModules.length > 0 ? [...teacherSelectedModules] : ['Not assigned'];
      newUser.balance = 0;
    }
    
    // SAVE TO FIRESTORE WITH PASSWORD
    let firestoreId = null;
    if (window.db) {
      const usersRef = collection(db, "users");
      const docRef = await addDoc(usersRef, newUser);
      firestoreId = docRef.id;
      newUser.id = docRef.id;
      newUser.firestoreId = docRef.id;
      console.log("✅ User saved to Firestore WITH PASSWORD");
    }
    
    // Save to local storage
    const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
    localUsers.push(newUser);
    localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
    
    // Login user
    currentUser = newUser;
    localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(currentUser));
    
    // Show success with credentials
    alert(`✅ Account created!\n\nSAVE THESE CREDENTIALS:\nEmail: ${email}\nPassword: ${password}\n\nYour account works on ALL devices!`);
    
    // Reset and redirect
    this.reset();
    document.getElementById('registerForm').classList.remove('active');
    
    updateUIForUser();
    updateHomePage();
    updateCoursesDisplay();
    showDashboard();
    
  } catch (error) {
    console.error("Registration error:", error);
    alert("❌ " + error.message);
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});
</script>
<script>
// ========== FIX TEACHER CREATION PASSWORD BUG ==========
console.log("🔥 FIXING TEACHER PASSWORD BUG");


document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    const teacherBtn = document.getElementById('confirmCreateTeacherBtn');
    if (teacherBtn) {
      console.log("Found teacher creation button, fixing password save...");
      
      // Store original click handler
      const originalOnClick = teacherBtn.onclick;
      
      
      teacherBtn.onclick = async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const fullName = document.getElementById('teacherFullName').value.trim();
        const email = document.getElementById('teacherEmail').value.trim().toLowerCase();
        const password = document.getElementById('teacherPassword').value;
        
        console.log(`Creating teacher: ${email}, Password: ${password}`);
        
        if (!fullName || !email || !password) {
          alert("Please fill all teacher fields");
          return;
        }
        
        if (password.length < 6) {
          alert("Password must be at least 6 characters");
          return;
        }
        
        // Show loading
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Teacher...';
        this.disabled = true;
        
        try {
          // CHECK IF TEACHER EXISTS
          let teacherExists = false;
          if (window.db) {
            const q = query(collection(db, "users"), where("email", "==", email));
            const snapshot = await getDocs(q);
            teacherExists = !snapshot.empty;
          }
          
          if (teacherExists) {
            throw new Error("Teacher email already exists!");
          }
          
          // CREATE FIREBASE AUTH ACCOUNT (THIS IS CRITICAL!)
          let firebaseUID = null;
          if (window.auth && window.createUserWithEmailAndPassword) {
            try {
              console.log("Creating Firebase Auth account for teacher...");
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              firebaseUID = userCredential.user.uid;
              console.log("✅ Firebase Auth created:", firebaseUID);
            } catch (authError) {
              console.error("Firebase Auth error:", authError);
              if (authError.code === 'auth/email-already-in-use') {
                throw new Error("This email already has an account. Use different email.");
              }
              throw authError;
            }
          }
          
          // CREATE TEACHER OBJECT WITH PASSWORD
          const teacherId = 'teacher_' + Date.now();
          const newTeacher = {
            id: teacherId,
            firebaseUID: firebaseUID,
            fullName: fullName,
            email: email,
            userType: 'teacher',
            password: password, // CRITICAL: SAVE THE PASSWORD!
            specialization: [...adminTeacherSelectedModules],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            balance: 0,
            status: 'active',
            authProvider: 'email/password'
          };
          
          // SAVE TO FIRESTORE WITH PASSWORD
          if (window.db && window.collection && window.addDoc) {
            console.log("Saving teacher to Firestore WITH PASSWORD...");
            const usersRef = collection(db, "users");
            const docRef = await addDoc(usersRef, newTeacher);
            newTeacher.firestoreId = docRef.id;
            console.log("✅ Teacher saved to Firestore with ID:", docRef.id);
          }
          
          // SAVE TO LOCAL STORAGE
          const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
          localUsers.push(newTeacher);
          localStorage.setItem('ThriveAcademy_users', JSON.stringify(localUsers));
          
          // SHOW SUCCESS WITH PASSWORD
          alert(`✅ TEACHER ACCOUNT CREATED!\n\nTEACHER LOGIN:\nEmail: ${email}\nPassword: ${password}\n\nIMPORTANT: Give these credentials to the teacher!`);
          
          // RESET FORM
          document.getElementById('teacherFullName').value = '';
          document.getElementById('teacherEmail').value = '';
          document.getElementById('teacherPassword').value = '';
          adminTeacherSelectedModules = [];
          document.getElementById('teacherCreationForm').classList.add('hidden');
          
          // Clear selections
          document.querySelectorAll('#adminTeacherModules .teacher-module-option.selected').forEach(el => {
            el.classList.remove('selected');
            el.querySelector('div > div:last-child').innerHTML = 'Click to select';
            el.querySelector('div > div:last-child').style.color = '#6b7280';
          });
          
          console.log("Teacher creation complete!");
          
        } catch (error) {
          console.error("Teacher creation error:", error);
          alert("❌ Error creating teacher: " + error.message);
        } finally {
          // Reset button
          this.innerHTML = originalText;
          this.disabled = false;
        }
      };
      
      console.log("✅ Teacher creation button fixed!");
    }
  }, 2000);
});

// ========== QUICK FIX FOR EXISTING TEACHERS ==========
function fixExistingTeachers() {
  console.log("Checking existing teachers...");
  
  // Find all teachers in local storage
  const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
  const teachers = localUsers.filter(u => u.userType === 'teacher');
  
  console.log(`Found ${teachers.length} teachers in local storage`);
  
  teachers.forEach(teacher => {
    console.log(`Teacher: ${teacher.email}, Has Password: ${!!teacher.password}`);
    
    if (!teacher.password) {
      console.log(`⚠️ Teacher ${teacher.email} has NO password!`);
      
    }
  });
}

// Run fix check
setTimeout(fixExistingTeachers, 3000);


document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
  // ========== SIMPLE LOGIN THAT WORKS ==========
document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  
  if (currentUser) {
    // User is already logged in, just close the form
    document.getElementById('loginForm').classList.remove('active');
    return;
  }
  
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  console.log(`🔑 Login attempt: ${email}`);
  
  if (!email || !password) {
    alert("Enter email and password");
    return;
  }
  
  
});
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  console.log(`🔑 Login attempt: ${email}`);
  
  if (!email || !password) {
    alert("Enter email and password");
    return;
  }
  
  // Show loading
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
  submitBtn.disabled = true;
  
  try {
    //  Check ALL possible password fields in Firestore
    let user = null;
    
    if (window.db) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        const firestoreUser = doc.data();
        console.log("Found in Firestore:", firestoreUser);
        
        // Check ALL possible password field names
        const possiblePasswordFields = ['password', 'userPassword', 'pass', 'pwd'];
        let foundPassword = false;
        
        for (const field of possiblePasswordFields) {
          if (firestoreUser[field] === password) {
            user = { id: doc.id, ...firestoreUser, password: firestoreUser[field] };
            console.log(`✅ Password matches in field: ${field}`);
            foundPassword = true;
            break;
          }
        }
        
        if (!foundPassword) {
          console.log("❌ No password match in Firestore");
        }
      }
    }
    
    //  Fallback to local storage
    if (!user) {
      const localUsers = JSON.parse(localStorage.getItem('ThriveAcademy_users')) || [];
      user = localUsers.find(u => u.email === email && u.password === password);
      if (user) console.log("✅ Found in local storage");
    }
    
    //  LOGIN SUCCESS
    if (user) {
      currentUser = user;
      localStorage.setItem('ThriveAcademy_currentUser', JSON.stringify(user));
      
      // Update UI
      updateUIForUser();
      updateHomePage();
      updateCoursesDisplay();
      
      document.getElementById('loginForm').classList.remove('active');
      this.reset();
      showDashboard();
      
      alert(`✅ Login successful! Welcome ${user.fullName}`);
    } else {
      throw new Error("Wrong email or password");
    }
    
  } catch (error) {
    console.error("Login error:", error);
    alert("❌ " + error.message);
  } finally {
    submitBtn.innerHTML = "Login";
    submitBtn.disabled = false;
  }
});
// ========== EMERGENCY NAVIGATION FIX ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log("EMERGENCY NAV FIX LOADED");
    
    // FIX 1: Direct event listeners for navigation
    document.getElementById('homeLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
        hideAllForms();
    });
    
    document.getElementById('coursesLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
        hideAllForms();
        // Make sure courses load
        setTimeout(() => {
            const activeYearBtn = document.querySelector('.year-btn.active');
            if (activeYearBtn) {
                loadCourses(parseInt(activeYearBtn.dataset.year));
            } else {
                loadCourses(1);
            }
        }, 100);
    });
    
    document.getElementById('dashboardLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentUser) {
            showDashboard();
        } else {
            showForm(document.getElementById('loginForm'));
        }
    });
    
    document.getElementById('adminLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentUser && currentUser.userType === 'admin') {
            showAdminPanel();
        } else {
            alert("Admin access only");
        }
    });
    
    document.getElementById('loginLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        showForm(document.getElementById('loginForm'));
    });
    
    document.getElementById('registerLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        showForm(document.getElementById('registerForm'));
    });
    
    document.getElementById('logoutLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        currentUser = null;
        localStorage.removeItem('ThriveAcademy_currentUser');
        updateUIForUser();
        updateHomePage();
        updateCoursesDisplay();
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('adminPanel').classList.remove('active');
        document.getElementById('home').scrollIntoView({ behavior: 'smooth' });
        alert("Logged out!");
    });
    
    // FIX 2: CTA buttons
    document.getElementById('ctaRegister')?.addEventListener('click', function(e) {
        e.preventDefault();
        showForm(document.getElementById('registerForm'));
    });
    
    document.getElementById('homeRegisterBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        showForm(document.getElementById('registerForm'));
    });
    
    document.getElementById('homeLearnMoreBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
    });
    
    // FIX 3: Form switches
    document.getElementById('switchToRegister')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('registerForm').classList.add('active');
    });
    
    document.getElementById('switchToLogin')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('registerForm').classList.remove('active');
        document.getElementById('loginForm').classList.add('active');
    });
    
    // FIX 4: Mobile menu
    document.getElementById('hamburger')?.addEventListener('click', function(e) {
        e.stopPropagation();
        const navLinks = document.getElementById('navLinks');
        const icon = this.querySelector('i');
        
        navLinks.classList.toggle('active');
        
        if (navLinks.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
        } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }
    });
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', function(e) {
        const navLinks = document.getElementById('navLinks');
        const hamburger = document.getElementById('hamburger');
        
        if (navLinks && hamburger && !navLinks.contains(e.target) && !hamburger.contains(e.target)) {
            navLinks.classList.remove('active');
            const icon = hamburger.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }
    });
    
    console.log("NAV FIX COMPLETE - All navigation should work now");
});

// Helper function to hide all forms
function hideAllForms() {
    document.getElementById('loginForm').classList.remove('active');
    document.getElementById('registerForm').classList.remove('active');
    document.getElementById('addMaterialModal').classList.remove('active');
    document.getElementById('addMaterialModal').classList.add('hidden');
    
    // Also close access code modal if open
    const accessModal = document.getElementById('accessCodeModal');
    const accessOverlay = document.getElementById('accessCodeModalOverlay');
    if (accessModal) accessModal.remove();
    if (accessOverlay) accessOverlay.remove();
}
// ========== FIX COURSE CARD CLICK AFTER ACCESS CODE LOGIN ==========
function fixCourseCardClicks() {
    console.log("Fixing course card clicks...");
    
    // Remove all existing click handlers on course cards
    document.querySelectorAll('.course-card').forEach(card => {
        // Store the original onclick if any
        const originalOnClick = card.onclick;
        
        // Remove existing onclick
        card.onclick = null;
        
        // Add proper click handler
        card.addEventListener('click', function(e) {
            // Don't do anything if clicking on buttons
            if (e.target.closest('button')) {
                return;
            }
            
            // Get course code from the card
            const courseHeader = this.querySelector('.course-header h3');
            if (!courseHeader) return;
            
            // Extract course code (remove dev tag and year badge)
            let courseCode = courseHeader.textContent.trim();
            courseCode = courseCode.replace('<span class="dev-tag">DEV</span>', '')
                                 .replace(/<span class="year-badge">.*<\/span>/, '')
                                 .trim();
            
            console.log("Course card clicked:", courseCode);
            
            // Check if user is logged in
            if (!currentUser) {
                showAccessCodeLoginModal(courseCode);
                return;
            }
            
            // Check if student is enrolled in this course
            if (currentUser.userType === 'student' || 
                (currentUser.userType === 'admin' && adminMode === 'student')) {
                
                const isEnrolled = currentUser.enrolledCourses && 
                                  currentUser.enrolledCourses.includes(courseCode);
                
                if (!isEnrolled) {
                    showAccessCodeLoginModal(courseCode);
                } else {
                    // Enrolled - open materials
                    openCourseMaterials(courseCode);
                }
            } else if (currentUser.userType === 'teacher' || 
                      (currentUser.userType === 'admin' && adminMode === 'teacher') ||
                      (currentUser.userType === 'admin' && adminMode === 'admin')) {
                // Teacher or admin - open materials directly
                openCourseMaterials(courseCode);
            }
        }, true); // Use capture phase to ensure it runs first
    });
}

// Run this whenever courses are loaded
const originalLoadCourses = loadCourses;
loadCourses = function(year) {
    originalLoadCourses(year);
    setTimeout(fixCourseCardClicks, 100); // Fix clicks after courses load
};

// Also fix when dashboard loads
const originalShowDashboard = showDashboard;
showDashboard = function() {
    originalShowDashboard();
    setTimeout(fixCourseCardClicks, 100);
};

// Also fix when student courses load
const originalLoadStudentCourses = loadStudentCourses;
loadStudentCourses = function() {
    originalLoadStudentCourses();
    setTimeout(fixCourseCardClicks, 100);
};

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(fixCourseCardClicks, 500);
});

// Also fix when user logs in via access code
const originalCheckAccessCode = checkAccessCode;
checkAccessCode = async function(accessCode, courseCode, submitBtn, originalText, errorDiv) {
    const result = await originalCheckAccessCode(accessCode, courseCode, submitBtn, originalText, errorDiv);
    if (result) {
        // After successful access code login, fix course cards
        setTimeout(fixCourseCardClicks, 300);
    }
    return result;
};
// EMERGENCY FIX FOR MATERIALS BUTTON
document.addEventListener('DOMContentLoaded', function() {
    // Fix any existing buttons on page load
    setTimeout(() => {
        document.querySelectorAll('#studentCoursesContainer .btn').forEach(btn => {
            if (btn.textContent.includes('View Materials')) {
                const card = btn.closest('.course-card');
                if (card) {
                    const header = card.querySelector('.course-header h3');
                    if (header) {
                        let courseCode = header.textContent;
                        courseCode = courseCode.replace('Year', '').replace(/\d/, '').trim();
                        
                        btn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            alert("Opening: " + courseCode);
                            if (typeof openCourseMaterials === 'function') {
                                openCourseMaterials(courseCode);
                            }
                        };
                    }
                }
            }
        });
    }, 1000);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const SUPABASE_URL = "https://rtbzlmgarrkpgyglwqah.supabase.co";
    const SUPABASE_KEY = "sb_publishable_b75T1n2x15i7MD1dizb7bA_VVhhcqz6";

    window.supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    console.log("✅ Supabase initialized safely");
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase
const supabaseUrl = 'YOUR_SUPABASE_URL';
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
const supabase = window.supabase = supabase.createClient(supabaseUrl, supabaseKey);

console.log("Supabase initialized:", !!window.supabase);
</script>
<script>
window.uploadMaterial = async function () {
  console.log("=== SUPABASE UPLOAD START ===");
  
  try {
    // 0️⃣ Check if Supabase is ready
    if (!window.supabase) {
      alert("❌ Database not connected. Please refresh the page.");
      console.error("Supabase not found in window");
      return;
    }

    console.log("Supabase available:", !!window.supabase);

    // 1️⃣ Get form elements
    const titleEl = document.getElementById("materialTitle");
    const typeEl = document.getElementById("materialType");
    const descEl = document.getElementById("materialDescription");
    const courseEl = document.getElementById("materialCourseCode");
    const fileEl = document.getElementById("materialFile");

    if (!titleEl || !typeEl || !fileEl) {
      alert("Material form elements missing");
      return;
    }

    const title = titleEl.value.trim();
    const type = typeEl.value;
    const description = descEl?.value.trim() || "";
    const courseCode = courseEl?.value || "GENERAL";

    if (!title || !type) {
      alert("Please enter title and select material type");
      return;
    }

    if (fileEl.files.length === 0) {
      alert("Please select a file to upload");
      return;
    }

    const file = fileEl.files[0];
    
    // Validate file size (max 50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
      alert("❌ File too large. Maximum size is 50MB");
      return;
    }

    // Create unique file path
    const fileName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
    const filePath = `${courseCode}/${Date.now()}_${fileName}`;
    console.log("Upload path:", filePath);

    // 2️⃣ Upload file to Supabase Storage
    console.log("Uploading to Supabase Storage...");
    
    const { data: uploadData, error: uploadError } = await window.supabase
      .storage
      .from("materials")
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

    if (uploadError) {
      console.error("Upload error:", uploadError);
      alert(`❌ Upload failed: ${uploadError.message}`);
      return;
    }

    console.log("✅ File uploaded successfully:", uploadData);

    // 3️⃣ Get public URL
    const { data: { publicUrl } } = window.supabase
      .storage
      .from("materials")
      .getPublicUrl(filePath);

    console.log("Public URL:", publicUrl);

    // 4️⃣ Save metadata to database
    console.log("Saving to database...");
    
    const materialData = {
      course_code: courseCode,
      title: title,
      type: type,
      description: description,
      file_url: publicUrl,
      file_name: file.name,
      file_size: file.size,
      file_type: file.type,
      uploaded_by: window.currentUser?.email || window.currentUser?.fullName || "teacher",
      uploaded_at: new Date().toISOString()
    };

    console.log("Material data to save:", materialData);

    const { data: dbData, error: dbError } = await window.supabase
      .from("materials")
      .insert([materialData])
      .select();

    if (dbError) {
      console.error("Database error:", dbError);
      alert(`❌ Failed to save material: ${dbError.message}`);
      
      // Try to delete the uploaded file since DB failed
      try {
        await window.supabase.storage.from("materials").remove([filePath]);
      } catch (deleteError) {
        console.error("Failed to cleanup file:", deleteError);
      }
      
      return;
    }

    console.log("✅ Material saved to database:", dbData);

    // 5️⃣ IMMEDIATELY UPDATE THE COURSE CARD
    updateCourseCardNow(courseCode, {
      id: dbData[0].id,
      title: title,
      file_url: publicUrl,
      file_name: file.name,
      type: type,
      file_size: file.size
    });

    // 6️⃣ Close modal and reset
    const modal = document.getElementById('addMaterialModal');
    if (modal) {
      modal.classList.remove('active');
      modal.classList.add('hidden');
    }
    
    const form = document.getElementById('addMaterialForm');
    if (form) form.reset();
    
    // 7️⃣ Show success message
    showMaterialSuccess(title, courseCode);
    
    console.log("=== SUPABASE UPLOAD COMPLETE ===");

  } catch (err) {
    console.error("🔥 UPLOAD CRASHED:", err);
    alert(`❌ Upload failed: ${err.message}`);
  }
};

// ====== SUPPORT FUNCTIONS (ADD THESE TOO) ======

// FUNCTION 1: IMMEDIATE COURSE CARD UPDATE
function updateCourseCardNow(courseCode, material) {
  console.log("🔵 Updating course card for:", courseCode);
  
  // Method 1: Look for course cards with this course code
  const courseCards = document.querySelectorAll('[class*="course"], [class*="card"], .course-item, .course-card');
  
  for (let card of courseCards) {
    const cardText = card.textContent || card.innerText || '';
    const cardHTML = card.innerHTML || '';
    
    // If card mentions this course code
    if (cardText.includes(courseCode) || cardHTML.includes(courseCode)) {
      console.log("✅ Found matching course card");
      
      // Add material directly
      addMaterialToCard(card, material);
      return;
    }
  }
  
  // Method 2: If not found, try to find course container
  console.log("⚠️ Course card not found, trying alternative...");
  const courseContainers = document.querySelectorAll('#courses, .courses, [id*="course"]');
  
  for (let container of courseContainers) {
    // Add to the first container found
    addMaterialToCard(container, material);
    break;
  }
}

// FUNCTION 2: ADD MATERIAL TO SPECIFIC CARD
function addMaterialToCard(cardElement, material) {
  // Create material item
  const materialDiv = document.createElement('div');
  materialDiv.className = 'material-item-added';
  materialDiv.style.cssText = `
    margin: 8px 0;
    padding: 10px;
    background: #e8f4ff;
    border-radius: 6px;
    border-left: 4px solid #007bff;
    animation: fadeIn 0.5s ease;
  `;
  
  materialDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <strong style="font-size: 14px;">${material.title}</strong>
        <div style="font-size: 12px; color: #666;">
          ${material.type} • ${formatSize(material.file_size)}
        </div>
      </div>
      <a href="${material.file_url}" 
         target="_blank"
         download="${material.file_name}"
         style="
           padding: 6px 12px;
           background: #007bff;
           color: white;
           text-decoration: none;
           border-radius: 4px;
           font-size: 12px;
           font-weight: bold;
         ">
        📥 Download
      </a>
    </div>
  `;
  
  // Add to card (at the end or after title)
  cardElement.appendChild(materialDiv);
  
  // Add CSS animation if not exists
  addAnimationStyle();
}

// FUNCTION 3: SHOW SUCCESS MESSAGE
function showMaterialSuccess(title, courseCode) {
  // Create success message
  const successDiv = document.createElement('div');
  successDiv.id = 'material-success-msg';
  successDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 99999;
    animation: slideInRight 0.3s ease;
    max-width: 400px;
  `;
  
  successDiv.innerHTML = `
    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">✅ Success!</div>
    <div style="font-size: 14px;">
      "${title}" added to ${courseCode}<br>
      <small>Available for download immediately</small>
    </div>
  `;
  
  // Remove existing message
  const oldMsg = document.getElementById('material-success-msg');
  if (oldMsg) oldMsg.remove();
  
  // Add to page
  document.body.appendChild(successDiv);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    if (successDiv.parentNode) {
      successDiv.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => successDiv.remove(), 300);
    }
  }, 4000);
}

// FUNCTION 4: FORMAT FILE SIZE
function formatSize(bytes) {
  if (!bytes) return '';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

// FUNCTION 5: ADD ANIMATION STYLES
function addAnimationStyle() {
  if (document.getElementById('material-animations')) return;
  
  const style = document.createElement('style');
  style.id = 'material-animations';
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .material-item-added {
      animation: fadeIn 0.5s ease !important;
    }
  `;
  
  document.head.appendChild(style);
}

// FUNCTION 6: MANUAL REFRESH BUTTON (for testing)
function addRefreshButton() {
  if (document.getElementById('manual-refresh-btn')) return;
  
  const btn = document.createElement('button');
  btn.id = 'manual-refresh-btn';
  btn.textContent = '🔄 Refresh Course';
  btn.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 20px;
    padding: 10px 15px;
    background: #ff6b00;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 9999;
    font-size: 14px;
  `;
  btn.onclick = () => {
    const courseCode = prompt("Enter course code to refresh:");
    if (courseCode) {
      updateCourseCardNow(courseCode, {});
      alert(`Refreshing ${courseCode}...`);
    }
  };
  
  document.body.appendChild(btn);
}

// Add refresh button on load
setTimeout(addRefreshButton, 1000);
</script>
 
</body>
</html>